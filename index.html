<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>画像アップローダー (フォルダ名変更機能付き)</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 1em 2em; }
        hr { margin: 2em 0; }
        input[type="text"], input[type="search"] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        #upload-section { background: #f9f9f9; padding: 15px; border-radius: 8px; display: flex; gap: 20px; }
        #upload-section > div { flex: 1; }
        #uploadStatus { font-weight: bold; }
        #csvDownloader { display: inline-block; padding: 8px 12px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; }
        #gallery-section { display: flex; gap: 20px; }
        #category-container, #folder-container { width: 200px; border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; }
        #search-section { margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px; }
        #searchInput { width: 300px; padding: 8px; }
        #image-gallery-container { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 10px; padding-top: 10px; }
        .category, .folder-item span { cursor: pointer; }
        .category, .folder-item { padding: 8px; border: 1px solid #ccc; border-radius: 5px; background-color: #f4f4f4; font-weight: bold; margin-bottom: 5px; }
        .category.active, .folder-item.active { background-color: #007bff; color: white; border-color: #007bff; }
        .folder-item { display: flex; justify-content: space-between; align-items: center; }
        .folder-item span { flex-grow: 1; }
        .action-buttons { display: flex; gap: 3px; flex-shrink: 0; margin-left: 5px; }
        .edit-btn, .delete-btn { border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-weight: bold; line-height: 20px; text-align: center; color: white; }
        .edit-btn { background: #ffc107; } .edit-btn:hover { background: #e0a800; }
        .delete-btn { background: #dc3545; } .delete-btn:hover { background: #c82333; }
        .gallery-image { width: 100%; height: 130px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

    {/* (HTML構造は変更なし) */}
    <div id="upload-section">
        <div><h2>画像をアップロード</h2><p><label for="categoryNameInput"><b>1. 保存先カテゴリ名:</b></label><br><input type="text" id="categoryNameInput" value="default_category" placeholder="カテゴリ名"></p><p><label for="folderNameInput"><b>2. 保存先フォルダ名:</b></label><br><input type="text" id="folderNameInput" value="default_folder" placeholder="フォルダ名"></p></div>
        <div><p><b>3. ファイルを選択</b></p><input type="file" id="imageInput" accept="image/*" multiple><button id="uploadButton">アップロード</button><p id="uploadStatus"></p></div>
    </div><hr>
    <h3>履歴のダウンロード</h3><p>現在選択中の**フォルダ**のCSVをダウンロードします。</p><a href="#" id="csvDownloader" style="visibility: hidden;">CSVダウンロード</a><p id="csv-status-text">(フォルダを選択するとボタンが有効になります)</p><hr>
    <h3>カテゴリ・フォルダ別 ギャラリー</h3><p>カテゴリ → フォルダ → (検索) の順で画像を表示。(Eで編集、Xで削除)</p>
    <div id="gallery-section">
        <div id="category-container"><h4>カテゴリ</h4><p id="category-loading-status">読み込み中...</p></div>
        <div id="folder-container"><h4>フォルダ</h4><p id="folder-loading-status"></p></div>
    </div>
    <div id="search-section" style="display: none;"><label for="searchInput"><b>画像ファイル名検索:</b></label><input type="search" id="searchInput" placeholder="ファイル名の一部を入力..."></div>
    <div id="image-gallery-container"></div>

    <script>
        // --- HTML要素を取得 ---
        const fileInput = document.getElementById('imageInput');
        const categoryNameInput = document.getElementById('categoryNameInput');
        const folderNameInput = document.getElementById('folderNameInput');
        const uploadButton = document.getElementById('uploadButton');
        const statusP = document.getElementById('uploadStatus');
        const categoryContainer = document.getElementById('category-container');
        const folderContainer = document.getElementById('folder-container');
        const galleryContainer = document.getElementById('image-gallery-container');
        const categoryStatus = document.getElementById('category-loading-status');
        const folderStatus = document.getElementById('folder-loading-status');
        const csvButton = document.getElementById('csvDownloader');
        const csvStatus = document.getElementById('csv-status-text');
        const searchSection = document.getElementById('search-section');
        const searchInput = document.getElementById('searchInput');
        let currentSelectedFolder = null;
        let currentSelectedCategory = null;

        // --- アップロード機能 ---
        uploadButton.addEventListener('click', async () => {
            const files = fileInput.files;
            const categoryName = categoryNameInput.value.trim();
            const folderName = folderNameInput.value.trim();
            if (files.length === 0) { alert('画像が選択されていません。'); return; }
            if (categoryName === '') { alert('カテゴリ名を入力してください。'); return; }
            if (folderName === '') { alert('フォルダ名を入力してください。'); return; }
            const formData = new FormData();
            formData.append('categoryName', categoryName);
            formData.append('folderName', folderName);
            for (let i = 0; i < files.length; i++) { formData.append('imageFiles', files[i]); }
            statusP.style.color = 'blue';
            statusP.innerText = `「${categoryName} / ${folderName}」にアップロード中...`;
            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const data = await response.json();
                if (response.ok) {
                    statusP.style.color = 'green'; statusP.innerText = data.message;
                    fileInput.value = '';
                    loadCategories();
                } else {
                    statusP.style.color = 'red'; statusP.innerText = 'アップロード失敗: ' + data.message;
                }
            } catch (error) {
                statusP.style.color = 'red'; statusP.innerText = '通信エラーが発生しました。';
            }
         });

        // --- ギャラリー機能 ---
        document.addEventListener('DOMContentLoaded', () => { loadCategories(); });

        // (B) カテゴリ読み込み
        async function loadCategories() {
             try {
                const response = await fetch('/api/categories');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); // エラーチェック追加
                const categories = await response.json();
                categoryContainer.innerHTML = '<h4>カテゴリ</h4>';
                if (categories.length === 0) { categoryContainer.appendChild(categoryStatus); categoryStatus.innerText = 'データがありません。'; return; }
                categories.forEach(categoryName => {
                    const category = document.createElement('div');
                    category.className = 'category'; category.innerText = categoryName;
                    category.addEventListener('click', () => {
                        currentSelectedCategory = categoryName;
                        loadFolders(categoryName);
                        document.querySelectorAll('.category').forEach(c => c.classList.remove('active'));
                        category.classList.add('active');
                        categoryNameInput.value = categoryName;
                        folderContainer.innerHTML = '<h4>フォルダ</h4><p>読み込み中...</p>';
                        galleryContainer.innerHTML = '';
                        csvButton.style.visibility = 'hidden'; csvStatus.innerText = '(フォルダを選択するとボタンが有効になります)';
                        searchSection.style.display = 'none';
                    });
                    categoryContainer.appendChild(category);
                });
             } catch (error) {
                console.error('カテゴリ読み込みエラー:', error);
                categoryContainer.innerHTML = '<h4>カテゴリ</h4><p style="color: red;">読み込み失敗</p>'; // エラー表示を修正
             }
        }

        // (C) フォルダ読み込み
        async function loadFolders(categoryName) {
            try {
                const encodedCategoryName = encodeURIComponent(categoryName);
                const response = await fetch(`/api/folders_by_category/${encodedCategoryName}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); // エラーチェック追加
                const folders = await response.json();
                folderContainer.innerHTML = '<h4>フォルダ</h4>';
                if (folders.length === 0) { folderContainer.appendChild(folderStatus); folderStatus.innerText = 'データがありません。'; return; }
                folders.forEach(folderName => {
                    const folderItem = document.createElement('div'); folderItem.className = 'folder-item';
                    const folderNameSpan = document.createElement('span'); folderNameSpan.innerText = folderName;
                    folderNameSpan.addEventListener('click', () => {
                        loadImages(folderName);
                        document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
                        folderItem.classList.add('active');
                        folderNameInput.value = folderName;
                    });
                    const actionButtons = document.createElement('div'); actionButtons.className = 'action-buttons';
                    const editBtn = document.createElement('button'); editBtn.className = 'edit-btn'; editBtn.innerText = 'E'; editBtn.title = 'フォルダ名を変更';
                    editBtn.addEventListener('click', (e) => { e.stopPropagation(); renameFolder(folderName); });
                    const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-btn'; deleteBtn.innerText = 'X'; deleteBtn.title = 'フォルダを削除';
                    deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteFolder(folderName); });
                    actionButtons.appendChild(editBtn); actionButtons.appendChild(deleteBtn);
                    folderItem.appendChild(folderNameSpan); folderItem.appendChild(actionButtons);
                    folderContainer.appendChild(folderItem);
                });
            } catch (error) {
                console.error('フォルダ読み込みエラー:', error);
                folderContainer.innerHTML = '<h4>フォルダ</h4><p style="color: red;">読み込み失敗</p>'; // エラー表示を修正
            }
         }

        // (D) 画像読み込みのトリガー
        async function loadImages(folderName) {
            currentSelectedFolder = folderName;
            searchInput.value = '';
            searchSection.style.display = 'block';
            await displayImages(folderName, '');
        }

        // (NEW) 検索入力イベントリスナー
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                if (currentSelectedFolder) {
                    const searchTerm = searchInput.value.trim();
                    await displayImages(currentSelectedFolder, searchTerm);
                }
            }, 300);
        });

        // (NEW) 画像取得・表示関数
        async function displayImages(folderName, searchTerm) {
            try {
                galleryContainer.innerHTML = '<p>画像を読み込み中...</p>';
                const encodedFolderName = encodeURIComponent(folderName);
                let apiUrl;
                if (searchTerm) {
                    const encodedSearchTerm = encodeURIComponent(searchTerm);
                    apiUrl = `/api/search?folder=${encodedFolderName}&q=${encodedSearchTerm}`;
                } else {
                    apiUrl = `/api/images_by_folder/${encodedFolderName}`;
                }
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); // エラーチェック追加
                const images = await response.json();
                galleryContainer.innerHTML = '';
                if (images.length === 0) {
                    galleryContainer.innerHTML = searchTerm ? '<p>検索結果がありません。</p>' : '<p>このフォルダに画像はありません。</p>';
                } else {
                    images.forEach(image => {
                        const img = document.createElement('img');
                        img.className = 'gallery-image';
                        img.src = image.url; img.alt = image.title; img.title = image.title;
                        galleryContainer.appendChild(img);
                    });
                }
                // ★ CSVボタンを確実に表示させる
                csvButton.href = `/download-csv?folder=${encodedFolderName}`;
                csvButton.style.visibility = 'visible';
                csvStatus.innerText = `「${folderName}」フォルダのCSVをダウンロードします。`;
            } catch (error) {
                console.error('画像ギャラリーの読み込み/検索エラー:', error);
                galleryContainer.innerHTML = '<p style="color: red;">画像の読み込みに失敗しました。</p>';
                // ★ エラー時もCSVボタンの状態をリセット
                csvButton.style.visibility = 'hidden';
                csvStatus.innerText = '(フォルダを選択するとボタンが有効になります)';
            }
        }

        // (E) フォルダ削除関数
        async function deleteFolder(folderName) {
            const confirmation = confirm(/* ... 確認メッセージ ... */); // 省略
            if (!confirmation) { return; }
            try {
                statusP.style.color = 'blue'; statusP.innerText = `「${folderName}」を削除中です...`;
                const encodedFolderName = encodeURIComponent(folderName);
                const response = await fetch(`/api/folder/${encodedFolderName}`, { method: 'DELETE' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); // エラーチェック追加
                const data = await response.json();
                statusP.style.color = 'green'; statusP.innerText = data.message;
                loadCategories(); // カテゴリから再読み込み
                folderContainer.innerHTML = '<h4>フォルダ</h4>'; galleryContainer.innerHTML = '';
                csvButton.style.visibility = 'hidden'; csvStatus.innerText = '(フォルダを選択するとボタンが有効になります)';
                searchSection.style.display = 'none';
            } catch (error) {
                console.error('削除リクエストエラー:', error);
                statusP.style.color = 'red'; statusP.innerText = '削除失敗。通信エラーまたはサーバーエラー。'; // エラーメッセージを汎用的に
            }
         }

        // (F) フォルダ名変更関数
        async function renameFolder(oldFolderName) {
            const newFolderName = prompt(/* ... 新しい名前入力 ... */ oldFolderName); // 省略
            if (!newFolderName || newFolderName.trim() === '' || newFolderName === oldFolderName) { return; }
            try {
                statusP.style.color = 'blue'; statusP.innerText = `フォルダ名を変更中です...`;
                const encodedOldFolderName = encodeURIComponent(oldFolderName);
                const response = await fetch(`/api/folder/${encodedOldFolderName}`, {
                    method: 'PUT', headers: {'Content-Type': 'application/json',},
                    body: JSON.stringify({ newFolderName: newFolderName.trim() })
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); // エラーチェック追加
                const data = await response.json();
                statusP.style.color = 'green'; statusP.innerText = data.message;
                if (currentSelectedCategory) { loadFolders(currentSelectedCategory); }
                galleryContainer.innerHTML = ''; csvButton.style.visibility = 'hidden';
                csvStatus.innerText = '(フォルダを選択するとボタンが有効になります)'; searchSection.style.display = 'none';
            } catch (error) {
                console.error('名前変更リクエストエラー:', error);
                statusP.style.color = 'red'; statusP.innerText = '名前変更失敗。通信エラーまたはサーバーエラー。'; // エラーメッセージを汎用的に
            }
        }
    </script>

</body>
</html>