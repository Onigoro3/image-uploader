<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 10px; margin: 0; background-color: #fff; }
        
        #auth-status { position: fixed; top: 0; left: 0; width: 100%; background: #f8f9fa; padding: 10px; border-bottom: 1px solid #ccc; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 1000; display: flex; justify-content: flex-end; align-items: center; box-sizing: border-box; }
        #username-display { margin-right: 10px; font-weight: bold; font-size: 0.9em; }
        #auth-status button { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        #personal-btn { background: #17a2b8 !important; }
        #fix-db-btn { background: #ffc107 !important; color: #000 !important; }
        
        #main-content { margin-top: 60px; }
        hr { margin: 2em 0; border: 0; border-top: 1px solid #eee; }
        
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 5px; }
        button { padding: 8px 15px; cursor: pointer; border-radius: 4px; font-size: 14px; }

        #upload-section { background: #f9f9f9; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        #upload-section label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em; }
        #uploadStatus { font-weight: bold; grid-column: span 3; margin-top: 10px; word-break: break-all; }
        
        #dropZone { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-top: 10px; background: #fff; border-radius: 4px; cursor: pointer; }
        #gallery-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .gallery-column { border: 1px solid #eee; padding: 5px; border-radius: 8px; background: #fafafa; height: 200px; overflow-y: auto; }
        
        #csv-manage-section { background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #c8e6c9; }
        #csv-file-list { margin-top: 10px; max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #ddd; padding: 5px; border-radius: 4px; }
        .csv-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .csv-item:last-child { border-bottom: none; }
        .csv-name { font-weight: bold; flex: 1; }
        .csv-date { color: #666; font-size: 0.8em; margin-right: 10px; }
        .csv-actions button { margin-left: 5px; font-size: 12px; padding: 3px 8px; }

        #image-gallery-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 15px; }
        .image-item { border: 1px solid #ddd; border-radius: 4px; padding: 3px; background: #fff; overflow: hidden; position: relative; }
        .gallery-image { width: 100%; aspect-ratio: 1/1; object-fit: cover; display: block; }
        .pdf-icon { width: 100%; aspect-ratio: 1/1; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #ffecec; color: #d32f2f; font-weight: bold; font-size: 0.9em; text-decoration: none; }
        
        .product-info { font-size: 0.75em; padding: 5px; line-height: 1.4; border-top: 1px solid #eee; background: #fafafa; }
        .p-name { font-weight: bold; color: #333; margin-bottom: 2px; }
        .p-detail { display: flex; justify-content: space-between; color: #666; }
        .p-price { color: #d32f2f; font-weight: bold; }

        #csvDownloader { display: inline-block; padding: 5px 10px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; font-size: 12px; visibility: hidden; }
        .gallery-item { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; margin-bottom: 5px; cursor: pointer; font-size: 14px; }
        .gallery-item.active { background-color: #007bff; color: white; }
        .action-buttons { float: right; } .delete-btn { background: #dc3545; color: white; border:none; border-radius:3px; width:20px; height:20px; cursor:pointer; }

        @media (max-width: 768px) {
            #upload-section, #gallery-section { grid-template-columns: 1fr; }
            #gallery-section { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div id="auth-status">
        <span id="username-display">...</span>
        <button id="fix-db-btn" title="ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚’å¼·åˆ¶å®Ÿè¡Œ">âš ï¸DBä¿®å¾©</button>
        <button id="personal-btn" onclick="location.href='/personal'">å€‹äººã‚¢ãƒ«ãƒãƒ </button>
        <button id="logoutButton">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div id="main-content">
        <h3>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
        <div id="upload-section">
            <div><label>1. å¤§ã‚«ãƒ†ã‚´ãƒª</label><select id="cat1Select"></select><input type="text" id="cat1NewInput" style="display:none" placeholder="æ–°è¦"></div>
            <div><label>2. ä¸­ã‚«ãƒ†ã‚´ãƒª</label><select id="cat2Select"></select><input type="text" id="cat2NewInput" style="display:none" placeholder="æ–°è¦"></div>
            <div><label>3. å°ã‚«ãƒ†ã‚´ãƒª</label><select id="cat3Select"></select><input type="text" id="cat3NewInput" style="display:none" placeholder="æ–°è¦"></div>
            <div><label>4. ãƒ•ã‚©ãƒ«ãƒ€å</label><input type="text" id="folderInput" value="default_folder"></div>
            <div style="grid-column: span 2;">
                <label>5. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</label>
                <div id="dropZone" onclick="document.getElementById('imageInput').click()">
                    ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ<br><span style="font-size:0.8em; color:#888;">(ç”»åƒ/PDF)</span>
                    <input type="file" id="imageInput" accept="image/*,.pdf" multiple style="display: none;">
                    <div id="fileInfo" style="margin-top:5px; font-weight:bold; color:#007bff;">æœªé¸æŠ</div>
                </div>
                <button id="uploadButton" style="margin-top: 10px; width:100%; background:#28a745; color:white; border:none; padding:12px;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹</button>
            </div>
            <p id="uploadStatus"></p>
        </div>

        <div id="csv-manage-section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold;">ğŸ“„ å•†å“æƒ…å ±ç®¡ç†</span>
                <button onclick="location.href='/api/products/template'" style="background:#6c757d; color:white; border:none;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜</button>
            </div>
            <div style="margin-top:10px; display:flex; gap:10px;">
                <input type="file" id="productCsvInput" accept=".csv" style="width:auto;">
                <button id="importCsvBtn" style="background:#6610f2; color:white; border:none;">ç™»éŒ²</button>
            </div>
            <span id="csvImportStatus" style="font-size:0.9em; color:green;"></span>
            <h4 style="margin:15px 0 5px 0; font-size:0.9em;">ç™»éŒ²æ¸ˆã¿CSVä¸€è¦§</h4>
            <div id="csv-file-list">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <hr>
        <h3>å±¥æ­´ãƒ»ã‚®ãƒ£ãƒ©ãƒªãƒ¼ <a href="#" id="csvDownloader">ä¸€è¦§CSVä¿å­˜</a></h3>
        <div id="gallery-section">
            <div id="cat1-container" class="gallery-column"><h4>å¤§</h4></div>
            <div id="cat2-container" class="gallery-column"><h4>ä¸­</h4></div>
            <div id="cat3-container" class="gallery-column"><h4>å°</h4></div>
            <div id="folder-container" class="gallery-column"><h4>ãƒ•ã‚©ãƒ«ãƒ€</h4></div>
        </div>

        <div style="margin-top:20px;">
            <input type="search" id="searchInput" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åãƒ»å•†å“åãƒ»å‹ç•ªã§æ¤œç´¢...">
            <select id="sortBy" style="width:auto"><option value="created_at">æ—¥ä»˜é †</option><option value="title">åå‰é †</option></select>
            <select id="sortOrder" style="width:auto"><option value="DESC">æ–°</option><option value="ASC">å¤</option></select>
        </div>
        <div id="image-gallery-container"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/auth/check');
                const data = await res.json();
                if (data.loggedIn) {
                    document.getElementById('username-display').textContent = `${data.username}`;
                    initApp();
                } else { window.location.href = '/login'; }
            } catch (e) { window.location.href = '/login'; }
        });

        document.getElementById('logoutButton').addEventListener('click', async () => {
            await fetch('/api/auth/logout', { method: 'POST' }); window.location.href = '/login';
        });

        document.getElementById('fix-db-btn').addEventListener('click', async () => {
            if(!confirm('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹æˆã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) return;
            try {
                const r = await fetch('/api/admin/init-db', { method: 'POST' });
                const d = await r.json();
                alert(d.message);
                location.reload();
            } catch(e) { alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
        });

        const els = {
            file: document.getElementById('imageInput'),
            c1: document.getElementById('cat1Select'), c1n: document.getElementById('cat1NewInput'),
            c2: document.getElementById('cat2Select'), c2n: document.getElementById('cat2NewInput'),
            c3: document.getElementById('cat3Select'), c3n: document.getElementById('cat3NewInput'),
            folder: document.getElementById('folderInput'),
            upBtn: document.getElementById('uploadButton'), stat: document.getElementById('uploadStatus'),
            drop: document.getElementById('dropZone'), info: document.getElementById('fileInfo'),
            gal: document.getElementById('image-gallery-container'),
            csv: document.getElementById('csvDownloader'),
            search: document.getElementById('searchInput'), sort: document.getElementById('sortBy'), order: document.getElementById('sortOrder'),
            csvIn: document.getElementById('productCsvInput'), impBtn: document.getElementById('importCsvBtn'), impStat: document.getElementById('csvImportStatus'),
            csvList: document.getElementById('csv-file-list')
        };
        let sels = { c1: null, c2: null, c3: null, f: null };
        let lightbox;

        function initApp() {
            loadCat1(); setupDropZone(); setupSelects(); loadCsvList();
            els.upBtn.onclick = uploadFiles;
            els.search.oninput = debounce(() => loadImages(sels.f, els.search.value), 500);
            els.sort.onchange = els.order.onchange = () => loadImages(sels.f, els.search.value);
            els.impBtn.onclick = importCsv;
        }

        async function loadCsvList() {
            try {
                const r = await fetch('/api/products/files');
                const list = await r.json();
                els.csvList.innerHTML = '';
                if (list.length === 0) { els.csvList.innerHTML = '<div style="padding:10px; color:#999;">å±¥æ­´ãªã—</div>'; return; }
                list.forEach(file => {
                    const div = document.createElement('div'); div.className = 'csv-item';
                    const date = new Date(file.uploaded_at).toLocaleString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    div.innerHTML = `
                        <span class="csv-name">${file.filename}</span>
                        <span class="csv-date">${date}</span>
                        <div class="csv-actions">
                            <button onclick="downloadCsvFile(${file.id})" style="background:#17a2b8; color:white; border:none;">DL</button>
                            <button onclick="deleteCsvFile(${file.id}, '${file.filename}')" style="background:#dc3545; color:white; border:none;">å‰Šé™¤</button>
                        </div>
                    `;
                    els.csvList.appendChild(div);
                });
            } catch(e) { els.csvList.innerText = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'; }
        }

        async function importCsv() {
            if(els.csvIn.files.length===0) return alert('é¸æŠã—ã¦ãã ã•ã„');
            const fd = new FormData(); fd.append('csvFile', els.csvIn.files[0]);
            els.impStat.innerText = "ç™»éŒ²ä¸­...";
            try {
                const r = await fetch('/api/products/import', {method:'POST', body:fd});
                const d = await r.json();
                if(!r.ok) throw new Error(d.message || 'Error');
                els.impStat.innerText = d.message; els.impStat.style.color = "green"; loadCsvList(); 
                if(sels.f) loadImages(sels.f, els.search.value);
            } catch(e){ els.impStat.innerText = `ã‚¨ãƒ©ãƒ¼: ${e.message}`; els.impStat.style.color="red"; }
        }

        function downloadCsvFile(id) { window.location.href = `/api/products/files/${id}/download`; }
        async function deleteCsvFile(id, name) {
            if(!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            try { await fetch(`/api/products/files/${id}`, {method:'DELETE'}); loadCsvList(); if(sels.f) loadImages(sels.f, els.search.value); } catch(e){ alert('ã‚¨ãƒ©ãƒ¼'); }
        }

        // â˜…ä¿®æ­£: ãƒ•ã‚©ãƒ«ãƒ€æœªé¸æŠã§ã‚‚æ¤œç´¢å¯èƒ½ã«ã™ã‚‹
        async function loadImages(f, q='') {
            // æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚‚ãªããƒ•ã‚©ãƒ«ãƒ€ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯æˆ»ã‚‹
            if(!f && !q) return;
            
            els.gal.innerHTML = '<p style="grid-column:span 4; text-align:center;">èª­è¾¼ä¸­...</p>';
            const params = new URLSearchParams({
                cat1: sels.c1 || '', cat2: sels.c2 || '', cat3: sels.c3 || '',
                folder: f || '', q: q,
                sort: els.sort.value, order: els.order.value
            });
            
            try {
                const r = await fetch(`/api/search?${params}`);
                const d = await r.json();
                if(!r.ok) throw new Error(d.message || 'Error');
                els.gal.innerHTML = '';
                if(d.length===0) els.gal.innerHTML = '<p style="grid-column:span 4; text-align:center; color:#888;">ç”»åƒãªã—</p>';
                d.forEach(img => {
                    const div = document.createElement('div'); div.className = 'image-item';
                    const name = img.title.split('/').pop();
                    let info = '';
                    if(img.product_name) {
                        info = `<div class="product-info"><div class="p-name">${img.product_name}</div><div class="p-detail"><span>${img.model_num1 || ''} ${img.model_num2 || ''}</span><span class="p-price">Â¥${img.ec_price ? img.ec_price.toLocaleString() : '-'}</span></div><div style="font-size:0.8em; color:#666;">åœ¨åº«: ${img.stock} | çŠ¶æ…‹: ${img.condition}</div></div>`;
                    }
                    if (img.url.toLowerCase().endsWith('.pdf')) {
                        div.innerHTML = `<a href="${img.url}" target="_blank" class="pdf-icon">ğŸ“„ PDF<br>${name}</a>${info}`;
                    } else {
                        div.innerHTML = `<a href="${img.url}" class="lightbox-link" title="${img.product_name || name}"><img src="${img.url}" class="gallery-image" alt="${name}"></a>${info}`;
                    }
                    els.gal.appendChild(div);
                });
                if(lightbox) lightbox.destroy();
                lightbox = new SimpleLightbox('#image-gallery-container .lightbox-link');
                els.csv.style.visibility = f ? 'visible' : 'hidden'; // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠæ™‚ã®ã¿CSVãƒœã‚¿ãƒ³è¡¨ç¤º
                if(f) els.csv.href = `/download-csv?folder=${f}&cat1=${sels.c1}&cat2=${sels.c2}&cat3=${sels.c3}`;
            } catch(e) { els.gal.innerHTML = `<p style="color:red;">${e.message}</p>`; }
        }

        // (ä»¥ä¸‹å¤‰æ›´ãªã—)
        async function loadList(u,i,t,cb){const d=document.getElementById(i);d.innerHTML=`<h4>${t}</h4>`;try{const r=await fetch(u);const j=await r.json();j.forEach(v=>{const e=document.createElement('div');e.className='gallery-item';e.innerText=v;e.onclick=()=>{d.querySelectorAll('.gallery-item').forEach(x=>x.classList.remove('active'));e.classList.add('active');cb(v);};d.appendChild(e);});}catch(e){}}
        async function loadOpts(u,s){try{const r=await fetch(u);const j=await r.json();s.innerHTML='<option value="">--</option>';j.forEach(v=>s.innerHTML+=`<option value="${v}">${v}</option>`);s.innerHTML+='<option value="_new_">+æ–°</option>';}catch(e){}}
        const loadCat1=()=>{resetUI(1);loadList('/api/cat1','cat1-container','å¤§',v=>{sels.c1=v;els.c1.value=v;checkNew(els.c1,els.c1n);loadCat2(v);});loadOpts('/api/cat1',els.c1);};
        const loadCat2=(c)=>{resetUI(2);loadList(`/api/cat2/${c}`,'cat2-container','ä¸­',v=>{sels.c2=v;els.c2.value=v;checkNew(els.c2,els.c2n);loadCat3(c,v);});loadOpts(`/api/cat2/${c}`,els.c2);};
        const loadCat3=(c1,c2)=>{resetUI(3);loadList(`/api/cat3/${c1}/${c2}`,'cat3-container','å°',v=>{sels.c3=v;els.c3.value=v;checkNew(els.c3,els.c3n);loadFolder(c1,c2,v);});loadOpts(`/api/cat3/${c1}/${c2}`,els.c3);};
        const loadFolder=(c1,c2,c3)=>{resetUI(4);loadList(`/api/folders/${c1}/${c2}/${c3}`,'folder-container','ãƒ•ã‚©ãƒ«ãƒ€',v=>{sels.f=v;els.folder.value=v;loadImages(v);});};
        function resetUI(l){if(l<=1)document.getElementById('cat2-container').innerHTML='<h4>ä¸­</h4>';if(l<=2)document.getElementById('cat3-container').innerHTML='<h4>å°</h4>';if(l<=3)document.getElementById('folder-container').innerHTML='<h4>ãƒ•ã‚©ãƒ«ãƒ€</h4>';if(l<=4)els.gal.innerHTML='';}
        function setupDropZone(){els.drop.ondragover=e=>{e.preventDefault();els.drop.classList.add('drag-over');};els.drop.ondragleave=()=>els.drop.classList.remove('drag-over');els.drop.ondrop=e=>{e.preventDefault();els.drop.classList.remove('drag-over');els.file.files=e.dataTransfer.files;els.info.innerText=els.file.files.length+' Files';};els.file.onchange=()=>els.info.innerText=els.file.files.length+' Files';}
        function setupSelects(){const h=(s,i,l)=>{checkNew(s,i);if(s.value!=='_new_'){if(l===1)loadCat2(s.value);if(l===2)loadCat3(sels.c1,s.value);}};els.c1.onchange=()=>h(els.c1,els.c1n,1);els.c2.onchange=()=>h(els.c2,els.c2n,2);els.c3.onchange=()=>checkNew(els.c3,els.c3n);}
        function checkNew(s,i){i.style.display=s.value==='_new_'?'block':'none';}
        async function uploadFiles(){const fd=new FormData();fd.append('category1',els.c1.value==='_new_'?els.c1n.value:els.c1.value);fd.append('category2',els.c2.value==='_new_'?els.c2n.value:els.c2.value);fd.append('category3',els.c3.value==='_new_'?els.c3n.value:els.c3.value);fd.append('folderName',els.folder.value);for(let f of els.file.files)fd.append('imageFiles',f);els.stat.innerText='UP...';try{const r=await fetch('/upload',{method:'POST',body:fd});if(!r.ok)throw 1;els.stat.innerText='OK';els.file.value='';loadCat1();}catch(e){els.stat.innerText='Err';}}
        function debounce(f,w){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>f.apply(this,a),w);};}
    </script>
</body>
</html>