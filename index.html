<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>画像アップローダー (4階層)</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 1em 2em; }
        hr { margin: 2em 0; }
        input[type="text"], input[type="search"] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 95%; } /* Width full */
        button { padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        #upload-section { background: #f9f9f9; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; } /* Grid layout */
        #upload-section label { font-weight: bold; }
        #uploadStatus { font-weight: bold; grid-column: span 3; } /* Status below */
        #csvDownloader { display: inline-block; padding: 8px 12px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; }

        /* ▼▼▼ 4階層ギャラリーのスタイル ▼▼▼ */
        #gallery-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; } /* 4 columns */
        .gallery-column { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; min-height: 200px; }
        .gallery-item { /* Common style for cat/folder items */
            padding: 8px; border: 1px solid #ccc; border-radius: 5px; background-color: #f4f4f4;
            font-weight: bold; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .gallery-item.active { background-color: #007bff; color: white; border-color: #007bff; }
        .gallery-item span { flex-grow: 1; } /* Name part */
        .action-buttons { display: flex; gap: 3px; flex-shrink: 0; margin-left: 5px; }
        .edit-btn, .delete-btn { border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-weight: bold; line-height: 20px; text-align: center; color: white; }
        .edit-btn { background: #ffc107; } .edit-btn:hover { background: #e0a800; }
        .delete-btn { background: #dc3545; } .delete-btn:hover { background: #c82333; }
        /* ▲▲▲ 4階層ギャラリーのスタイル ここまで ▲▲▲ */

        #search-section { margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px; }
        #searchInput { width: 300px; padding: 8px; }
        #image-gallery-container { grid-column: span 4; display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 2px solid #eee; } /* Span across 4 cols */
        .gallery-image { width: 100%; height: 130px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="upload-section">
        <div><label for="cat1Input">1. 大カテゴリ名:</label><br><input type="text" id="cat1Input" value="default_cat1"></div>
        <div><label for="cat2Input">2. 中カテゴリ名:</label><br><input type="text" id="cat2Input" value="default_cat2"></div>
        <div><label for="cat3Input">3. 小カテゴリ名:</label><br><input type="text" id="cat3Input" value="default_cat3"></div>
        <div><label for="folderInput">4. フォルダ名:</label><br><input type="text" id="folderInput" value="default_folder"></div>
        <div style="grid-column: span 2;"><p>5. ファイルを選択</p><input type="file" id="imageInput" accept="image/*" multiple><button id="uploadButton">アップロード</button></div>
        <p id="uploadStatus" style="grid-column: span 3;"></p>
    </div>

    <hr>
    <h3>履歴のダウンロード</h3><p>現在選択中の**フォルダ**のCSVをダウンロードします。</p><a href="#" id="csvDownloader" style="visibility: hidden;">CSVダウンロード</a><p id="csv-status-text">(フォルダを選択するとボタンが有効になります)</p><hr>

    <h3>階層別 ギャラリー</h3><p>大 → 中 → 小 → フォルダ の順に選択。(Eで編集、Xで削除はフォルダのみ)</p>

    <div id="gallery-section">
        <div id="cat1-container" class="gallery-column"><h4>大カテゴリ</h4><p class="loading-status">読込中...</p></div>
        <div id="cat2-container" class="gallery-column"><h4>中カテゴリ</h4><p class="loading-status"></p></div>
        <div id="cat3-container" class="gallery-column"><h4>小カテゴリ</h4><p class="loading-status"></p></div>
        <div id="folder-container" class="gallery-column"><h4>フォルダ</h4><p class="loading-status"></p></div>
    </div>

    <div id="search-section" style="display: none;"><label for="searchInput">画像検索:</label><input type="search" id="searchInput" placeholder="..."></div>
    <div id="image-gallery-container"></div>

    <script>
        // --- HTML要素を取得 ---
        const fileInput = document.getElementById('imageInput');
        const cat1Input = document.getElementById('cat1Input');
        const cat2Input = document.getElementById('cat2Input');
        const cat3Input = document.getElementById('cat3Input');
        const folderInput = document.getElementById('folderInput');
        const uploadButton = document.getElementById('uploadButton');
        const statusP = document.getElementById('uploadStatus');
        const cat1Container = document.getElementById('cat1-container');
        const cat2Container = document.getElementById('cat2-container');
        const cat3Container = document.getElementById('cat3-container');
        const folderContainer = document.getElementById('folder-container');
        const galleryContainer = document.getElementById('image-gallery-container');
        const csvButton = document.getElementById('csvDownloader');
        const csvStatus = document.getElementById('csv-status-text');
        const searchSection = document.getElementById('search-section');
        const searchInput = document.getElementById('searchInput');

        let selections = { cat1: null, cat2: null, cat3: null, folder: null };

        // --- アップロード機能 ---
        uploadButton.addEventListener('click', async () => {
            const files = fileInput.files;
            const cat1 = cat1Input.value.trim(); const cat2 = cat2Input.value.trim();
            const cat3 = cat3Input.value.trim(); const folderName = folderInput.value.trim();
            if (files.length === 0 || !cat1 || !cat2 || !cat3 || !folderName) {
                alert('すべてのカテゴリ・フォルダ名を入力し、ファイルを選択してください。'); return;
            }
            const formData = new FormData();
            formData.append('category1', cat1); formData.append('category2', cat2);
            formData.append('category3', cat3); formData.append('folderName', folderName);
            for (let i = 0; i < files.length; i++) { formData.append('imageFiles', files[i]); }
            statusP.style.color = 'blue'; statusP.innerText = `アップロード中...`;
            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const data = await response.json();
                if (response.ok) {
                    statusP.style.color = 'green'; statusP.innerText = data.message;
                    fileInput.value = '';
                    loadCat1();
                } else { throw new Error(data.message); }
            } catch (error) { statusP.style.color = 'red'; statusP.innerText = `失敗: ${error.message}`; }
        });

        // --- ギャラリー機能 ---
        document.addEventListener('DOMContentLoaded', () => { loadCat1(); });

        // (A) 大カテゴリ(Cat1)読み込み
        async function loadCat1() {
            resetUI(1);
            await loadList('/api/cat1', cat1Container, '大カテゴリ', (cat1Name) => {
                selections.cat1 = cat1Name; loadCat2(cat1Name);
                cat1Input.value = cat1Name;
            });
        }
        // (B) 中カテゴリ(Cat2)読み込み
        async function loadCat2(cat1) {
            resetUI(2);
            await loadList(`/api/cat2/${encodeURIComponent(cat1)}`, cat2Container, '中カテゴリ', (cat2Name) => {
                selections.cat2 = cat2Name; loadCat3(cat1, cat2Name);
                cat2Input.value = cat2Name;
            });
        }
        // (C) 小カテゴリ(Cat3)読み込み
        async function loadCat3(cat1, cat2) {
            resetUI(3);
            await loadList(`/api/cat3/${encodeURIComponent(cat1)}/${encodeURIComponent(cat2)}`, cat3Container, '小カテゴリ', (cat3Name) => {
                selections.cat3 = cat3Name; loadFolders(cat1, cat2, cat3Name);
                cat3Input.value = cat3Name;
            });
        }
        // (D) フォルダ読み込み
        async function loadFolders(cat1, cat2, cat3) {
            resetUI(4);
            await loadList(`/api/folders/${encodeURIComponent(cat1)}/${encodeURIComponent(cat2)}/${encodeURIComponent(cat3)}`, folderContainer, 'フォルダ', (folderName) => {
                selections.folder = folderName; loadImages(folderName); // ★画像読み込みトリガー
                folderInput.value = folderName;
            }, true); // Add action buttons for folders
        }

        // 汎用リスト読み込み関数
        async function loadList(apiUrl, container, title, onClickCallback, addActionButtons = false) {
            container.innerHTML = `<h4>${title}</h4><p class="loading-status">読込中...</p>`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const items = await response.json();
                container.innerHTML = `<h4>${title}</h4>`;
                if (items.length === 0) { container.innerHTML += '<p>データなし</p>'; return; }

                items.forEach(itemName => {
                    const itemDiv = document.createElement('div'); itemDiv.className = 'gallery-item';
                    const nameSpan = document.createElement('span'); nameSpan.innerText = itemName;
                    nameSpan.addEventListener('click', () => {
                        document.querySelectorAll(`#${container.id} .gallery-item`).forEach(el => el.classList.remove('active'));
                        itemDiv.classList.add('active');
                        onClickCallback(itemName);
                    });
                    itemDiv.appendChild(nameSpan);

                    if (addActionButtons) { // Only add for folders
                        const actionButtons = document.createElement('div'); actionButtons.className = 'action-buttons';
                        const editBtn = document.createElement('button'); editBtn.className = 'edit-btn'; editBtn.innerText = 'E'; editBtn.title = '名前変更';
                        editBtn.addEventListener('click', (e) => { e.stopPropagation(); renameFolder(itemName); });
                        const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-btn'; deleteBtn.innerText = 'X'; deleteBtn.title = '削除';
                        deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteFolder(itemName); });
                        actionButtons.appendChild(editBtn); actionButtons.appendChild(deleteBtn);
                        itemDiv.appendChild(actionButtons);
                    }
                    container.appendChild(itemDiv);
                });
            } catch (error) { console.error(`${title}読み込みエラー:`, error); container.innerHTML = `<h4>${title}</h4><p style="color: red;">失敗</p>`; }
        }

        // UIリセット関数
        function resetUI(startLevel) {
            if (startLevel <= 1) { selections.cat1 = null; cat2Container.innerHTML = '<h4>中カテゴリ</h4>'; }
            if (startLevel <= 2) { selections.cat2 = null; cat3Container.innerHTML = '<h4>小カテゴリ</h4>'; }
            if (startLevel <= 3) { selections.cat3 = null; folderContainer.innerHTML = '<h4>フォルダ</h4>'; }
            if (startLevel <= 4) {
                selections.folder = null; galleryContainer.innerHTML = '';
                searchSection.style.display = 'none'; searchInput.value = '';
                csvButton.style.visibility = 'hidden'; csvStatus.innerText = '(フォルダを選択で有効化)';
            }
        }

        // (E) 画像読み込みトリガー
        async function loadImages(folderName) {
            selections.folder = folderName;
            searchInput.value = '';
            searchSection.style.display = 'block';
            await displayImages(folderName, ''); // Call display function
        }

        // (F) 検索イベントリスナー
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                if (selections.folder) { await displayImages(selections.folder, searchInput.value.trim()); }
            }, 300);
        });

        // (G) 画像取得・表示関数 (★API URLを修正済み)
        async function displayImages(folderName, searchTerm) {
            try {
                galleryContainer.innerHTML = '<p>読込中...</p>';
                const encodedFolderName = encodeURIComponent(folderName);
                let apiUrl;
                if (searchTerm) {
                    const encodedSearchTerm = encodeURIComponent(searchTerm);
                    apiUrl = `/api/search?folder=${encodedFolderName}&q=${encodedSearchTerm}`;
                } else {
                    apiUrl = `/api/images/${encodedFolderName}`; // ★修正済みのURL
                }
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const images = await response.json();
                galleryContainer.innerHTML = '';
                if (images.length === 0) { galleryContainer.innerHTML = searchTerm ? '<p>検索結果なし</p>' : '<p>画像なし</p>'; }
                else {
                    images.forEach(imgData => {
                         const img = document.createElement('img');
                         img.className='gallery-image';
                         img.src=imgData.url;
                         img.alt=imgData.title;
                         img.title=imgData.title;
                         galleryContainer.appendChild(img);
                     });
                }
                csvButton.href = `/download-csv?folder=${encodedFolderName}`;
                csvButton.style.visibility = 'visible'; csvStatus.innerText = `「${folderName}」CSV`;
            } catch (error) { console.error('画像読込/検索エラー:', error); galleryContainer.innerHTML = '<p style="color: red;">失敗</p>'; csvButton.style.visibility = 'hidden'; csvStatus.innerText = '(フォルダ選択で有効化)'; }
        }

        // (H) フォルダ削除関数
        async function deleteFolder(folderName) {
            if (!confirm(`フォルダ「${folderName}」を完全削除しますか？\n（R2の画像ファイルも削除されます）`)) return;
            try {
                statusP.innerText = `削除中...`; statusP.style.color = 'blue';
                const response = await fetch(`/api/folder/${encodeURIComponent(folderName)}`, { method: 'DELETE' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                statusP.innerText = data.message; statusP.style.color = 'green';
                if(selections.cat1 && selections.cat2 && selections.cat3) {
                   loadFolders(selections.cat1, selections.cat2, selections.cat3); // Refresh current folder list
                } else { loadCat1(); }
                resetUI(4);
            } catch (error) { console.error('削除エラー:', error); statusP.innerText = '削除失敗'; statusP.style.color = 'red'; }
        }

        // (I) フォルダ名変更関数
        async function renameFolder(oldFolderName) {
            const newFolderName = prompt(`「${oldFolderName}」の新しい名前:`, oldFolderName);
            if (!newFolderName || newFolderName.trim() === '' || newFolderName.trim() === oldFolderName) return;
            try {
                statusP.innerText = `変更中...`; statusP.style.color = 'blue';
                const response = await fetch(`/api/folder/${encodeURIComponent(oldFolderName)}`, {
                    method: 'PUT', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ newFolderName: newFolderName.trim() })
                });
                if (!response.ok) {
                    const errData = await response.json(); // Try to get error message from server
                    throw new Error(errData.message || `HTTP ${response.status}`);
                }
                const data = await response.json();
                statusP.innerText = data.message; statusP.style.color = 'green';
                if(selections.cat1 && selections.cat2 && selections.cat3) {
                   loadFolders(selections.cat1, selections.cat2, selections.cat3); // Refresh current folder list
                } else { loadCat1(); }
                resetUI(4);
            } catch (error) { console.error('名前変更エラー:', error); statusP.innerText = `変更失敗: ${error.message}`; statusP.style.color = 'red'; }
        }

    </script>
</body>
</html>