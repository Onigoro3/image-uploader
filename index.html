<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>画像アップローダー (ギャラリー機能付き)</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 1em 2em; }
        hr { margin: 2em 0; }
        
        /* アップロード欄 */
        #uploadStatus { font-weight: bold; }
        
        /* CSVダウンロードボタン */
        #csvDownloader {
            display: inline-block; padding: 8px 12px;
            background-color: #007bff; color: white;
            text-decoration: none; border-radius: 4px;
        }
        #csvDownloader:hover { background-color: #0056b3; }

        /* --- ここから新機能のスタイル --- */
        
        /* 日付フォルダのコンテナ */
        #date-folders-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* フォルダ間のすき間 */
        }
        
        /* 日付フォルダ（ボタン風） */
        .date-folder {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f4f4f4;
            cursor: pointer; /* クリックできることを示す */
            font-weight: bold;
        }
        .date-folder:hover {
            background-color: #e9e9e9;
        }
        .date-folder.active {
            /* 選択中のフォルダのデザイン */
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* 画像ギャラリーのコンテナ */
        #image-gallery-container {
            display: grid;
            /* 画像を自動で折り返して並べる（1列150px、すき間10px） */
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        
        /* ギャラリー内の各画像 */
        .gallery-image {
            width: 100%;
            height: 150px;
            object-fit: cover; /* 画像の比率を保ったまま枠に収める */
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
    </head>
<body>

    <h2>画像をアップロード (複数選択可)</h2>
    <input type="file" id="imageInput" accept="image/*" multiple>
    <button id="uploadButton">アップロード</button>
    <p id="uploadStatus"></p>

    <hr>

    <h3>履歴のダウンロード</h3>
    <p>アップロードした画像の「題名」と「URL」のリストをCSVでダウンロードします。</p>
    <a href="/download-csv" id="csvDownloader">CSVダウンロード</a>

    <hr>
    
    <h3>日付別 ギャラリー</h3>
    <p>日付をクリックすると、その日にアップロードされた画像が表示されます。</p>
    
    <div id="date-folders-container">
        <p id="gallery-loading-status">ギャラリーを読み込み中...</p>
    </div>
    
    <div id="image-gallery-container"></div>
    
    <script>
        // --- アップロード機能 (変更なし) ---
        document.getElementById('uploadButton').addEventListener('click', async () => {
            const fileInput = document.getElementById('imageInput');
            const statusP = document.getElementById('uploadStatus');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('画像が選択されていません。'); return;
            }
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('imageFiles', files[i]);
            }
            statusP.style.color = 'blue';
            statusP.innerText = `アップロード中... (${files.length} 件)`;
            try {
                const response = await fetch('/upload', {
                    method: 'POST', body: formData
                });
                const data = await response.json();
                if (response.ok) {
                    statusP.style.color = 'green';
                    statusP.innerText = data.message;
                    fileInput.value = '';
                    // ★【追加】アップロード成功したら、日付リストを再読み込み
                    loadDateFolders(); 
                } else {
                    statusP.style.color = 'red';
                    statusP.innerText = 'アップロード失敗: ' + data.message;
                }
            } catch (error) {
                statusP.style.color = 'red';
                statusP.innerText = '通信エラーが発生しました。';
            }
        });

        // --- ここから新機能のスクリプト ---
        
        const dateContainer = document.getElementById('date-folders-container');
        const galleryContainer = document.getElementById('image-gallery-container');
        const galleryStatus = document.getElementById('gallery-loading-status');

        // (A) ページが読み込まれたら、まず日付リストを取得する
        document.addEventListener('DOMContentLoaded', () => {
            loadDateFolders();
        });

        // (B) サーバーの「/api/dates」に通信して、日付フォルダを作る関数
        async function loadDateFolders() {
            try {
                const response = await fetch('/api/dates'); // サーバーのAPIを叩く
                const dates = await response.json(); // ['2025-10-19', '2025-10-18', ...]
                
                dateContainer.innerHTML = ''; // 「読み込み中...」の文字を消す

                if (dates.length === 0) {
                    galleryStatus.innerText = 'アップロードされた画像はまだありません。';
                    dateContainer.appendChild(galleryStatus);
                    return;
                }

                // 取得した日付の数だけ、フォルダ(div)を作る
                dates.forEach(dateStr => {
                    const folder = document.createElement('div');
                    folder.className = 'date-folder';
                    folder.innerText = dateStr;
                    
                    // ★フォルダがクリックされた時の動作を設定
                    folder.addEventListener('click', () => {
                        // (C) の関数を呼び出す
                        loadImagesByDate(dateStr); 
                        
                        // クリックされたフォルダだけ見た目を変える
                        document.querySelectorAll('.date-folder').forEach(f => f.classList.remove('active'));
                        folder.classList.add('active');
                    });
                    
                    dateContainer.appendChild(folder);
                });

                // ★自動で最初の日付をクリックした状態にする
                if (dates.length > 0) {
                    dateContainer.children[0].click();
                }

            } catch (error) {
                console.error('日付フォルダの読み込みエラー:', error);
                dateContainer.innerHTML = '<p style="color: red;">日付フォルダの読み込みに失敗しました。</p>';
            }
        }

        // (C) サーバーの「/api/images/:date」に通信して、画像ギャラリーを作る関数
        async function loadImagesByDate(date) {
            try {
                // 読み込み中にギャラリーを一度空にする
                galleryContainer.innerHTML = '<p>画像を読み込み中...</p>'; 
                
                // サーバーのAPIを叩く (例: /api/images/2025-10-19)
                const response = await fetch(`/api/images/${date}`);
                const images = await response.json(); // [{title: 'a.jpg', url: '...'}, ...]

                galleryContainer.innerHTML = ''; // 「読み込み中...」を消す
                
                if (images.length === 0) {
                    galleryContainer.innerHTML = '<p>この日付の画像はありません。</p>';
                    return;
                }

                // 取得した画像の数だけ、画像タグ(img)を作る
                images.forEach(image => {
                    const img = document.createElement('img');
                    img.className = 'gallery-image';
                    img.src = image.url;   // 画像URL
                    img.alt = image.title; // 題名
                    img.title = image.title; // ホバーで題名表示
                    
                    galleryContainer.appendChild(img);
                });

            } catch (error) {
                console.error('画像ギャラリーの読み込みエラー:', error);
                galleryContainer.innerHTML = '<p style="color: red;">画像の読み込みに失敗しました。</p>';
            }
        }

    </script>
    </body>
</html>