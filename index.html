<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 10px; margin: 0; background-color: #fff; }
        
        #auth-status { 
            position: fixed; top: 0; left: 0; width: 100%; 
            background: #f8f9fa; padding: 10px; 
            border-bottom: 1px solid #ccc; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            z-index: 1000; 
            display: flex; justify-content: flex-end; align-items: center;
            box-sizing: border-box;
        }
        #username-display { margin-right: 10px; font-weight: bold; font-size: 0.9em; }
        #auth-status button { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        #personal-btn { background: #17a2b8 !important; }
        
        #main-content { margin-top: 60px; }
        hr { margin: 2em 0; border: 0; border-top: 1px solid #eee; }
        
        input[type="text"], input[type="search"], select { 
            padding: 8px; border: 1px solid #ccc; border-radius: 4px; 
            width: 100%; box-sizing: border-box; font-size: 16px; margin-bottom: 5px; 
        }
        button { padding: 8px 15px; cursor: pointer; border-radius: 4px; font-size: 14px; }

        #upload-section { background: #f9f9f9; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        #upload-section label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em; }
        #uploadStatus { font-weight: bold; grid-column: span 3; margin-top: 10px; word-break: break-all; }
        
        #dropZone { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-top: 10px; background: #fff; border-radius: 4px; cursor: pointer; }
        #dropZone.drag-over { background-color: #e9ecef; border-color: #007bff; }

        #gallery-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .gallery-column { border: 1px solid #eee; padding: 5px; border-radius: 8px; background: #fafafa; height: 200px; overflow-y: auto; }
        .gallery-column h4 { margin: 0 0 5px 0; font-size: 0.9em; text-align: center; background: #eee; padding: 3px; }

        .gallery-item { 
            padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; 
            margin-bottom: 5px; cursor: pointer; font-size: 14px; display: flex; justify-content: space-between; align-items: center;
        }
        .gallery-item.active { background-color: #007bff; color: white; border-color: #007bff; }
        
        #search-section { margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        #image-gallery-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 15px; }
        
        /* PDFè¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .image-item { border: 1px solid #ddd; border-radius: 4px; padding: 3px; background: #fff; overflow: hidden; }
        .gallery-image { width: 100%; aspect-ratio: 1/1; object-fit: cover; display: block; border-radius: 2px; }
        .pdf-icon { 
            width: 100%; aspect-ratio: 1/1; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; background: #ffecec; color: #d32f2f; 
            font-weight: bold; font-size: 0.9em; text-decoration: none;
        }

        .new-input { display: none; margin-top: 5px; }
        #csvDownloader { display: inline-block; padding: 5px 10px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; font-size: 12px; visibility: hidden; }
        
        .action-buttons { display: flex; gap: 5px; }
        .delete-btn { border: none; border-radius: 3px; width: 24px; height: 24px; background: #dc3545; color: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }

        @media (max-width: 768px) {
            #upload-section { grid-template-columns: 1fr; gap: 10px; }
            #upload-section > div, #upload-section > div[style*="grid-column: span 2"] { grid-column: span 1 !important; }
            #uploadStatus { grid-column: span 1 !important; }
            #gallery-section { grid-template-columns: 1fr 1fr; }
            #search-section { flex-direction: column; align-items: stretch; }
            #search-section input { width: 100% !important; }
            #sort-controls { display: flex; justify-content: space-between; gap: 5px; }
            #sort-controls select { flex: 1; }
        }
    </style>
</head>
<body>
    <div id="auth-status">
        <span id="username-display">...</span>
        <button id="personal-btn" onclick="location.href='/personal'">å€‹äººã‚¢ãƒ«ãƒãƒ </button>
        <button id="logoutButton">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div id="main-content">
        <h3>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
        <div id="upload-section">
            <div><label>1. å¤§ã‚«ãƒ†ã‚´ãƒª</label><select id="cat1Select"></select><input type="text" id="cat1NewInput" class="new-input" placeholder="æ–°è¦å…¥åŠ›"></div>
            <div><label>2. ä¸­ã‚«ãƒ†ã‚´ãƒª</label><select id="cat2Select"></select><input type="text" id="cat2NewInput" class="new-input" placeholder="æ–°è¦å…¥åŠ›"></div>
            <div><label>3. å°ã‚«ãƒ†ã‚´ãƒª</label><select id="cat3Select"></select><input type="text" id="cat3NewInput" class="new-input" placeholder="æ–°è¦å…¥åŠ›"></div>
            <div><label>4. ãƒ•ã‚©ãƒ«ãƒ€å</label><input type="text" id="folderInput" value="default_folder"></div>
            <div style="grid-column: span 2;">
                <label>5. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ (ç”»åƒ/PDF)</label>
                <div id="dropZone" onclick="document.getElementById('imageInput').click();">
                    ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<br>
                    <span style="font-size:0.8em; color:#888;">(ã¾ãŸã¯PCãªã‚‰ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—)</span>
                    <input type="file" id="imageInput" accept="image/*,.pdf" multiple style="display: none;">
                    <div id="fileInfo" style="margin-top:5px; font-weight:bold; color:#007bff;">æœªé¸æŠ</div>
                </div>
                <button id="uploadButton" style="margin-top: 10px; width:100%; background:#28a745; color:white; border:none; padding:12px; font-size:16px; font-weight:bold;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹</button>
            </div>
            <p id="uploadStatus"></p>
        </div>

        <hr>
        <h3>å±¥æ­´ãƒ»ã‚®ãƒ£ãƒ©ãƒªãƒ¼ <a href="#" id="csvDownloader">CSVä¿å­˜</a> <span id="csv-status-text" style="font-size:0.8em; color:#666;"></span></h3>
        
        <div id="gallery-section">
            <div id="cat1-container" class="gallery-column"><h4>å¤§ã‚«ãƒ†ã‚´ãƒª</h4><p class="loading-status">èª­è¾¼ä¸­...</p></div>
            <div id="cat2-container" class="gallery-column"><h4>ä¸­ã‚«ãƒ†ã‚´ãƒª</h4><p class="loading-status"></p></div>
            <div id="cat3-container" class="gallery-column"><h4>å°ã‚«ãƒ†ã‚´ãƒª</h4><p class="loading-status"></p></div>
            <div id="folder-container" class="gallery-column"><h4>ãƒ•ã‚©ãƒ«ãƒ€</h4><p class="loading-status"></p></div>
        </div>

        <div id="search-section" style="display: none;">
            <input type="search" id="searchInput" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åã§æ¤œç´¢...">
            <div id="sort-controls"> 
                <select id="sortBy"><option value="created_at">æ—¥ä»˜é †</option><option value="title">åå‰é †</option></select> 
                <select id="sortOrder"><option value="DESC">æ–°ã—ã„é †</option><option value="ASC">å¤ã„é †</option></select> 
            </div>
        </div>
        <div id="image-gallery-container"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/auth/check');
                const data = await res.json();
                if (data.loggedIn) {
                    document.getElementById('username-display').textContent = `${data.username}`;
                    initApp();
                } else { window.location.href = '/login'; }
            } catch (e) { window.location.href = '/login'; }
        });

        document.getElementById('logoutButton').addEventListener('click', async () => {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        });

        const els = {
            file: document.getElementById('imageInput'),
            c1: document.getElementById('cat1Select'), c1n: document.getElementById('cat1NewInput'),
            c2: document.getElementById('cat2Select'), c2n: document.getElementById('cat2NewInput'),
            c3: document.getElementById('cat3Select'), c3n: document.getElementById('cat3NewInput'),
            folder: document.getElementById('folderInput'),
            upBtn: document.getElementById('uploadButton'), stat: document.getElementById('uploadStatus'),
            drop: document.getElementById('dropZone'), info: document.getElementById('fileInfo'),
            gal: document.getElementById('image-gallery-container'),
            csv: document.getElementById('csvDownloader'), csvStat: document.getElementById('csv-status-text'),
            searchSec: document.getElementById('search-section'), search: document.getElementById('searchInput'),
            sort: document.getElementById('sortBy'), order: document.getElementById('sortOrder')
        };
        let sels = { c1: null, c2: null, c3: null, f: null };
        let lightbox;

        function initApp() {
            loadCat1();
            setupDropZone();
            setupSelects();
            els.upBtn.onclick = uploadFiles;
            els.search.oninput = debounce(() => loadImages(sels.f, els.search.value), 500);
            els.sort.onchange = els.order.onchange = () => loadImages(sels.f, els.search.value);
        }

        async function loadList(url, containerId, title, onClick) {
            const div = document.getElementById(containerId);
            div.innerHTML = `<h4>${title}</h4><p style="color:#999; font-size:0.8em; padding:5px;">èª­è¾¼ä¸­...</p>`;
            try {
                const r = await fetch(url);
                if(r.status === 401) return window.location.href = '/login';
                if(!r.ok) throw new Error('Failed');
                const data = await r.json();
                div.innerHTML = `<h4>${title}</h4>`;
                if(data.length === 0) { div.innerHTML += '<p style="font-size:0.8em; color:#ccc; padding:5px;">ãªã—</p>'; return; }
                data.forEach(val => {
                    const el = document.createElement('div'); el.className = 'gallery-item';
                    el.innerHTML = `<span>${val}</span>`;
                    if (containerId === 'folder-container') {
                        const btns = document.createElement('div'); btns.className = 'action-buttons';
                        btns.innerHTML = `<button class="delete-btn" title="å‰Šé™¤">Ã—</button>`;
                        btns.querySelector('.delete-btn').onclick = (e) => { e.stopPropagation(); deleteFolder(val); };
                        el.appendChild(btns);
                    }
                    el.onclick = () => {
                        div.querySelectorAll('.gallery-item').forEach(x => x.classList.remove('active'));
                        el.classList.add('active'); onClick(val);
                    };
                    div.appendChild(el);
                });
            } catch(e) { div.innerHTML = `<h4>${title}</h4><p style="color:red; padding:5px;">ã‚¨ãƒ©ãƒ¼</p>`; }
        }

        async function loadOpts(url, sel) {
            try {
                const r = await fetch(url); if(!r.ok) return;
                const d = await r.json();
                sel.innerHTML = '<option value="">-- é¸æŠ --</option>';
                d.forEach(v => sel.innerHTML += `<option value="${v}">${v}</option>`);
                sel.innerHTML += '<option value="_new_">+ æ–°è¦ä½œæˆ</option>';
            } catch(e){}
        }

        const loadCat1 = () => {
            resetUI(1);
            loadList('/api/cat1', 'cat1-container', 'å¤§ã‚«ãƒ†ã‚´ãƒª', (v) => { sels.c1=v; els.c1.value=v; checkNew(els.c1, els.c1n); loadCat2(v); });
            loadOpts('/api/cat1', els.c1);
        };
        const loadCat2 = (c1) => {
            resetUI(2);
            loadList(`/api/cat2/${c1}`, 'cat2-container', 'ä¸­ã‚«ãƒ†ã‚´ãƒª', (v) => { sels.c2=v; els.c2.value=v; checkNew(els.c2, els.c2n); loadCat3(c1,v); });
            loadOpts(`/api/cat2/${c1}`, els.c2);
        };
        const loadCat3 = (c1,c2) => {
            resetUI(3);
            loadList(`/api/cat3/${c1}/${c2}`, 'cat3-container', 'å°ã‚«ãƒ†ã‚´ãƒª', (v) => { sels.c3=v; els.c3.value=v; checkNew(els.c3, els.c3n); loadFolder(c1,c2,v); });
            loadOpts(`/api/cat3/${c1}/${c2}`, els.c3);
        };
        const loadFolder = (c1,c2,c3) => {
            resetUI(4);
            loadList(`/api/folders/${c1}/${c2}/${c3}`, 'folder-container', 'ãƒ•ã‚©ãƒ«ãƒ€', (v) => { sels.f=v; els.folder.value=v; loadImages(v); });
        };

        async function loadImages(f, q='') {
            if(!f) return;
            els.gal.innerHTML = '<p style="grid-column:span 4; text-align:center;">ç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>';
            els.searchSec.style.display = 'flex';
            const params = new URLSearchParams({
                cat1: sels.c1, cat2: sels.c2, cat3: sels.c3, folder: f, q: q,
                sort: els.sort.value, order: els.order.value
            });
            try {
                const r = await fetch(`/api/search?${params}`);
                if(r.status === 401) return window.location.href = '/login';
                const d = await r.json();
                els.gal.innerHTML = '';
                if(d.length === 0) els.gal.innerHTML = '<p style="grid-column:span 4; text-align:center; color:#888;">ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</p>';
                
                d.forEach(img => {
                    const name = img.title.split('/').pop();
                    const div = document.createElement('div'); div.className = 'image-item';
                    
                    // â˜…ä¿®æ­£: PDFã‹ç”»åƒã‹ã§è¡¨ç¤ºã‚’åˆ†ã‘ã‚‹
                    if (img.url.toLowerCase().endsWith('.pdf')) {
                        // PDFã®å ´åˆ: ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º (Lightboxå¯¾è±¡å¤–)
                        div.innerHTML = `<a href="${img.url}" target="_blank" class="pdf-icon">ğŸ“„ PDF<br><span style="font-size:0.6em; font-weight:normal;">${name}</span></a>`;
                    } else {
                        // ç”»åƒã®å ´åˆ: ä»¥å‰ã¨åŒã˜
                        div.innerHTML = `<a href="${img.url}" class="lightbox-link"><img src="${img.url}" class="gallery-image" alt="${name}" title="${name}"></a>`;
                    }
                    els.gal.appendChild(div);
                });
                
                if(lightbox) lightbox.destroy();
                // â˜…ä¿®æ­£: Lightboxã¯ç”»åƒã‚¯ãƒ©ã‚¹ã®ã¿å¯¾è±¡ã«ã™ã‚‹
                lightbox = new SimpleLightbox('#image-gallery-container .lightbox-link', {captionsData:'title'});
                els.csv.style.visibility = 'visible';
                els.csv.href = `/download-csv?folder=${f}&cat1=${sels.c1}&cat2=${sels.c2}&cat3=${sels.c3}`;
                els.csvStat.textContent = `(ãƒ•ã‚©ãƒ«ãƒ€é¸æŠæ¸ˆ)`;
            } catch(e) { els.gal.innerHTML = '<p style="color:red">èª­ã¿è¾¼ã¿å¤±æ•—</p>'; }
        }

        async function uploadFiles() {
            const c1 = els.c1.value==='_new_' ? els.c1n.value : els.c1.value;
            const c2 = els.c2.value==='_new_' ? els.c2n.value : els.c2.value;
            const c3 = els.c3.value==='_new_' ? els.c3n.value : els.c3.value;
            const f = els.folder.value;
            if(!c1 || !c2 || !c3 || !f) return alert('ã‚«ãƒ†ã‚´ãƒªã¨ãƒ•ã‚©ãƒ«ãƒ€åã¯å¿…é ˆã§ã™');
            if(els.file.files.length === 0) return alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');

            const fd = new FormData();
            fd.append('category1', c1); fd.append('category2', c2); fd.append('category3', c3); fd.append('folderName', f);
            for(let file of els.file.files) fd.append('imageFiles', file);

            els.stat.innerText = "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."; els.stat.style.color = "blue";
            try {
                const r = await fetch('/upload', { method: 'POST', body: fd });
                if(r.status === 401) return window.location.href = '/login';
                if(!r.ok) throw new Error('Upload failed');
                els.stat.innerText = "å®Œäº†ã—ã¾ã—ãŸï¼"; els.stat.style.color = "green";
                els.file.value = ''; els.info.innerText = 'æœªé¸æŠ';
                if(sels.c1) loadCat1();
            } catch(e) { els.stat.innerText = "å¤±æ•—ã—ã¾ã—ãŸ"; els.stat.style.color = "red"; }
        }

        async function deleteFolder(name) {
            if(!confirm(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${name}ã€å†…ã®ç”»åƒã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            try {
                const r = await fetch(`/api/folder/${encodeURIComponent(name)}`, { method: 'DELETE' });
                if(r.ok) { alert('å‰Šé™¤ã—ã¾ã—ãŸ'); loadFolder(sels.c1, sels.c2, sels.c3); }
            } catch(e) { alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼'); }
        }

        function resetUI(level) {
            if(level<=1) { els.c1.value=''; document.getElementById('cat2-container').innerHTML='<h4>ä¸­ã‚«ãƒ†ã‚´ãƒª</h4>'; sels.c1=null; }
            if(level<=2) { els.c2.value=''; document.getElementById('cat3-container').innerHTML='<h4>å°ã‚«ãƒ†ã‚´ãƒª</h4>'; sels.c2=null; }
            if(level<=3) { els.c3.value=''; document.getElementById('folder-container').innerHTML='<h4>ãƒ•ã‚©ãƒ«ãƒ€</h4>'; sels.c3=null; }
            if(level<=4) { els.folder.value='default_folder'; els.gal.innerHTML=''; els.searchSec.style.display='none'; els.csv.style.visibility='hidden'; els.csvStat.innerText=''; sels.f=null; }
        }
        function setupDropZone() {
            els.drop.ondragover = e => { e.preventDefault(); els.drop.classList.add('drag-over'); };
            els.drop.ondragleave = () => els.drop.classList.remove('drag-over');
            els.drop.ondrop = e => { e.preventDefault(); els.drop.classList.remove('drag-over'); els.file.files = e.dataTransfer.files; els.info.textContent = `${els.file.files.length} ãƒ•ã‚¡ã‚¤ãƒ«`; };
            els.file.onchange = () => els.info.textContent = `${els.file.files.length} ãƒ•ã‚¡ã‚¤ãƒ«`;
        }
        function setupSelects() {
            const h = (sel, inp, level) => { 
                checkNew(sel, inp); 
                if(sel.value !== '_new_') { if(level===1) loadCat2(sel.value); if(level===2) loadCat3(sels.c1, sel.value); }
            };
            els.c1.onchange = () => h(els.c1, els.c1n, 1);
            els.c2.onchange = () => h(els.c2, els.c2n, 2);
            els.c3.onchange = () => checkNew(els.c3, els.c3n);
        }
        function checkNew(sel, inp) { inp.style.display = sel.value === '_new_' ? 'block' : 'none'; }
        function debounce(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }
    </script>
</body>
</html>