<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>画像アップローダー</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <style>
        body { font-family: sans-serif; padding: 1em 2em; }
        #auth-status { position: fixed; top: 10px; right: 20px; background: #fff; padding: 5px 10px; border: 1px solid #ccc; border-radius: 5px; z-index: 100; }
        #auth-status button { margin-left: 10px; background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        input, select { padding: 5px; margin-bottom: 5px; width: 95%; }
        button { padding: 5px 10px; cursor: pointer; }
        #upload-section { background: #f9f9f9; padding: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; border-radius: 8px; }
        #dropZone { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-top: 10px; }
        #dropZone.drag-over { background-color: #e9ecef; }
        .gallery-column { border: 1px solid #eee; padding: 10px; min-height: 200px; max-height: 400px; overflow-y: auto; }
        .gallery-item { padding: 5px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .gallery-item.active { background-color: #007bff; color: white; }
        #image-gallery-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
        .gallery-image { width: 100%; height: 130px; object-fit: cover; }
    </style>
</head>
<body>
    <div id="auth-status">
        <span id="username-display">確認中...</span>
        <button id="logoutButton">ログアウト</button>
    </div>

    <h3>画像アップロード</h3>
    <div id="upload-section">
        <div><label>1. 大カテゴリ</label><select id="cat1Select"></select><input type="text" id="cat1NewInput" style="display:none;" placeholder="新規"></div>
        <div><label>2. 中カテゴリ</label><select id="cat2Select"></select><input type="text" id="cat2NewInput" style="display:none;" placeholder="新規"></div>
        <div><label>3. 小カテゴリ</label><select id="cat3Select"></select><input type="text" id="cat3NewInput" style="display:none;" placeholder="新規"></div>
        <div><label>4. フォルダ名</label><input type="text" id="folderInput" value="default_folder"></div>
        <div style="grid-column: span 2;">
            <div id="dropZone">ここにファイルをドロップ <input type="file" id="imageInput" multiple style="display:none;"> <button onclick="document.getElementById('imageInput').click()">選択</button> <span id="fileInfo"></span></div>
            <button id="uploadButton" style="margin-top:10px;">アップロード</button>
        </div>
        <p id="uploadStatus" style="grid-column: span 3;"></p>
    </div>
    
    <hr>
    <h3>ギャラリー <a href="#" id="csvButton" style="font-size:12px; display:none;">CSVダウンロード</a></h3>
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
        <div id="cat1-container" class="gallery-column"><h4>大</h4></div>
        <div id="cat2-container" class="gallery-column"><h4>中</h4></div>
        <div id="cat3-container" class="gallery-column"><h4>小</h4></div>
        <div id="folder-container" class="gallery-column"><h4>フォルダ</h4></div>
    </div>
    
    <div style="margin-top: 10px;">
        <input type="search" id="searchInput" placeholder="検索..." style="width: 300px;">
    </div>
    <div id="image-gallery-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js"></script>
    <script>
        // 認証チェック
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/auth/check');
                const data = await res.json();
                if (data.loggedIn) {
                    document.getElementById('username-display').textContent = `User: ${data.username}`;
                    initApp();
                } else {
                    window.location.href = '/login';
                }
            } catch (e) { window.location.href = '/login'; }
        });

        document.getElementById('logoutButton').addEventListener('click', async () => {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        });

        // --- アプリ本体 ---
        const els = {
            file: document.getElementById('imageInput'),
            c1: document.getElementById('cat1Select'), c1n: document.getElementById('cat1NewInput'),
            c2: document.getElementById('cat2Select'), c2n: document.getElementById('cat2NewInput'),
            c3: document.getElementById('cat3Select'), c3n: document.getElementById('cat3NewInput'),
            folder: document.getElementById('folderInput'),
            upBtn: document.getElementById('uploadButton'), stat: document.getElementById('uploadStatus'),
            gal: document.getElementById('image-gallery-container'),
            drop: document.getElementById('dropZone'), info: document.getElementById('fileInfo'),
            csv: document.getElementById('csvButton'), search: document.getElementById('searchInput')
        };
        let sels = { c1: null, c2: null, c3: null, f: null };
        let lightbox;

        function initApp() {
            loadList('/api/cat1', 'cat1-container', (v) => { sels.c1=v; loadCat2(v); els.c1.value=v; checkNew(els.c1, els.c1n); });
            loadOpts('/api/cat1', els.c1);
            
            els.drop.ondragover = e => { e.preventDefault(); els.drop.classList.add('drag-over'); };
            els.drop.ondragleave = () => els.drop.classList.remove('drag-over');
            els.drop.ondrop = e => { e.preventDefault(); els.drop.classList.remove('drag-over'); els.file.files = e.dataTransfer.files; els.info.textContent = `${els.file.files.length} files`; };
            els.file.onchange = () => els.info.textContent = `${els.file.files.length} files`;

            const checkNew = (sel, inp) => inp.style.display = sel.value === '_new_' ? 'block' : 'none';
            els.c1.onchange = () => { checkNew(els.c1, els.c1n); if(els.c1.value !== '_new_') loadCat2(els.c1.value); };
            els.c2.onchange = () => { checkNew(els.c2, els.c2n); if(els.c2.value !== '_new_') loadCat3(sels.c1, els.c2.value); };
            els.c3.onchange = () => checkNew(els.c3, els.c3n);

            els.upBtn.onclick = async () => {
                const fd = new FormData();
                fd.append('category1', els.c1.value==='_new_'?els.c1n.value:els.c1.value);
                fd.append('category2', els.c2.value==='_new_'?els.c2n.value:els.c2.value);
                fd.append('category3', els.c3.value==='_new_'?els.c3n.value:els.c3.value);
                fd.append('folderName', els.folder.value);
                for(let f of els.file.files) fd.append('imageFiles', f);
                els.stat.innerText = "Uploading...";
                try {
                    const r = await fetch('/upload', {method:'POST', body:fd});
                    if(!r.ok) throw new Error((await r.json()).message);
                    els.stat.innerText = "Success"; location.reload();
                } catch(e) { els.stat.innerText = "Error: "+e.message; }
            };
            
            let timer;
            els.search.oninput = () => { clearTimeout(timer); timer = setTimeout(() => loadImages(sels.f, els.search.value), 500); };
        }

        async function loadList(url, id, cb) {
            const div = document.getElementById(id); div.innerHTML = '<h4>Loading...</h4>';
            try {
                const r = await fetch(url); const d = await r.json();
                div.innerHTML = `<h4>${id.split('-')[0]}</h4>`;
                if(d.length===0) div.innerHTML+='<p>None</p>';
                d.forEach(v => {
                    const el = document.createElement('div'); el.className='gallery-item'; el.innerText=v;
                    el.onclick = () => { 
                        div.querySelectorAll('.gallery-item').forEach(x=>x.classList.remove('active')); 
                        el.classList.add('active'); cb(v); 
                    };
                    div.appendChild(el);
                });
            } catch(e) { div.innerHTML = 'Error'; }
        }
        
        async function loadOpts(url, sel) {
            const r = await fetch(url); const d = await r.json();
            sel.innerHTML = '<option value="">Select</option>';
            d.forEach(v => sel.innerHTML += `<option value="${v}">${v}</option>`);
            sel.innerHTML += '<option value="_new_">+ New</option>';
        }

        const loadCat2 = (c1) => { sels.c1=c1; loadList(`/api/cat2/${c1}`, 'cat2-container', v=>{sels.c2=v; loadCat3(c1,v); els.c2.value=v;}); loadOpts(`/api/cat2/${c1}`, els.c2); };
        const loadCat3 = (c1,c2) => { sels.c2=c2; loadList(`/api/cat3/${c1}/${c2}`, 'cat3-container', v=>{sels.c3=v; loadF(c1,c2,v); els.c3.value=v;}); loadOpts(`/api/cat3/${c1}/${c2}`, els.c3); };
        const loadF = (c1,c2,c3) => { sels.c3=c3; loadList(`/api/folders/${c1}/${c2}/${c3}`, 'folder-container', v=>{sels.f=v; els.folder.value=v; loadImages(v);}); };

        async function loadImages(f, q='') {
            if(!f) return;
            els.gal.innerHTML = 'Loading...';
            const u = `/api/search?cat1=${sels.c1}&cat2=${sels.c2}&cat3=${sels.c3}&folder=${f}&q=${q}`;
            const r = await fetch(u); const d = await r.json();
            els.gal.innerHTML = '';
            d.forEach(img => {
                const div = document.createElement('div');
                div.innerHTML = `<a href="${img.url}"><img src="${img.url}" class="gallery-image" title="${img.title}"></a>`;
                els.gal.appendChild(div);
            });
            if(lightbox) lightbox.destroy();
            lightbox = new SimpleLightbox('#image-gallery-container a');
            els.csv.style.display = 'inline';
            els.csv.href = `/download-csv?folder=${f}&cat1=${sels.c1}&cat2=${sels.c2}&cat3=${sels.c3}`;
        }
    </script>
</body>
</html>