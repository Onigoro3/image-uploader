<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body { font-family: "Helvetica Neue", Arial, sans-serif; line-height: 1.6; padding: 10px; margin: 0; background-color: #f0fdf4; color: #333; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        #auth-status { 
            position: fixed; top: 0; left: 0; width: 100%; background: #fff; padding: 10px 20px; 
            border-bottom: 1px solid #bbf7d0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 1000; 
            display: flex; justify-content: flex-end; align-items: center; box-sizing: border-box;
        }
        #username-display { margin-right: 15px; font-weight: bold; color: #166534; font-size: 0.9rem; }
        #auth-status button { 
            color: white; border: none; padding: 6px 12px; border-radius: 4px; 
            cursor: pointer; margin-left: 8px; font-size: 0.85rem; transition: opacity 0.2s;
        }
        #auth-status button:hover { opacity: 0.9; }
        #manager-btn { background: #15803d; }
        #personal-btn { background: #0ea5e9; }
        #logoutButton { background: #dc2626; }
        #fix-db-btn { background: #ca8a04; color: #fff !important; }

        #main-content { margin-top: 70px; max-width: 1200px; margin-left: auto; margin-right: auto; }
        
        /* ãƒ‘ãƒãƒ« */
        .panel { 
            background: #fff; padding: 20px; border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; 
            border: 1px solid #e2e8f0;
        }
        h3 { 
            color: #166534; border-bottom: 2px solid #bbf7d0; 
            padding-bottom: 10px; margin-top: 0; margin-bottom: 20px; font-size: 1.1rem;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        input[type="text"], input[type="search"], select { 
            padding: 10px; border: 1px solid #ccc; border-radius: 6px; 
            width: 100%; box-sizing: border-box; margin-bottom: 10px; font-size: 16px;
        }
        button { border: none; font-weight: bold; cursor: pointer; border-radius: 6px; }

        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
        #upload-section { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        #upload-section label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em; color: #166534; }
        #uploadStatus { font-weight: bold; grid-column: span 3; margin-top: 10px; text-align: center; }
        #dropZone { 
            border: 2px dashed #bbf7d0; padding: 30px; text-align: center; background: #f0fdf4; 
            border-radius: 8px; cursor: pointer; transition: all 0.2s; color: #166534;
        }
        #dropZone:hover { background-color: #dcfce7; border-color: #15803d; }
        #uploadButton { 
            margin-top: 15px; width: 100%; background: #15803d; color: white; padding: 12px; 
            font-size: 1rem; transition: background 0.2s;
        }

        /* ã‚«ãƒ†ã‚´ãƒªä½œæˆã‚¨ãƒªã‚¢ï¼ˆGalleryå†…ï¼‰ */
        .cat-creation-area {
            background: #f0f9ff; border: 1px solid #bae6fd; padding: 10px; border-radius: 6px; margin-bottom: 15px;
            display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;
        }
        .cat-creation-area .input-group { display: flex; flex-direction: column; flex: 1; min-width: 120px; }
        .cat-creation-area label { font-size: 0.8em; font-weight: bold; color: #0284c7; margin-bottom: 2px; }
        .cat-creation-area input { margin-bottom: 0; padding: 6px; font-size: 0.9em; }
        .cat-creation-area button { padding: 8px 15px; background: #0ea5e9; color: white; font-size: 0.9em; height: 36px; }

        /* ã‚®ãƒ£ãƒ©ãƒªãƒ¼é¸æŠ (4ã‚«ãƒ©ãƒ ) */
        #gallery-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .gallery-column { border: 1px solid #e2e8f0; padding: 0; border-radius: 6px; background: #f8fafc; height: 250px; overflow-y: auto; }
        .gallery-column h4 { 
            margin: 0; padding: 8px; background: #e2e8f0; border-bottom: 1px solid #cbd5e1; 
            font-size: 0.85em; text-align: center; color: #475569; position: sticky; top: 0; z-index: 10;
        }
        
        /* ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆç·¨é›†ãƒœã‚¿ãƒ³ä»˜ãï¼‰ */
        .gallery-item { 
            padding: 8px 10px; border-bottom: 1px solid #f1f5f9; cursor: pointer; font-size: 14px; 
            transition: background 0.1s; background: #fff; display: flex; justify-content: space-between; align-items: center;
        }
        .gallery-item:hover { background-color: #f0fdf4; }
        .gallery-item.active { background-color: #15803d; color: white; }
        .gallery-item.active .edit-btn { color: #fff; } /* é¸æŠä¸­ã¯ç™½ã */

        .edit-btn { background: none; border: none; cursor: pointer; color: #cbd5e1; font-size: 1.1em; padding: 0 5px; line-height: 1; }
        .edit-btn:hover { color: #f59e0b; }
        
        /* å‰Šé™¤ãƒœã‚¿ãƒ³ */
        .action-buttons button { background: #dc3545; color: white; border: none; border-radius: 3px; width: 20px; height: 20px; line-height: 20px; font-size: 12px; padding: 0; cursor: pointer; margin-left:5px; }

        /* æ¤œç´¢ãƒ»ä¸€è¦§ */
        #search-section { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        #image-gallery-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        
        .image-item { 
            border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; overflow: hidden; 
            position: relative; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column;
        }
        .image-item:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .img-wrapper { width: 100%; aspect-ratio: 1/1; background: #f8fafc; position: relative; }
        .gallery-image { width: 100%; height: 100%; object-fit: contain; display: block; }
        .pdf-icon { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fff1f2; color: #e11d48; font-weight: bold; text-decoration: none; }

        /* å•†å“æƒ…å ± */
        .product-info { padding: 10px; font-size: 0.85rem; border-top: 1px solid #f0f0f0; background: #fff; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .p-name { font-weight: bold; color: #1e293b; line-height: 1.4; margin-bottom: 5px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        
        .p-model-container { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
        .model-badge { 
            background: #f1f5f9; border: 1px solid #cbd5e1; color: #475569; 
            padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; 
            white-space: nowrap; 
        }

        .p-stats { display: flex; justify-content: space-between; align-items: flex-end; font-size: 0.8rem; }
        .stock-ok { color: #15803d; font-weight: bold; }
        .stock-ng { color: #dc2626; background: #fee2e2; padding: 1px 5px; border-radius: 3px; }
        .price-val { font-weight: bold; font-size: 1rem; color: #0f172a; }

        #csvDownloader { color: #15803d; font-size: 0.85em; text-decoration: underline; margin-left: 10px; cursor: pointer; }
        .sl-wrapper .sl-caption { display: block !important; opacity: 1 !important; background: rgba(0,0,0,0.85) !important; color: #fff !important; padding: 15px !important; bottom: 0 !important; position: fixed !important; width: 100% !important; text-align: center !important; z-index: 999999 !important; pointer-events: none; }

        @media (max-width: 768px) {
            #upload-section { grid-template-columns: 1fr; }
            #gallery-section { grid-template-columns: 1fr 1fr; }
            #image-gallery-container { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
        }
    </style>
</head>
<body>
    <div id="auth-status">
        <span id="username-display">...</span>
        <button id="fix-db-btn" title="ãƒ†ãƒ¼ãƒ–ãƒ«ä¿®å¾©">âš ï¸DBä¿®å¾©</button>
        <button id="manager-btn" onclick="location.href='/product-manager'">å•†å“ç®¡ç†</button>
        <button id="personal-btn" onclick="location.href='/personal'">å€‹äººã‚¢ãƒ«ãƒãƒ </button>
        <button id="logoutButton">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div id="main-content">
        <div class="panel">
            <h3>ğŸ“¤ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
            <div id="upload-section">
                <div><label>1. å¤§ã‚«ãƒ†ã‚´ãƒª</label><select id="cat1Select"></select><input type="text" id="cat1NewInput" class="new-input" style="display:none" placeholder="æ–°è¦"></div>
                <div><label>2. ä¸­ã‚«ãƒ†ã‚´ãƒª</label><select id="cat2Select"></select><input type="text" id="cat2NewInput" class="new-input" style="display:none" placeholder="æ–°è¦"></div>
                <div><label>3. å°ã‚«ãƒ†ã‚´ãƒª</label><select id="cat3Select"></select><input type="text" id="cat3NewInput" class="new-input" style="display:none" placeholder="æ–°è¦"></div>
                <div><label>4. ãƒ•ã‚©ãƒ«ãƒ€å</label><input type="text" id="folderInput" value="default_folder"></div>
                <div style="grid-column: span 2;">
                    <label>5. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</label>
                    <div id="dropZone" onclick="document.getElementById('imageInput').click()">
                        ğŸ“‚ ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<br><span style="font-size:0.85em; color:#166534;">(ç”»åƒ / PDF)</span>
                        <input type="file" id="imageInput" accept="image/*,.pdf" multiple style="display: none;">
                        <div id="fileInfo" style="margin-top:5px; font-weight:bold; color:#15803d;">æœªé¸æŠ</div>
                    </div>
                    <button id="uploadButton">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹</button>
                </div>
                <p id="uploadStatus"></p>
            </div>
        </div>

        <div class="panel">
            <h3>ğŸ–¼ï¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ»æ¤œç´¢ãƒ»ã‚«ãƒ†ã‚´ãƒªç®¡ç† <a href="#" id="csvDownloader" style="display:none;">[ç¾åœ¨ã®ä¸€è¦§ã‚’CSVä¿å­˜]</a></h3>
            
            <div class="cat-creation-area">
                <div class="input-group">
                    <label>å¤§ã‚«ãƒ†ã‚´ãƒª (å¿…é ˆ)</label>
                    <input type="text" id="newC1" placeholder="ä¾‹: ãƒã‚±ã‚«">
                </div>
                <div class="input-group">
                    <label>ä¸­ã‚«ãƒ†ã‚´ãƒª</label>
                    <input type="text" id="newC2" placeholder="ä¾‹: BOX">
                </div>
                <div class="input-group">
                    <label>å°ã‚«ãƒ†ã‚´ãƒª</label>
                    <input type="text" id="newC3" placeholder="ä¾‹: 151">
                </div>
                <button id="createCatBtn">ç©ºã‚«ãƒ†ã‚´ãƒªä½œæˆ</button>
            </div>

            <div id="search-section">
                <input type="search" id="searchInput" placeholder="å•†å“åã€å‹ç•ªã€ãƒ•ã‚¡ã‚¤ãƒ«åã§æ¤œç´¢..." style="flex-grow:1; margin-bottom:0;">
                <select id="sortBy" style="width:auto; margin-bottom:0;"><option value="created_at">ç™»éŒ²æ—¥é †</option><option value="title">åå‰é †</option></select>
                <select id="sortOrder" style="width:auto; margin-bottom:0;"><option value="DESC">æ–°ã—ã„é †</option><option value="ASC">å¤ã„é †</option></select>
            </div>

            <div id="gallery-section">
                <div id="cat1-container" class="gallery-column"><h4>å¤§ã‚«ãƒ†ã‚´ãƒª</h4></div>
                <div id="cat2-container" class="gallery-column"><h4>ä¸­ã‚«ãƒ†ã‚´ãƒª</h4></div>
                <div id="cat3-container" class="gallery-column"><h4>å°ã‚«ãƒ†ã‚´ãƒª</h4></div>
                <div id="folder-container" class="gallery-column"><h4>ãƒ•ã‚©ãƒ«ãƒ€</h4></div>
            </div>
            
            <hr>
            <div id="image-gallery-container"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/auth/check');
                const data = await res.json();
                if (data.loggedIn) {
                    document.getElementById('username-display').textContent = `User: ${data.username}`;
                    initApp();
                } else { window.location.href = '/login'; }
            } catch (e) { window.location.href = '/login'; }
        });

        document.getElementById('logoutButton').addEventListener('click', async () => { await fetch('/api/auth/logout', { method: 'POST' }); window.location.href = '/login'; });
        document.getElementById('fix-db-btn').addEventListener('click', async () => { if(!confirm('DBä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return; try { await fetch('/api/admin/init-db', { method: 'POST' }); alert('å®Œäº†'); location.reload(); } catch(e){alert('Error');} });

        const els = {
            file: document.getElementById('imageInput'),
            // Upload Selects
            c1: document.getElementById('cat1Select'), c1n: document.getElementById('cat1NewInput'),
            c2: document.getElementById('cat2Select'), c2n: document.getElementById('cat2NewInput'),
            c3: document.getElementById('cat3Select'), c3n: document.getElementById('cat3NewInput'),
            // New Category Inputs
            newC1: document.getElementById('newC1'), newC2: document.getElementById('newC2'), newC3: document.getElementById('newC3'),
            createBtn: document.getElementById('createCatBtn'),
            // Gallery Containers
            c1Box: document.getElementById('cat1-container'), c2Box: document.getElementById('cat2-container'), c3Box: document.getElementById('cat3-container'), fBox: document.getElementById('folder-container'),
            
            folder: document.getElementById('folderInput'),
            upBtn: document.getElementById('uploadButton'), stat: document.getElementById('uploadStatus'),
            drop: document.getElementById('dropZone'), info: document.getElementById('fileInfo'),
            gal: document.getElementById('image-gallery-container'), csv: document.getElementById('csvDownloader'),
            search: document.getElementById('searchInput'), sort: document.getElementById('sortBy'), order: document.getElementById('sortOrder'),
        };
        let sels = { c1: null, c2: null, c3: null, f: null };
        let lightbox;

        function initApp() {
            // Load initial lists (Use type=all to see empty categories too)
            loadCat1(); 
            setupDropZone(); 
            setupSelects();
            
            els.upBtn.onclick = uploadFiles;
            els.search.oninput = debounce(() => loadImages(sels.f, els.search.value), 500);
            els.sort.onchange = els.order.onchange = () => loadImages(sels.f, els.search.value);

            // New: Category Creation
            els.createBtn.onclick = createCategoryOnly;
        }

        // --- ã‚«ãƒ†ã‚´ãƒªä½œæˆ (ç©ºç®±) ---
        async function createCategoryOnly() {
            const c1 = els.newC1.value.trim();
            const c2 = els.newC2.value.trim() || '-';
            const c3 = els.newC3.value.trim() || '-';
            
            if(!c1) return alert('å¤§ã‚«ãƒ†ã‚´ãƒªã¯å¿…é ˆã§ã™');

            try {
                const r = await fetch('/api/categories/create', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ category1: c1, category2: c2, category3: c3 })
                });
                const d = await r.json();
                if(r.ok) {
                    alert('ä½œæˆã—ã¾ã—ãŸ');
                    els.newC1.value = ''; els.newC2.value = ''; els.newC3.value = '';
                    loadCat1(); // Reload lists
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + d.message);
                }
            } catch(e) { alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼'); }
        }

        // --- ã‚«ãƒ†ã‚´ãƒªåç§°å¤‰æ›´ (Rename) ---
        async function renameCategory(level, oldName) {
            const newName = prompt(`ã€Œ${oldName}ã€ã®æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, oldName);
            if(!newName || newName === oldName) return;

            let url = '';
            if(level === 1) url = `/api/cat1/${encodeURIComponent(oldName)}`;
            if(level === 2) url = `/api/cat2/${encodeURIComponent(sels.c1)}/${encodeURIComponent(oldName)}`;
            if(level === 3) url = `/api/cat3/${encodeURIComponent(sels.c1)}/${encodeURIComponent(sels.c2)}/${encodeURIComponent(oldName)}`;
            if(level === 4) url = `/api/folder/${encodeURIComponent(oldName)}`; // Folder Rename

            try {
                const r = await fetch(url, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ newName: newName, folderName: newName }) // folder uses body.newName usually
                });
                if(r.ok) {
                    alert('å¤‰æ›´ã—ã¾ã—ãŸ');
                    // Reload appropriate level
                    if(level===1) loadCat1();
                    else if(level===2) loadCat2(sels.c1);
                    else if(level===3) loadCat3(sels.c1, sels.c2);
                    else if(level===4) loadFolder(sels.c1, sels.c2, sels.c3);
                } else { alert('å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
            } catch(e) { alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼'); }
        }

        // --- ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ (Uploadç”¨Selectã¨Galleryç”¨Divã‚’åŒæ™‚ã«æ›´æ–°) ---
        // type=all ã‚’ä½¿ã£ã¦ç©ºã‚«ãƒ†ã‚´ãƒªã‚‚å«ã‚ã¦è¡¨ç¤ºã™ã‚‹
        const loadCat1 = () => { 
            resetUI(1); 
            // Selectç”¨
            loadOpts('/api/cat1?type=all', els.c1); 
            // Galleryç”¨
            loadList('/api/cat1?type=all', els.c1Box, 'å¤§ã‚«ãƒ†ã‚´ãƒª', (v) => { 
                sels.c1=v; els.c1.value=v; // Sync selection
                checkNew(els.c1, els.c1n); 
                // Auto-fill creation inputs
                els.newC1.value = v; 
                loadCat2(v); 
            }, 1); 
        };

        const loadCat2 = (c1) => { 
            resetUI(2); 
            loadOpts(`/api/cat2/${encodeURIComponent(c1)}?type=all`, els.c2);
            loadList(`/api/cat2/${encodeURIComponent(c1)}?type=all`, els.c2Box, 'ä¸­ã‚«ãƒ†ã‚´ãƒª', (v) => { 
                sels.c2=v; els.c2.value=v; 
                checkNew(els.c2, els.c2n); 
                els.newC2.value = v;
                loadCat3(c1,v); 
            }, 2); 
        };

        const loadCat3 = (c1,c2) => { 
            resetUI(3); 
            loadOpts(`/api/cat3/${encodeURIComponent(c1)}/${encodeURIComponent(c2)}?type=all`, els.c3);
            loadList(`/api/cat3/${encodeURIComponent(c1)}/${encodeURIComponent(c2)}?type=all`, els.c3Box, 'å°ã‚«ãƒ†ã‚´ãƒª', (v) => { 
                sels.c3=v; els.c3.value=v; 
                checkNew(els.c3, els.c3n); 
                els.newC3.value = v;
                loadFolder(c1,c2,v); 
            }, 3); 
        };

        const loadFolder = (c1,c2,c3) => { 
            resetUI(4); 
            loadList(`/api/folders/${encodeURIComponent(c1)}/${encodeURIComponent(c2)}/${encodeURIComponent(c3)}`, els.fBox, 'ãƒ•ã‚©ãƒ«ãƒ€', (v) => { 
                sels.f=v; els.folder.value=v; 
                loadImages(v); 
            }, 4, true); // true = can delete folder
        };

        // Galleryãƒªã‚¹ãƒˆç”Ÿæˆ (ç·¨é›†ãƒœã‚¿ãƒ³ä»˜ã)
        async function loadList(u, container, t, cb, level, canDelete=false) {
            container.innerHTML = `<h4>${t}</h4>`;
            try {
                const r = await fetch(u); const j = await r.json();
                const filtered = j.filter(v => v !== 'default_cat1' && v !== 'default_cat2' && v !== 'default_cat3' && v !== '-' && v !== '__CATEGORY_NODE__');
                
                if(filtered.length===0) container.innerHTML += '<p style="padding:10px; color:#ccc; text-align:center;">(ãªã—)</p>';
                
                filtered.forEach(v => {
                    const e = document.createElement('div'); e.className = 'gallery-item';
                    
                    const span = document.createElement('span');
                    span.innerText = v;
                    span.style.flexGrow = '1';

                    const actions = document.createElement('div');
                    actions.className = 'item-actions';
                    
                    // Edit Button (Pencil)
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-btn'; editBtn.innerHTML = 'âœ'; 
                    editBtn.title = 'åç§°å¤‰æ›´';
                    editBtn.onclick = (ev) => { ev.stopPropagation(); renameCategory(level, v); };
                    actions.appendChild(editBtn);

                    // Delete Button (Only for folders currently supported by backend safely)
                    if(canDelete) {
                        const delBtn = document.createElement('button');
                        delBtn.style.color='red'; delBtn.innerHTML='Ã—';
                        delBtn.style.background='none'; delBtn.style.border='none'; delBtn.style.cursor='pointer';
                        delBtn.onclick = (ev) => { ev.stopPropagation(); deleteFolder(v); };
                        actions.appendChild(delBtn);
                    }

                    e.appendChild(span);
                    e.appendChild(actions);

                    e.onclick = () => { 
                        container.querySelectorAll('.gallery-item').forEach(x => x.classList.remove('active')); 
                        e.classList.add('active'); 
                        cb(v); 
                    };
                    container.appendChild(e);
                });
            } catch(e) { container.innerHTML += '<p style="color:red;">Error</p>'; }
        }

        async function loadImages(f, q='') {
            if(!f && !q) return;
            els.gal.innerHTML = '<p style="grid-column:span 4; text-align:center; color:#666;">èª­ã¿è¾¼ã¿ä¸­...<\/p>';
            const p = new URLSearchParams({ cat1: sels.c1||'', cat2: sels.c2||'', cat3: sels.c3||'', folder: f||'', q: q, sort: els.sort.value, order: els.order.value });
            try {
                const r = await fetch(`/api/search?${p}`); const d = await r.json();
                els.gal.innerHTML = d.length ? '' : '<p style="grid-column:span 4; text-align:center; color:#888;">è©²å½“ãªã—<\/p>';
                d.forEach(img => {
                    const div = document.createElement('div'); div.className = 'image-item';
                    const name = img.title.split('/').pop();
                    let infoHtml = '', captionHtml = '';
                    if(img.product_name) {
                        const stockText = (img.stock > 0) ? `åœ¨åº«:${img.stock}` : `åœ¨åº«åˆ‡`;
                        const stockClass = (img.stock > 0) ? 'stock-ok' : 'stock-ng';
                        const models = [img.model_num1, img.model_num2, img.model_num3, img.model_num4].filter(m => m && m.trim() !== '');
                        const modelHtml = models.length > 0 ? `<div class="p-model-container">${models.map(m => `<span class="model-badge">${m}</span>`).join('')}</div>` : `<div class="p-model-container"><span class="model-badge" style="color:#ccc;">-</span></div>`;
                        const captionModels = models.length > 0 ? models.join(' / ') : '-';
                        infoHtml = `<div class="product-info"><div class="p-name" title="${img.product_name}">${img.product_name}<\/div>${modelHtml}<div class="p-stats"><span class="${stockClass}">${stockText}<\/span><div class="p-prices"><div>EC:<span class="price-val">Â¥${img.ec_price ? img.ec_price.toLocaleString() : '-'}<\/span><\/div><div>ãƒ¡ãƒ«:Â¥${img.mercari_price ? img.mercari_price.toLocaleString() : '-'}<\/div><\/div><\/div><\/div>`;
                        captionHtml = `<div style='text-align:center;'><b style='font-size:1.2em;color:#fff;'>${img.product_name}<\/b><br><span style='font-size:0.9em;color:#ccc;'>${captionModels}<\/span><br><span style='color:${img.stock>0?'#4ade80':'#f87171'};font-weight:bold;'>${stockText}<\/span><br>EC: Â¥${img.ec_price} / ãƒ¡ãƒ«: Â¥${img.mercari_price}<\/div>`;
                    } else {
                        infoHtml = `<div class="product-info" style="color:#999;"><div class="p-name" style="font-weight:normal;">${name}<\/div><div style="margin-top:auto; font-size:0.8em;">æƒ…å ±ãªã—<\/div><\/div>`;
                        captionHtml = `${name}`;
                    }
                    const safeCaption = captionHtml.replace(/"/g, '&quot;');
                    let mediaHtml = img.url.toLowerCase().endsWith('.pdf') ? `<div class="img-wrapper"><a href="${img.url}" target="_blank" class="pdf-icon">ğŸ“„ PDF<br><span style="font-size:0.7em;">${name}<\/span><\/a><\/div>` : `<div class="img-wrapper"><a href="${img.url}" class="lightbox-link" data-caption="${safeCaption}"><img src="${img.url}" class="gallery-image" alt="${name}"><\/a><\/div>`;
                    div.innerHTML = mediaHtml + infoHtml; els.gal.appendChild(div);
                });
                if(lightbox) lightbox.destroy();
                lightbox = new SimpleLightbox('#image-gallery-container .lightbox-link', { captionsData: 'data-caption', captionDelay: 0, captionPosition: 'bottom' });
                els.csv.style.display = f ? 'inline' : 'none';
                if(f) els.csv.href = `/download-csv?folder=${f}&cat1=${sels.c1}&cat2=${sels.c2}&cat3=${sels.c3}`;
            } catch(e) { els.gal.innerHTML = '<p style="color:red;">ã‚¨ãƒ©ãƒ¼<\/p>'; }
        }

        async function deleteFolder(name) {
            if(!confirm(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${name}ã€å†…ã®ç”»åƒã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            try { const r=await fetch(`/api/folder/${encodeURIComponent(name)}`,{method:'DELETE'}); if(r.ok){alert('å‰Šé™¤ã—ã¾ã—ãŸ');loadFolder(sels.c1,sels.c2,sels.c3);} } catch(e){alert('ã‚¨ãƒ©ãƒ¼');}
        }
        
        async function loadOpts(u,s){try{const r=await fetch(u);const j=await r.json();s.innerHTML='<option value="">--<\/option>';j.forEach(v=>{if(v!=='__CATEGORY_NODE__')s.innerHTML+=`<option value="${v}">${v}<\/option>`});s.innerHTML+='<option value="_new_">+æ–°<\/option>';}catch(e){}}
        function resetUI(l){if(l<=1)document.getElementById('cat2-container').innerHTML='<h4>ä¸­ã‚«ãƒ†ã‚´ãƒª<\/h4>';if(l<=2)document.getElementById('cat3-container').innerHTML='<h4>å°ã‚«ãƒ†ã‚´ãƒª<\/h4>';if(l<=3)document.getElementById('folder-container').innerHTML='<h4>ãƒ•ã‚©ãƒ«ãƒ€<\/h4>';if(l<=4)els.gal.innerHTML='';}
        function setupDropZone(){els.drop.ondragover=e=>{e.preventDefault();els.drop.classList.add('drag-over');};els.drop.ondragleave=()=>els.drop.classList.remove('drag-over');els.drop.ondrop=e=>{e.preventDefault();els.drop.classList.remove('drag-over');els.file.files=e.dataTransfer.files;els.info.innerText=els.file.files.length+' Files';};els.file.onchange=()=>els.info.innerText=els.file.files.length+' Files';}
        function setupSelects(){const h=(s,i,l)=>{checkNew(s,i);if(s.value!=='_new_'){if(l===1)loadCat2(s.value);if(l===2)loadCat3(sels.c1,s.value);}};els.c1.onchange=()=>h(els.c1,els.c1n,1);els.c2.onchange=()=>h(els.c2,els.c2n,2);els.c3.onchange=()=>checkNew(els.c3,els.c3n);}
        function checkNew(s,i){i.style.display=s.value==='_new_'?'block':'none';}
        async function uploadFiles(){const fd=new FormData();fd.append('category1',els.c1.value==='_new_'?els.c1n.value:els.c1.value);fd.append('category2',els.c2.value==='_new_'?els.c2n.value:els.c2.value);fd.append('category3',els.c3.value==='_new_'?els.c3n.value:els.c3.value);fd.append('folderName',els.folder.value);for(let f of els.file.files)fd.append('imageFiles',f);els.stat.innerText='UP...';try{const r=await fetch('/upload',{method:'POST',body:fd});if(!r.ok)throw 1;els.stat.innerText='OK';els.file.value='';loadCat1();}catch(e){els.stat.innerText='Err';}}
        function debounce(f,w){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>f.apply(this,a),w);};}
    </script>
</body>
</html>