<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; line-height: 1.6; padding: 10px; margin: 0; background-color: #f4f6f9; color: #333; }
        
        #auth-status { 
            position: fixed; top: 0; left: 0; width: 100%; background: #fff; padding: 10px 20px; 
            border-bottom: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 1000; 
            display: flex; justify-content: flex-end; align-items: center; box-sizing: border-box;
        }
        #username-display { margin-right: 15px; font-weight: bold; color: #555; font-size: 0.9rem; }
        #auth-status button { 
            background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; 
            cursor: pointer; margin-left: 8px; font-size: 0.85rem; transition: background 0.2s;
        }
        #personal-btn { background: #17a2b8 !important; }
        #manager-btn { background: #166534 !important; } /* å•†å“ç®¡ç†ãƒœã‚¿ãƒ³ */
        
        #main-content { margin-top: 70px; max-width: 1200px; margin-left: auto; margin-right: auto; }
        
        /* ãƒ‘ãƒãƒ« */
        .panel { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        button { padding: 10px 20px; border-radius: 5px; font-weight: bold; border: none; cursor: pointer; }

        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
        #upload-section { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        #upload-section label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em; color: #555; }
        #uploadStatus { font-weight: bold; grid-column: span 3; margin-top: 10px; }
        #dropZone { border: 2px dashed #cbd5e0; padding: 30px; text-align: center; background: #f8fafc; border-radius: 6px; cursor: pointer; color: #666; }
        #dropZone:hover { background-color: #eef2ff; border-color: #6366f1; color: #4f46e5; }

        /* ã‚®ãƒ£ãƒ©ãƒªãƒ¼ */
        #gallery-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .gallery-column { border: 1px solid #e2e8f0; padding: 0; border-radius: 6px; background: #fff; height: 250px; overflow-y: auto; }
        .gallery-column h4 { margin: 0; padding: 8px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; font-size: 0.9em; text-align: center; color: #475569; position: sticky; top: 0; }
        .gallery-item { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; font-size: 14px; }
        .gallery-item.active { background-color: #3b82f6; color: white; }

        /* æ¤œç´¢ãƒ»ä¸€è¦§ */
        #search-section { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        #image-gallery-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        
        .image-item { border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; overflow: hidden; position: relative; transition: transform 0.2s; display: flex; flex-direction: column; }
        .image-item:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .img-wrapper { width: 100%; aspect-ratio: 1/1; background: #f1f5f9; position: relative; }
        .gallery-image { width: 100%; height: 100%; object-fit: contain; display: block; }
        .pdf-icon { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fff1f2; color: #e11d48; font-weight: bold; text-decoration: none; }

        .product-info { padding: 10px; font-size: 0.85rem; border-top: 1px solid #e2e8f0; flex-grow: 1; display: flex; flex-direction: column; gap: 4px; }
        .p-name { font-weight: bold; color: #1e293b; line-height: 1.4; }
        .p-model { color: #64748b; font-size: 0.8rem; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; align-self: flex-start; }
        .p-stats { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 8px; border-top: 1px dashed #e2e8f0; }
        .p-stock { font-weight: bold; }
        .stock-ok { color: #059669; } .stock-ng { color: #dc2626; background: #fee2e2; padding: 0 4px; border-radius: 2px; }
        .p-prices { text-align: right; font-size: 0.8rem; color: #475569; }
        .price-val { font-weight: bold; font-size: 1rem; color: #0f172a; }

        /* Lightboxã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ */
        .sl-wrapper .sl-caption { display: block !important; opacity: 1 !important; background: rgba(0,0,0,0.85) !important; color: #fff !important; font-size: 14px !important; padding: 15px !important; bottom: 0 !important; position: fixed !important; width: 100% !important; text-align: center !important; z-index: 999999 !important; pointer-events: none; }

        @media (max-width: 768px) { #upload-section, #gallery-section { grid-template-columns: 1fr; } #gallery-section { grid-template-columns: 1fr 1fr; } #image-gallery-container { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); } }
    </style>
</head>
<body>
    <div id="auth-status">
        <span id="username-display">...</span>
        <button id="manager-btn" onclick="location.href='/product-manager'">å•†å“ç®¡ç†</button>
        <button id="personal-btn" onclick="location.href='/personal'">å€‹äººã‚¢ãƒ«ãƒãƒ </button>
        <button id="logoutButton">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div id="main-content">
        <div class="panel">
            <h3>ğŸ“¤ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
            <div id="upload-section">
                <div><label>1. å¤§ã‚«ãƒ†ã‚´ãƒª</label><select id="cat1Select"></select><input type="text" id="cat1NewInput" style="display:none" placeholder="æ–°è¦"></div>
                <div><label>2. ä¸­ã‚«ãƒ†ã‚´ãƒª</label><select id="cat2Select"></select><input type="text" id="cat2NewInput" style="display:none" placeholder="æ–°è¦"></div>
                <div><label>3. å°ã‚«ãƒ†ã‚´ãƒª</label><select id="cat3Select"></select><input type="text" id="cat3NewInput" style="display:none" placeholder="æ–°è¦"></div>
                <div><label>4. ãƒ•ã‚©ãƒ«ãƒ€å</label><input type="text" id="folderInput" value="default_folder"></div>
                <div style="grid-column: span 2;">
                    <label>5. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</label>
                    <div id="dropZone" onclick="document.getElementById('imageInput').click()">
                        ğŸ“‚ ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<br><span style="font-size:0.85em;">(ç”»åƒ / PDF)</span>
                        <input type="file" id="imageInput" accept="image/*,.pdf" multiple style="display: none;">
                        <div id="fileInfo" style="margin-top:5px; font-weight:bold; color:#3b82f6;">æœªé¸æŠ</div>
                    </div>
                    <button id="uploadButton" style="margin-top: 10px; width:100%; background:#10b981; color:white;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹</button>
                </div>
                <p id="uploadStatus"></p>
            </div>
        </div>

        <div class="panel">
            <h3>ğŸ–¼ï¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ»æ¤œç´¢ <a href="#" id="csvDownloader" style="font-size:0.8em; margin-left:10px; display:none;">[ç¾åœ¨ã®ä¸€è¦§ã‚’CSVä¿å­˜]</a></h3>
            
            <div id="search-section">
                <input type="search" id="searchInput" placeholder="å•†å“åã€å‹ç•ªã€ãƒ•ã‚¡ã‚¤ãƒ«åã§æ¤œç´¢..." style="flex-grow:1; margin-bottom:0;">
                <select id="sortBy" style="width:auto; margin-bottom:0;"><option value="created_at">ç™»éŒ²æ—¥é †</option><option value="title">åå‰é †</option></select>
                <select id="sortOrder" style="width:auto; margin-bottom:0;"><option value="DESC">æ–°ã—ã„é †</option><option value="ASC">å¤ã„é †</option></select>
            </div>

            <div id="gallery-section">
                <div id="cat1-container" class="gallery-column"><h4>å¤§ã‚«ãƒ†ã‚´ãƒª</h4><div class="loading-msg"></div></div>
                <div id="cat2-container" class="gallery-column"><h4>ä¸­ã‚«ãƒ†ã‚´ãƒª</h4><div class="loading-msg"></div></div>
                <div id="cat3-container" class="gallery-column"><h4>å°ã‚«ãƒ†ã‚´ãƒª</h4><div class="loading-msg"></div></div>
                <div id="folder-container" class="gallery-column"><h4>ãƒ•ã‚©ãƒ«ãƒ€</h4><div class="loading-msg"></div></div>
            </div>

            <hr>
            <div id="image-gallery-container"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/auth/check');
                const data = await res.json();
                if (data.loggedIn) {
                    document.getElementById('username-display').textContent = `User: ${data.username}`;
                    initApp();
                } else { window.location.href = '/login'; }
            } catch (e) { window.location.href = '/login'; }
        });

        document.getElementById('logoutButton').addEventListener('click', async () => {
            await fetch('/api/auth/logout', { method: 'POST' }); window.location.href = '/login';
        });

        const els = {
            file: document.getElementById('imageInput'),
            c1: document.getElementById('cat1Select'), c1n: document.getElementById('cat1NewInput'),
            c2: document.getElementById('cat2Select'), c2n: document.getElementById('cat2NewInput'),
            c3: document.getElementById('cat3Select'), c3n: document.getElementById('cat3NewInput'),
            folder: document.getElementById('folderInput'),
            upBtn: document.getElementById('uploadButton'), stat: document.getElementById('uploadStatus'),
            drop: document.getElementById('dropZone'), info: document.getElementById('fileInfo'),
            gal: document.getElementById('image-gallery-container'),
            csv: document.getElementById('csvDownloader'),
            search: document.getElementById('searchInput'), sort: document.getElementById('sortBy'), order: document.getElementById('sortOrder'),
        };
        let sels = { c1: null, c2: null, c3: null, f: null };
        let lightbox;

        function initApp() {
            loadCat1(); setupDropZone(); setupSelects();
            els.upBtn.onclick = uploadFiles;
            els.search.oninput = debounce(() => loadImages(sels.f, els.search.value), 500);
            els.sort.onchange = els.order.onchange = () => loadImages(sels.f, els.search.value);
        }

        async function loadImages(f, q='') {
            if(!f && !q) return;
            els.gal.innerHTML = '<p style="grid-column:span 4; text-align:center; color:#666;">èª­ã¿è¾¼ã¿ä¸­...</p>';
            const p = new URLSearchParams({ cat1: sels.c1||'', cat2: sels.c2||'', cat3: sels.c3||'', folder: f||'', q: q, sort: els.sort.value, order: els.order.value });
            try {
                const r = await fetch(`/api/search?${p}`);
                const d = await r.json();
                els.gal.innerHTML = d.length ? '' : '<p style="grid-column:span 4; text-align:center; color:#888;">è©²å½“ãªã—</p>';
                
                d.forEach(img => {
                    const div = document.createElement('div'); div.className = 'image-item';
                    const name = img.title.split('/').pop();
                    
                    let infoHtml = '', captionHtml = '';
                    if(img.product_name) {
                        const stockText = (img.stock && img.stock > 0) ? `åœ¨åº«: ${img.stock}` : `åœ¨åº«åˆ‡ã‚Œ`;
                        const stockClass = (img.stock && img.stock > 0) ? 'stock-ok' : 'stock-ng';
                        
                        infoHtml = `<div class="product-info"><div class="p-name" title="${img.product_name}">${img.product_name}</div><div class="p-model">${img.model_num1 || '-'} ${img.model_num2 || ''}</div><div class="p-stats"><span class="p-stock ${stockClass}">${stockText}</span><div class="p-prices"><div>EC: <span class="price-val">Â¥${img.ec_price ? img.ec_price.toLocaleString() : '-'}</span></div><div>ãƒ¡ãƒ«ã‚«ãƒª: Â¥${img.mercari_price ? img.mercari_price.toLocaleString() : '-'}</div></div></div></div>`;
                        captionHtml = `<div style='text-align:center;'><b style='font-size:1.2em;color:#fff;'>${img.product_name}</b><br><span style='font-size:0.9em;color:#ccc;'>${img.model_num1||''} ${img.model_num2||''}</span><br><span style='color:${img.stock>0?'#4ade80':'#f87171'};font-weight:bold;'>${stockText}</span><br>EC: Â¥${img.ec_price} / ãƒ¡ãƒ«: Â¥${img.mercari_price}</div>`;
                    } else {
                        infoHtml = `<div class="product-info" style="color:#999;"><div class="p-name" style="font-weight:normal;">${name}</div><div style="margin-top:10px; font-size:0.8em;">å•†å“æƒ…å ±ãªã—</div></div>`;
                        captionHtml = `${name}<br><span style='font-size:0.8em; color:#ccc;'>(å•†å“æƒ…å ±æœªç™»éŒ²)</span>`;
                    }

                    const safeCaptionAttr = captionHtml.replace(/"/g, '&quot;');
                    let mediaHtml = '';
                    if (img.url.toLowerCase().endsWith('.pdf')) {
                        mediaHtml = `<div class="img-wrapper"><a href="${img.url}" target="_blank" class="pdf-icon">ğŸ“„ PDF<br><span style="font-size:0.7em; font-weight:normal;">${name}</span></a></div>`;
                    } else {
                        mediaHtml = `<div class="img-wrapper"><a href="${img.url}" class="lightbox-link" data-caption="${safeCaptionAttr}"><img src="${img.url}" class="gallery-image" alt="${name}"></a></div>`;
                    }

                    div.innerHTML = mediaHtml + infoHtml;
                    els.gal.appendChild(div);
                });
                
                if(lightbox) lightbox.destroy();
                lightbox = new SimpleLightbox('#image-gallery-container .lightbox-link', { captionsData: 'data-caption', captionDelay: 0, captionPosition: 'bottom' });
                
                els.csv.style.display = f ? 'inline' : 'none';
                if(f) els.csv.href = `/download-csv?folder=${f}&cat1=${sels.c1}&cat2=${sels.c2}&cat3=${sels.c3}`;
            } catch(e) { els.gal.innerHTML = '<p style="color:red;">ã‚¨ãƒ©ãƒ¼</p>'; }
        }

        // (ä»¥ä¸‹çœç•¥ï¼šã‚«ãƒ†ã‚´ãƒªèª­è¾¼ãªã©ã¯å¤‰æ›´ãªã—)
        async function loadList(u,i,t,cb){const d=document.getElementById(i);d.innerHTML=`<h4>${t}</h4><div style="padding:10px; color:#999;">Loading...</div>`;try{const r=await fetch(u);const j=await r.json();d.innerHTML=`<h4>${t}</h4>`;j.forEach(v=>{const e=document.createElement('div');e.className='gallery-item';e.innerText=v;e.onclick=()=>{d.querySelectorAll('.gallery-item').forEach(x=>x.classList.remove('active'));e.classList.add('active');cb(v);};d.appendChild(e);});}catch(e){}}
        async function loadOpts(u,s){try{const r=await fetch(u);const j=await r.json();s.innerHTML='<option value="">--</option>';j.forEach(v=>s.innerHTML+=`<option value="${v}">${v}</option>`);s.innerHTML+='<option value="_new_">+æ–°</option>';}catch(e){}}
        const loadCat1=()=>{resetUI(1);loadList('/api/cat1','cat1-container','å¤§',v=>{sels.c1=v;els.c1.value=v;checkNew(els.c1,els.c1n);loadCat2(v);});loadOpts('/api/cat1',els.c1);};
        const loadCat2=(c)=>{resetUI(2);loadList(`/api/cat2/${c}`,'cat2-container','ä¸­',v=>{sels.c2=v;els.c2.value=v;checkNew(els.c2,els.c2n);loadCat3(c,v);});loadOpts(`/api/cat2/${c}`,els.c2);};
        const loadCat3=(c1,c2)=>{resetUI(3);loadList(`/api/cat3/${c1}/${c2}`,'cat3-container','å°',v=>{sels.c3=v;els.c3.value=v;checkNew(els.c3,els.c3n);loadFolder(c1,c2,v);});loadOpts(`/api/cat3/${c1}/${c2}`,els.c3);};
        const loadFolder=(c1,c2,c3)=>{resetUI(4);loadList(`/api/folders/${c1}/${c2}/${c3}`,'folder-container','ãƒ•ã‚©ãƒ«ãƒ€',v=>{sels.f=v;els.folder.value=v;loadImages(v);});};
        function resetUI(l){if(l<=1)document.getElementById('cat2-container').innerHTML='<h4>ä¸­</h4>';if(l<=2)document.getElementById('cat3-container').innerHTML='<h4>å°</h4>';if(l<=3)document.getElementById('folder-container').innerHTML='<h4>ãƒ•ã‚©ãƒ«ãƒ€</h4>';if(l<=4)els.gal.innerHTML='';}
        function setupDropZone(){els.drop.ondragover=e=>{e.preventDefault();els.drop.classList.add('drag-over');};els.drop.ondragleave=()=>els.drop.classList.remove('drag-over');els.drop.ondrop=e=>{e.preventDefault();els.drop.classList.remove('drag-over');els.file.files=e.dataTransfer.files;els.info.innerText=els.file.files.length+' Files';};els.file.onchange=()=>els.info.innerText=els.file.files.length+' Files';}
        function setupSelects(){const h=(s,i,l)=>{checkNew(s,i);if(s.value!=='_new_'){if(l===1)loadCat2(s.value);if(l===2)loadCat3(sels.c1,s.value);}};els.c1.onchange=()=>h(els.c1,els.c1n,1);els.c2.onchange=()=>h(els.c2,els.c2n,2);els.c3.onchange=()=>checkNew(els.c3,els.c3n);}
        function checkNew(s,i){i.style.display=s.value==='_new_'?'block':'none';}
        async function uploadFiles(){const fd=new FormData();fd.append('category1',els.c1.value==='_new_'?els.c1n.value:els.c1.value);fd.append('category2',els.c2.value==='_new_'?els.c2n.value:els.c2.value);fd.append('category3',els.c3.value==='_new_'?els.c3n.value:els.c3.value);fd.append('folderName',els.folder.value);for(let f of els.file.files)fd.append('imageFiles',f);els.stat.innerText='UP...';try{const r=await fetch('/upload',{method:'POST',body:fd});if(!r.ok)throw 1;els.stat.innerText='OK';els.file.value='';loadCat1();}catch(e){els.stat.innerText='Err';}}
        function debounce(f,w){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>f.apply(this,a),w);};}
    </script>
</body>
</html>