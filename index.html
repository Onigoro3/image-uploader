<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>画像アップローダー (フォルダ機能付き)</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 1em 2em; }
        hr { margin: 2em 0; }
        input[type="text"] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 5px 10px; cursor: pointer; }
        
        /* アップロード欄 */
        #upload-section { background: #f9f9f9; padding: 15px; border-radius: 8px; }
        #uploadStatus { font-weight: bold; }
        
        /* CSVダウンロードボタン */
        #csvDownloader {
            display: inline-block; padding: 8px 12px;
            background-color: #007bff; color: white;
            text-decoration: none; border-radius: 4px;
        }
        
        /* フォルダ（ボタン風） */
        .folder {
            padding: 10px 15px; border: 1px solid #ccc;
            border-radius: 5px; background-color: #f4f4f4;
            cursor: pointer; font-weight: bold;
        }
        .folder.active { /* 選択中のフォルダ */
            background-color: #007bff; color: white; border-color: #007bff;
        }

        /* フォルダのコンテナ */
        #folder-container {
            display: flex; flex-wrap: wrap; gap: 10px;
        }

        /* 画像ギャラリーのコンテナ */
        #image-gallery-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px; margin-top: 20px;
            border-top: 2px solid #eee; padding-top: 20px;
        }
        
        /* ギャラリー内の各画像 */
        .gallery-image {
            width: 100%; height: 150px;
            object-fit: cover; border: 1px solid #ddd; border-radius: 4px;
        }
    </style>
    </head>
<body>

    <div id="upload-section">
        <h2>画像をアップロード</h2>
        <p>
            <label for="folderNameInput"><b>保存先フォルダ名:</b></label><br>
            <input type="text" id="folderNameInput" value="default" placeholder="フォルダ名 (例: カードA)">
        </p>
        <p>
            <input type="file" id="imageInput" accept="image/*" multiple>
            <button id="uploadButton">アップロード</button>
        </p>
        <p id="uploadStatus"></p>
    </div>
    <hr>

    <h3>履歴のダウンロード</h3>
    <p>アップロードした画像の「題名」と「URL」のリストをCSVでダウンロードします。</p>
    <a href="/download-csv" id="csvDownloader">CSVダウンロード</a>

    <hr>
    <h3>フォルダ別 ギャラリー</h3>
    <p>フォルダをクリックすると、その中に保存された画像が表示されます。</p>
    
    <div id="folder-container">
        <p id="gallery-loading-status">ギャラリーを読み込み中...</p>
    </div>
    
    <div id="image-gallery-container"></div>
    <script>
        // --- HTML要素を取得 ---
        const fileInput = document.getElementById('imageInput');
        const folderNameInput = document.getElementById('folderNameInput'); // ★追加
        const uploadButton = document.getElementById('uploadButton');
        const statusP = document.getElementById('uploadStatus');
        
        const folderContainer = document.getElementById('folder-container');
        const galleryContainer = document.getElementById('image-gallery-container');
        const galleryStatus = document.getElementById('gallery-loading-status');

        // --- アップロード機能 (フォルダ名も一緒に送るよう改造) ---
        uploadButton.addEventListener('click', async () => {
            const files = fileInput.files;
            const folderName = folderNameInput.value.trim(); // ★入力されたフォルダ名を取得

            if (files.length === 0) {
                alert('画像が選択されていません。'); return;
            }
            if (folderName === '') {
                alert('フォルダ名を入力してください。'); return;
            }

            // フォームデータ（画像とフォルダ名）を準備
            const formData = new FormData();
            formData.append('folderName', folderName); // ★フォルダ名を追加
            for (let i = 0; i < files.length; i++) {
                formData.append('imageFiles', files[i]);
            }

            statusP.style.color = 'blue';
            statusP.innerText = `「${folderName}」にアップロード中... (${files.length} 件)`;
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST', body: formData
                });
                const data = await response.json();
                
                if (response.ok) {
                    statusP.style.color = 'green';
                    statusP.innerText = data.message;
                    fileInput.value = '';
                    // ★アップロード成功したら、フォルダリストを再読み込み
                    loadFolders(); 
                } else {
                    statusP.style.color = 'red';
                    statusP.innerText = 'アップロード失敗: ' + data.message;
                }
            } catch (error) {
                statusP.style.color = 'red';
                statusP.innerText = '通信エラーが発生しました。';
            }
        });

        // --- ギャラリー機能 (日付 → フォルダ に全面書き換え) ---
        
        // (A) ページが読み込まれたら、まずフォルダリストを取得する
        document.addEventListener('DOMContentLoaded', () => {
            loadFolders();
        });

        // (B) サーバーの「/api/folders」に通信して、フォルダボタンを作る関数
        async function loadFolders() {
            try {
                const response = await fetch('/api/folders'); // ★API変更
                const folders = await response.json(); // ['default', 'カードA', ...]
                
                folderContainer.innerHTML = ''; 

                if (folders.length === 0) {
                    galleryStatus.innerText = 'アップロードされた画像はまだありません。';
                    folderContainer.appendChild(galleryStatus);
                    return;
                }

                folders.forEach(folderName => {
                    const folder = document.createElement('div');
                    folder.className = 'folder';
                    folder.innerText = folderName;
                    
                    folder.addEventListener('click', () => {
                        loadImagesByFolder(folderName); // ★関数変更
                        
                        document.querySelectorAll('.folder').forEach(f => f.classList.remove('active'));
                        folder.classList.add('active');
                        
                        // ★クリックしたフォルダ名を、アップロード欄の入力に自動でセット
                        folderNameInput.value = folderName; 
                    });
                    
                    folderContainer.appendChild(folder);
                });

                // ★自動で最初のフォルダをクリックした状態にする
                if (folders.length > 0) {
                    folderContainer.children[0].click();
                }

            } catch (error) {
                console.error('フォルダの読み込みエラー:', error);
                folderContainer.innerHTML = '<p style="color: red;">フォルダの読み込みに失敗しました。</p>';
            }
        }

        // (C) サーバーの「/api/images/:folder」に通信して、画像ギャラリーを作る関数
        async function loadImagesByFolder(folderName) { // ★関数変更
            try {
                galleryContainer.innerHTML = '<p>画像を読み込み中...</p>'; 
                
                // ★API変更 (フォルダ名に / が含まれるとURLが壊れるのでエンコードする)
                const encodedFolderName = encodeURIComponent(folderName);
                const response = await fetch(`/api/images/${encodedFolderName}`); 
                const images = await response.json(); 

                galleryContainer.innerHTML = ''; 
                
                if (images.length === 0) {
                    galleryContainer.innerHTML = '<p>このフォルダに画像はありません。</p>';
                    return;
                }

                images.forEach(image => {
                    const img = document.createElement('img');
                    img.className = 'gallery-image';
                    img.src = image.url;   
                    img.alt = image.title; 
                    img.title = image.title;
                    galleryContainer.appendChild(img);
                });

            } catch (error) {
                console.error('画像ギャラリーの読み込みエラー:', error);
                galleryContainer.innerHTML = '<p style="color: red;">画像の読み込みに失敗しました。</p>';
            }
        }

    </script>
    </body>
</html>