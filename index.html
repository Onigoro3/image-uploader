<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>画像アップローダー (拡大・並び替え機能付き)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" integrity="sha512-FaAQujRxLMvwKe+TPX5rX/94rLhS+rbiUl2yQek56f+PkQ7f9rQ7W4eHAv9j/s6+uTbT2a1Q6T1Pj9v41Y7o9w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* (基本スタイルはほぼ変更なし) */
        body { font-family: sans-serif; line-height: 1.6; padding: 1em 2em; }
        hr { margin: 2em 0; }
        input[type="text"], input[type="search"], select { padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 95%; margin-bottom: 5px; font-size: 14px; }
        button { padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 14px; }
        #upload-section { background: #f9f9f9; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px 20px; }
        #upload-section label { font-weight: bold; display: block; margin-bottom: 3px; }
        #uploadStatus { font-weight: bold; grid-column: span 3; }
        #csvDownloader { display: inline-block; padding: 8px 12px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; }
        #gallery-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .gallery-column { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; min-height: 200px; max-height: 400px; overflow-y: auto; }
        .gallery-item { padding: 8px; border: 1px solid #ccc; border-radius: 5px; background-color: #f4f4f4; font-weight: bold; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .gallery-item.active { background-color: #007bff; color: white; border-color: #007bff; }
        .gallery-item span { flex-grow: 1; margin-right: 5px; font-size: 14px; word-break: break-all; }
        .action-buttons { display: flex; gap: 3px; flex-shrink: 0; }
        .analyze-btn, .edit-btn, .delete-btn { border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-weight: bold; line-height: 20px; text-align: center; color: white; font-size: 12px; }
        .analyze-btn { background: #17a2b8; } .analyze-btn:hover { background: #138496; }
        .edit-btn { background: #ffc107; } .edit-btn:hover { background: #e0a800; }
        .delete-btn { background: #dc3545; } .delete-btn:hover { background: #c82333; }
        #search-section { margin-top: 20px; border-top: 2px solid #eee; padding-top: 10px; padding-bottom: 10px; display: flex; align-items: center; gap: 15px;} /* Flex layout for search and sort */
        #searchInput { width: 300px; padding: 8px; }
        /* ▼▼▼ 並び替えコントロールのスタイル ▼▼▼ */
        #sort-controls label { margin-right: 5px; font-weight: bold;}
        #sort-controls select { width: auto; padding: 6px; } /* Adjust width */
        /* ▲▲▲ 並び替えスタイルここまで ▲▲▲ */
        #image-gallery-container { grid-column: span 4; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 10px; padding-top: 10px; border-top: 2px solid #eee; }
        .image-item { border: 1px solid #ddd; border-radius: 4px; padding: 5px; background: #fff; }
        .gallery-image { width: 100%; height: 130px; object-fit: cover; display: block; margin-bottom: 0; }
        .new-input { display: none; margin-top: 5px; }
        #analyzeStatus { margin-top: 10px; font-weight: bold; color: #17a2b8; }
        #dropZone { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-top: 10px; transition: background-color 0.2s ease; }
        #dropZone.drag-over { background-color: #e9ecef; border-color: #007bff; }
        #fileInfo { margin-top: 10px; font-style: italic; }
    </style>
</head>
<body>

    <div id="upload-section">
        <div><label for="cat1Select">1. 大カテゴリ:</label><select id="cat1Select"></select><input type="text" id="cat1NewInput" class="new-input" placeholder="新しい大カテゴリ名"></div>
        <div><label for="cat2Select">2. 中カテゴリ:</label><select id="cat2Select"></select><input type="text" id="cat2NewInput" class="new-input" placeholder="新しい中カテゴリ名"></div>
        <div><label for="cat3Select">3. 小カテゴリ:</label><select id="cat3Select"></select><input type="text" id="cat3NewInput" class="new-input" placeholder="新しい小カテゴリ名"></div>
        <div><label for="folderInput">4. フォルダ名:</label><input type="text" id="folderInput" value="default_folder"></div>
        <div style="grid-column: span 2;">
            <p style="margin-top:20px;">5. ファイルを選択 または ドラッグ＆ドロップ</p>
            <div id="dropZone">
                ここにファイルをドラッグ＆ドロップ<br>または
                <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                <button type="button" onclick="document.getElementById('imageInput').click();">ファイルを選択</button>
                <div id="fileInfo">選択されていません</div>
            </div>
            <button id="uploadButton" style="margin-top: 15px;">アップロード</button>
        </div>
        <p id="uploadStatus" style="grid-column: span 3;"></p>
    </div><hr>
    <h3>履歴のダウンロード</h3><p>現在選択中の**フォルダ**のCSVをダウンロードします。</p><a href="#" id="csvDownloader" style="visibility: hidden;">CSVダウンロード</a> <span id="csv-status-text">(フォルダ選択で有効化)</span> <span id="analyzeStatus"></span> <hr>
    <h3>階層別 ギャラリー</h3><p>大 → 中 → 小 → フォルダ の順に選択。(A:解析 E:編集 X:削除)</p>
    <div id="gallery-section">
        <div id="cat1-container" class="gallery-column"><h4>大カテゴリ</h4><p class="loading-status">読込中...</p></div>
        <div id="cat2-container" class="gallery-column"><h4>中カテゴリ</h4><p class="loading-status"></p></div>
        <div id="cat3-container" class="gallery-column"><h4>小カテゴリ</h4><p class="loading-status"></p></div>
        <div id="folder-container" class="gallery-column"><h4>フォルダ</h4><p class="loading-status"></p></div>
    </div>

    {/* ▼▼▼ 検索バーと並び替えコントロール ▼▼▼ */}
    <div id="search-section" style="display: none;">
        <div>
             <label for="searchInput">画像検索:</label>
             <input type="search" id="searchInput" placeholder="ファイル名の一部...">
        </div>
        <div id="sort-controls">
            <label for="sortBy">並び替え:</label>
            <select id="sortBy">
                <option value="created_at" selected>アップロード日</option>
                <option value="title">ファイル名</option>
            </select>
            <select id="sortOrder">
                <option value="DESC" selected>新しい順 / 降順(Z-A)</option>
                <option value="ASC">古い順 / 昇順(A-Z)</option>
            </select>
        </div>
    </div>
    {/* ▲▲▲ 検索・並び替えここまで ▲▲▲ */}

    <div id="image-gallery-container"></div> {/* 画像ギャラリー */}

    {/* ▼▼▼ SimpleLightbox ライブラリの読み込み (JS) ▼▼▼ */}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js" integrity="sha512-V1+KIAwH S+Pn9gP6BOwZ8T9z9AEhS+7J+kE6+Vgkf+h3/f+0G029V2h3Nf+4/1w/zI/3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    {/* ▲▲▲ SimpleLightbox JS ▲▲▲ */}

    <script>
        // --- HTML要素を取得 ---
        const fileInput = document.getElementById('imageInput');
        const cat1Select = document.getElementById('cat1Select'); const cat1NewInput = document.getElementById('cat1NewInput');
        /* ... (他の要素取得) ... */
        const cat2Select = document.getElementById('cat2Select'); const cat2NewInput = document.getElementById('cat2NewInput');
        const cat3Select = document.getElementById('cat3Select'); const cat3NewInput = document.getElementById('cat3NewInput');
        const folderInput = document.getElementById('folderInput');
        const uploadButton = document.getElementById('uploadButton');
        const statusP = document.getElementById('uploadStatus');
        const cat1Container = document.getElementById('cat1-container'); const cat2Container = document.getElementById('cat2-container'); const cat3Container = document.getElementById('cat3-container'); const folderContainer = document.getElementById('folder-container');
        const galleryContainer = document.getElementById('image-gallery-container');
        const csvButton = document.getElementById('csvDownloader'); const csvStatus = document.getElementById('csv-status-text');
        const searchSection = document.getElementById('search-section'); const searchInput = document.getElementById('searchInput');
        const dropZone = document.getElementById('dropZone'); const fileInfo = document.getElementById('fileInfo');
        const analyzeStatus = document.getElementById('analyzeStatus');
        const sortBySelect = document.getElementById('sortBy'); // ★並び替え要素
        const sortOrderSelect = document.getElementById('sortOrder'); // ★並び順要素
        let selections = { cat1: null, cat2: null, cat3: null, folder: null };
        let lightbox; // ★ ライトボックスのインスタンス用

        // --- ドラッグ＆ドロップ (変更なし) ---
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        /* ... (他のD&DイベントとupdateFileInfo) ... */

        // --- アップロード機能 (変更なし) ---
        uploadButton.addEventListener('click', async () => { /* ... (変更なし) ... */ });

        // --- ギャラリー機能 ---
        document.addEventListener('DOMContentLoaded', () => { loadCat1(); setupSelectListeners(); setupSortListeners(); }); // ★ 並び替えリスナー設定を追加

        // Select要素関連 (変更なし)
        function populateSelect(selectElement, items, currentSelection) { /* ... */ }
        function setupSelectListeners() { /* ... */ }
        function handleSelectChange(selectElement, newInputElement, level) { /* ... */ }
        function resetUploadUI(startLevel, createOnly = false){ /* ... */ }
        function resetAndAddCreateOption(selectElement) { /* ... */ }
        // 階層リスト読み込み (変更なし)
        async function loadCat1() { /* ... */ }
        async function loadCat1Options(){ /* ... */ }
        async function loadCat2(c1) { /* ... */ }
        async function loadCat2Options(c1){ /* ... */ }
        async function loadCat3(c1, c2) { /* ... */ }
        async function loadCat3Options(c1, c2){ /* ... */ }
        async function loadFolders(c1, c2, c3) { /* ... */ }
        async function loadList(apiUrl, container, title, onClickCallback, addActionButtons = false, level = 0) { /* ... */ }
        function resetUI(startLevel) { /* ... */ }

        // (E) 画像読み込みトリガー (★並び替えも考慮)
        async function loadImages(folderName) {
            selections.folder = folderName; searchInput.value = ''; searchSection.style.display = 'flex'; // ★ flexに変更して検索と並び替えを横並び
            // ★ 現在の並び替え設定を取得してdisplayImagesに渡す
            const sortBy = sortBySelect.value;
            const sortOrder = sortOrderSelect.value;
            await displayImages(folderName, '', sortBy, sortOrder);
        }

        // (F) 検索イベントリスナー (★並び替えも考慮)
        let searchTimeout; searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                if (selections.folder) {
                    const sortBy = sortBySelect.value; const sortOrder = sortOrderSelect.value;
                    await displayImages(selections.folder, searchInput.value.trim(), sortBy, sortOrder);
                }
            }, 300);
        });

        // ▼▼▼ (NEW) 並び替えイベントリスナー ▼▼▼
        function setupSortListeners() {
            sortBySelect.addEventListener('change', handleSortChange);
            sortOrderSelect.addEventListener('change', handleSortChange);
        }
        async function handleSortChange() {
             if (selections.folder) {
                const sortBy = sortBySelect.value; const sortOrder = sortOrderSelect.value;
                await displayImages(selections.folder, searchInput.value.trim(), sortBy, sortOrder);
             }
        }
        // ▲▲▲ 並び替えイベントリスナー ここまで ▲▲▲

        // ▼▼▼ (G) 画像取得・表示関数 (★ライトボックス対応 & 並び替えパラメータ追加) ▼▼▼
        async function displayImages(folderName, searchTerm, sortBy = 'created_at', sortOrder = 'DESC') {
            try {
                // ★ ライトボックスが初期化済みなら破棄する
                if (lightbox) { lightbox.destroy(); }

                galleryContainer.innerHTML = '<p>読込中...</p>'; const encodedFolderName = encodeURIComponent(folderName);
                let apiUrl;
                // ★ APIに並び替えパラメータを追加
                const sortParams = `&sort=${sortBy}&order=${sortOrder}`;

                if (searchTerm) {
                    apiUrl = `/api/search?folder=${encodedFolderName}&q=${encodeURIComponent(searchTerm)}${sortParams}`;
                } else {
                    apiUrl = `/api/images/${encodedFolderName}?${sortParams}`; // ★ 通常取得にも追加
                }
                const response = await fetch(apiUrl); if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const images = await response.json(); galleryContainer.innerHTML = '';
                if (images.length === 0) { galleryContainer.innerHTML = searchTerm ? '<p>検索結果なし</p>' : '<p>画像なし</p>'; }
                else {
                    images.forEach(imgData => {
                        const itemContainer = document.createElement('div'); itemContainer.className = 'image-item';

                        // ★★★ 画像(img)をリンク(a)で囲む ★★★
                        const link = document.createElement('a');
                        link.href = imgData.url; // ★ リンク先に画像URLを指定

                        const img = document.createElement('img');
                        img.className='gallery-image';
                        img.src=imgData.url; // ★ サムネイルも同じURLを使用 (必要ならサーバーでサムネイルURLを別途生成)
                        img.alt=imgData.title;
                        img.title=imgData.title; // ホバーでファイル名表示

                        link.appendChild(img); // リンクの中に画像を入れる
                        itemContainer.appendChild(link); // リンク付き画像をコンテナに追加
                        galleryContainer.appendChild(itemContainer);
                    });

                    // ★★★ SimpleLightbox を初期化 ★★★
                    // '.gallery-item a' のように、ギャラリー内のリンクを対象にする
                    lightbox = new SimpleLightbox('#image-gallery-container .image-item a', { /* オプション */ });

                }
                // CSVボタン表示
                csvButton.href = `/download-csv?folder=${encodedFolderName}`;
                csvButton.style.visibility = 'visible'; csvStatus.innerText = `「${folderName}」CSV`;
            } catch (error) { console.error('画像読込/検索エラー:', error); galleryContainer.innerHTML = '<p style="color: red;">失敗</p>'; csvButton.style.visibility = 'hidden'; csvStatus.innerText = '(フォルダ選択で有効化)'; if (lightbox) { lightbox.destroy(); } }
        }
        // ▲▲▲ (G) 画像取得・表示関数 ここまで ▲▲▲

        // (H) 削除関数 (変更なし)
        async function deleteItem(itemName, level) { /* ... */ }
        // (I) 名前変更関数 (変更なし)
        async function renameItem(oldItemName, level) { /* ... */ }
        // (J) フォルダ解析関数 (変更なし)
        async function analyzeFolder(folderName) { /* ... */ }

        // --- 省略した関数の中身 (前のコードと同じ) ---
        // (省略部分は、あなたの手元の動作しているコードから補完してください)
    </script>
</body>
</html>