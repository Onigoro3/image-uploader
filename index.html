<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>画像アップローダー (全機能)</title>
    <style>
        #auth-status {
            position: fixed; top: 10px; right: 20px; background: #fff; padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 100;
        }
        #auth-status button { margin-left: 10px; background: #dc3545; color: white; border: none; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" integrity="sha512-FaAQujRxLMvw+BkmGN3w7u9EdQQr1t0vQoY8KDh09+6SFaWSTe+KrT8oCWg25X91hytm5c5BTmiSGQejkraaZg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" integrity="sha512-Eezs+g9LqAeoqknMtryBU8fTCkI/GsgDnI0yV/SotUpd9UfE0VSPweAJUfOKcA/FGJRrTXeI28mLitSAUuSAeg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 1em 2em; }
        hr { margin: 2em 0; }
        input[type="text"], input[type="search"], select { padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 95%; margin-bottom: 5px; font-size: 14px; }
        button { padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 14px; }
        #upload-section { background: #f9f9f9; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px 20px; }
        #upload-section label { font-weight: bold; display: block; margin-bottom: 3px; }
        #uploadStatus { font-weight: bold; grid-column: span 3; }
        #csvDownloader { display: inline-block; padding: 8px 12px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; }
        #gallery-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .gallery-column { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; min-height: 200px; max-height: 400px; overflow-y: hidden; }
        .gallery-column h4 { margin-bottom: 10px; }
        .gallery-column .list-content { max-height: 320px; overflow-y: auto; }
        .gallery-item { padding: 8px; border: 1px solid #ccc; border-radius: 5px; background-color: #f4f4f4; font-weight: bold; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .gallery-item.active { background-color: #007bff; color: white; border-color: #007bff; }
        .gallery-item span { flex-grow: 1; margin-right: 5px; font-size: 14px; word-break: break-all; }
        
        /* --- ▼▼▼ ドラッグ中スタイルを新規追加 ▼▼▼ --- */
        .gallery-item.dragging-item { opacity: 0.5; background: #cce5ff; }
        #folder-container .gallery-item { cursor: move; } /* フォルダのみカーソル変更 */
        /* --- ▲▲▲ ドラッグ中スタイルを新規追加 ▲▲▲ --- */

        .action-buttons { display: flex; gap: 3px; flex-shrink: 0; }
        .analyze-btn, .edit-btn, .delete-btn { border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-weight: bold; line-height: 20px; text-align: center; color: white; font-size: 12px; }
        .analyze-btn { background: #17a2b8; } .analyze-btn:hover { background: #138496; }
        .edit-btn { background: #ffc107; } .edit-btn:hover { background: #e0a800; }
        .delete-btn { background: #dc3545; } .delete-btn:hover { background: #c82333; }
        #search-section { margin-top: 20px; border-top: 2px solid #eee; padding-top: 10px; padding-bottom: 10px; display: flex; align-items: center; gap: 15px;}
        #searchInput { width: 300px; padding: 8px; }
        #sort-controls label { margin-right: 5px; font-weight: bold;}
        #sort-controls select { width: auto; padding: 6px; }
        #image-gallery-container { grid-column: span 4; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 10px; padding-top: 10px; border-top: 2px solid #eee; }
        .image-item { border: 1px solid #ddd; border-radius: 4px; padding: 5px; background: #fff; }
        .gallery-image { width: 100%; height: 130px; object-fit: cover; display: block; margin-bottom: 0; }
        .new-input { display: none; margin-top: 5px; }
        #analyzeStatus { margin-top: 10px; font-weight: bold; color: #17a2b8; }
        #dropZone { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-top: 10px; transition: background-color 0.2s ease; }
        #dropZone.drag-over { background-color: #e9ecef; border-color: #007bff; }
        #fileInfo { margin-top: 10px; font-style: italic; }
    </style>
</head>
<body>

    <div id="auth-status">
        <span id="username-display">...</span>
        <button id="logoutButton">ログアウト</button>
    </div>
    <div id="upload-section">
        </div><hr>
    <h3>履歴のダウンロード</h3><hr>
    <h3>階層別 ギャラリー</h3><p>大 → 中 → 小 → フォルダ の順に選択。(A:解析 E:編集 X:削除)</p>
    
    <div id="gallery-section">
        <div id="cat1-container" class="gallery-column">
            <h4>大カテゴリ</h4>
            <div class="list-content"><p class="loading-status">読込中...</p></div>
        </div>
        <div id="cat2-container" class="gallery-column">
            <h4>中カテゴリ</h4>
            <div class="list-content"><p class="loading-status"></p></div>
        </div>
        <div id="cat3-container" class="gallery-column">
            <h4>小カテゴリ</h4>
            <div class="list-content"><p class="loading-status"></p></div>
        </div>
        <div id="folder-container" class="gallery-column">
            <h4>フォルダ</h4> 
            <div class="list-content"><p class="loading-status"></p></div>
        </div>
    </div>
    <div id="search-section" style="display: none;">
        </div>
    <div id="image-gallery-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js" integrity="sha512-/4kQE5RJQYHRhUiK+CZS8UhaJTnLmQkDuf8lOhiP2xLdjthA/rm0VqqWjcyelIx+NDyNHFmtqvuIgOFQnI34WA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        // --- HTML要素を取得 ---
        // (変更なし)
        const fileInput = document.getElementById('imageInput');
        const cat1Select = document.getElementById('cat1Select'); const cat1NewInput = document.getElementById('cat1NewInput');
        const cat2Select = document.getElementById('cat2Select'); const cat2NewInput = document.getElementById('cat2NewInput');
        const cat3Select = document.getElementById('cat3Select'); const cat3NewInput = document.getElementById('cat3NewInput');
        const folderInput = document.getElementById('folderInput');
        const uploadButton = document.getElementById('uploadButton');
        const statusP = document.getElementById('uploadStatus');
        const cat1Container = document.getElementById('cat1-container'); const cat2Container = document.getElementById('cat2-container'); const cat3Container = document.getElementById('cat3-container'); const folderContainer = document.getElementById('folder-container');
        const galleryContainer = document.getElementById('image-gallery-container');
        const csvButton = document.getElementById('csvDownloader'); const csvStatus = document.getElementById('csv-status-text');
        const searchSection = document.getElementById('search-section'); const searchInput = document.getElementById('searchInput');
        const dropZone = document.getElementById('dropZone'); const fileInfo = document.getElementById('fileInfo');
        const analyzeStatus = document.getElementById('analyzeStatus');
        const sortBySelect = document.getElementById('sortBy');
        const sortOrderSelect = document.getElementById('sortOrder');
        
        // ★ folderSortOrderSelect の取得を削除
        
        let selections = { cat1: null, cat2: null, cat3: null, folder: null };
        let lightbox;
        let folderSortableInstance = null; // ★ フォルダのSortableインスタンスを保持する変数

        // --- ドラッグ＆ドロップ イベントリスナー (変更なし) ---
        // ...
        
        // --- アップロード機能 (変更なし) ---
        // ...

        // --- ギャラリー機能 ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/auth/check');
                const authData = await response.json();
                if (authData.loggedIn) {
                    document.getElementById('username-display').textContent = `ようこそ, ${authData.username} さん`;
                    loadCat1(); 
                    setupSelectListeners();
                    setupSortListeners(); // ★ setupSortListeners 自体は残す
                    setupLogoutButton();
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                window.location.href = '/login';
            }
        });

        // --- Select関連 (変更なし) ---
        // ... populateSelect, setupSelectListeners, handleSelectChange, resetUploadUI, resetAndAddCreateOption ...

        // --- 階層リスト読み込み ---
        // (cat1, cat2, cat3 変更なし)
        async function loadCat1() { resetUI(1); resetUploadUI(1); const listContent = cat1Container.querySelector('.list-content'); await loadList('/api/cat1', listContent, '大カテゴリ', (n) => { selections.cat1 = n; loadCat2(n); cat1Select.value = n; handleSelectChange(cat1Select, cat1NewInput, 1); }, true, 1); await loadCat1Options(); }
        async function loadCat1Options(){ /* (変更なし) */ }
        async function loadCat2(c1) { resetUI(2); resetUploadUI(2); const listContent = cat2Container.querySelector('.list-content'); await loadList(`/api/cat2/${encodeURIComponent(c1)}`, listContent, '中カテゴリ', (n) => { selections.cat2 = n; loadCat3(c1, n); cat2Select.value = n; handleSelectChange(cat2Select, cat2NewInput, 2); }, true, 2); await loadCat2Options(c1); }
        async function loadCat2Options(c1){ /* (変更なし) */ }
        async function loadCat3(c1, c2) { resetUI(3); resetUploadUI(3); const listContent = cat3Container.querySelector('.list-content'); await loadList(`/api/cat3/${encodeURIComponent(c1)}/${encodeURIComponent(c2)}`, listContent, '小カテゴリ', (n) => { selections.cat3 = n; loadFolders(c1, c2, n); cat3Select.value = n; handleSelectChange(cat3Select, cat3NewInput, 3); }, true, 3); await loadCat3Options(c1, c2); }
        async function loadCat3Options(c1, c2){ /* (変更なし) */ }
        
        // --- ▼▼▼ loadFolders (並び替えロジック削除) ▼▼▼ ---
        async function loadFolders(c1, c2, c3) { 
            resetUI(4); 
            // ★ 並び替え select 関連のロジックを削除
            const apiUrl = `/api/folders/${encodeURIComponent(c1)}/${encodeURIComponent(c2)}/${encodeURIComponent(c3)}`;
            const listContent = folderContainer.querySelector('.list-content');
            await loadList(apiUrl, listContent, 'フォルダ', (n) => { selections.folder = n; loadImages(n); folderInput.value = n; }, true, 4); 
        }
        // --- ▲▲▲ loadFolders (並び替えロジック削除) ▲▲▲ ---


        // --- ▼▼▼ 汎用リスト読み込み関数 (SortableJS 初期化) ▼▼▼ ---
        async function loadList(apiUrl, container, title, onClickCallback, addActionButtons = false, level = 0) {
            container.innerHTML = `<p class="loading-status">読込中...</p>`;
            try {
                // ★ 既存の Sortable インスタンスがあれば破棄
                if (level === 4 && folderSortableInstance) {
                    folderSortableInstance.destroy();
                    folderSortableInstance = null;
                }
                
                const response = await fetch(apiUrl); 
                if (response.status === 401) { throw new Error('401'); } 
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const items = await response.json(); 
                container.innerHTML = ''; 
                
                if (items.length === 0) { 
                    container.innerHTML = '<p>データなし</p>'; 
                    return; 
                }
                items.forEach(itemName => {
                    // ... (itemDiv, nameSpan, actionButtons の作成 ... 変更なし)
                    const itemDiv = document.createElement('div'); itemDiv.className = 'gallery-item';
                    const nameSpan = document.createElement('span'); nameSpan.innerText = itemName;
                    nameSpan.addEventListener('click', () => { document.querySelectorAll(`#${container.id} .gallery-item, .gallery-item`).forEach(el => el.classList.remove('active')); itemDiv.classList.add('active'); onClickCallback(itemName); });
                    itemDiv.appendChild(nameSpan);
                    if (addActionButtons) {
                        const actionButtons = document.createElement('div'); actionButtons.className = 'action-buttons';
                        if (level === 4) { const analyzeBtn = document.createElement('button'); analyzeBtn.className = 'analyze-btn'; analyzeBtn.innerText = 'A'; analyzeBtn.title = '解析CSV出力'; analyzeBtn.addEventListener('click', (e) => { e.stopPropagation(); analyzeFolder(itemName); }); actionButtons.appendChild(analyzeBtn); }
                        const editBtn = document.createElement('button'); editBtn.className = 'edit-btn'; editBtn.innerText = 'E'; editBtn.title = '名前変更'; editBtn.addEventListener('click', (e) => { e.stopPropagation(); renameItem(itemName, level); });
                        const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-btn'; deleteBtn.innerText = 'X'; deleteBtn.title = '削除'; deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteItem(itemName, level); });
                        actionButtons.appendChild(editBtn); actionButtons.appendChild(deleteBtn); itemDiv.appendChild(actionButtons);
                    }
                    container.appendChild(itemDiv);
                });
                
                // ★ Level 4 (フォルダ) のみ SortableJS を有効化
                if (level === 4) {
                    folderSortableInstance = new Sortable(container, {
                        animation: 150,
                        ghostClass: 'dragging-item', // ドラッグ中のスタイル
                        onEnd: (evt) => {
                            // ドラッグ終了時に並び順を保存
                            saveFolderOrder(selections.cat1, selections.cat2, selections.cat3, container);
                        }
                    });
                }

            } catch (error) { 
                console.error(`${title}読み込みエラー:`, error); 
                container.innerHTML = `<p style="color: red;">失敗</p>`; 
                if (error.message.includes("401")) {
                    alert("セッションが切れました。再度ログインしてください。");
                    window.location.href = '/login';
                }
            }
        }
        // --- ▲▲▲ 汎用リスト読み込み関数 (SortableJS 初期化) ▲▲▲ ---


        // --- ▼▼▼ UIリセット関数 (並び替え削除) ▼▼▼ ---
        function resetUI(startLevel) { 
            if (startLevel <= 1) { 
                selections.cat1 = null; 
                cat1Container.querySelector('.list-content').innerHTML = ''; 
            } 
            if (startLevel <= 2) { 
                selections.cat2 = null; 
                cat2Container.querySelector('.list-content').innerHTML = ''; 
            } 
            if (startLevel <= 3) { 
                selections.cat3 = null; 
                // ★ フォルダ並び替え select 関連のリセット処理を削除
                if (folderSortableInstance) { // Sortableインスタンスも破棄
                    folderSortableInstance.destroy();
                    folderSortableInstance = null;
                }
                folderContainer.querySelector('.list-content').innerHTML = ''; 
            } 
            if (startLevel <= 4) { 
                selections.folder = null; galleryContainer.innerHTML = ''; searchSection.style.display = 'none'; searchInput.value = ''; csvButton.style.visibility = 'hidden'; csvStatus.innerText = '(フォルダ選択で有効化)'; analyzeStatus.innerText = ''; 
            } 
        }
        // --- ▲▲▲ UIリセット関数 (並び替え削除) ▲▲▲ ---

        // (変更なし)
        async function loadImages(folderName) { selections.folder = folderName; searchInput.value = ''; searchSection.style.display = 'flex'; const sortBy = sortBySelect.value; const sortOrder = sortOrderSelect.value; await displayImages(folderName, '', sortBy, sortOrder); }
        let searchTimeout; searchInput.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(async () => { if (selections.folder) { const sortBy = sortBySelect.value; const sortOrder = sortOrderSelect.value; await displayImages(selections.folder, searchInput.value.trim(), sortBy, sortOrder); } }, 300); });
        
        // --- ▼▼▼ 並び替えイベントリスナー (フォルダ並び替え削除) ▼▼▼ ---
        function setupSortListeners() { 
            sortBySelect.addEventListener('change', handleSortChange); 
            sortOrderSelect.addEventListener('change', handleSortChange); 
            // ★ folderSortOrderSelect のリスナーを削除
        } 
        async function handleSortChange() { 
            if (selections.folder) { 
                const sortBy = sortBySelect.value; const sortOrder = sortOrderSelect.value; 
                await displayImages(selections.folder, searchInput.value.trim(), sortBy, sortOrder); 
            } 
        }
        // ★ handleFolderSortChange 関数を削除
        // --- ▲▲▲ 並び替えイベントリスナー (フォルダ並び替え削除) ▲▲▲ ---


        // 画像取得・表示関数 (変更なし)
        async function displayImages(folderName, searchTerm, sortBy = 'created_at', sortOrder = 'DESC') { /* (変更なし) */ }
        
        // --- ▼▼▼ 削除関数 (APIパス修正) ▼▼▼ ---
        async function deleteItem(itemName, level) {
            let apiPath = ''; let confirmMsg = `「${itemName}」`; let refreshFunction = loadCat1;
            if (level === 1) { apiPath = `/api/cat1/${encodeURIComponent(itemName)}`; confirmMsg += ' (大)以下全て削除しますか？⚠⚠⚠'; }
            else if (level === 2 && selections.cat1) { apiPath = `/api/cat2/${encodeURIComponent(selections.cat1)}/${encodeURIComponent(itemName)}`; confirmMsg += ' (中)以下全て削除しますか？⚠'; refreshFunction = () => loadCat2(selections.cat1); }
            else if (level === 3 && selections.cat1 && selections.cat2) { apiPath = `/api/cat3/${encodeURIComponent(selections.cat1)}/${encodeURIComponent(selections.cat2)}/${encodeURIComponent(itemName)}`; confirmMsg += ' (小)以下全て削除しますか？⚠'; refreshFunction = () => loadCat3(selections.cat1, selections.cat2); }
            // ★ APIパスを C1/C2/C3 を含むように変更
            else if (level === 4 && selections.cat1 && selections.cat2 && selections.cat3) { 
                apiPath = `/api/folder/${encodeURIComponent(selections.cat1)}/${encodeURIComponent(selections.cat2)}/${encodeURIComponent(selections.cat3)}/${encodeURIComponent(itemName)}`; 
                confirmMsg += ' (フォルダ)内の画像を削除しますか？⚠'; 
                refreshFunction = () => loadFolders(selections.cat1, selections.cat2, selections.cat3); 
            }
            else { return; }
            if (!confirm(confirmMsg)) return;
            try {
                statusP.innerText = `削除中...`; statusP.style.color = 'blue'; const response = await fetch(apiPath, { method: 'DELETE' }); 
                if (response.status === 401) { throw new Error('401'); }
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json(); statusP.innerText = data.message; statusP.style.color = 'green'; refreshFunction(); resetUI(level + 1);
            } catch (error) { 
                console.error('削除エラー:', error); statusP.innerText = '削除失敗'; statusP.style.color = 'red'; 
                if (error.message.includes("401")) { alert("セッションが切れました。再度ログインしてください。"); window.location.href = '/login'; }
            }
        }
        // --- ▲▲▲ 削除関数 (APIパス修正) ▲▲▲ ---

        // --- ▼▼▼ 名前変更関数 (APIパス修正) ▼▼▼ ---
        async function renameItem(oldItemName, level) {
            const newItemName = prompt(`「${oldItemName}」の新しい名前:`, oldItemName); if (!newItemName || newItemName.trim() === '' || newItemName.trim() === oldItemName) return;
            let apiPath = ''; let refreshFunction = loadCat1;
            if (level === 1) { apiPath = `/api/cat1/${encodeURIComponent(oldItemName)}`; }
            else if (level === 2 && selections.cat1) { apiPath = `/api/cat2/${encodeURIComponent(selections.cat1)}/${encodeURIComponent(oldItemName)}`; refreshFunction = () => loadCat2(selections.cat1); }
            else if (level === 3 && selections.cat1 && selections.cat2) { apiPath = `/api/cat3/${encodeURIComponent(selections.cat1)}/${encodeURIComponent(selections.cat2)}/${encodeURIComponent(oldItemName)}`; refreshFunction = () => loadCat3(selections.cat1, selections.cat2); }
            // ★ APIパスを C1/C2/C3 を含むように変更
            else if (level === 4 && selections.cat1 && selections.cat2 && selections.cat3) { 
                apiPath = `/api/folder/${encodeURIComponent(selections.cat1)}/${encodeURIComponent(selections.cat2)}/${encodeURIComponent(selections.cat3)}/${encodeURIComponent(oldItemName)}`; 
                refreshFunction = () => loadFolders(selections.cat1, selections.cat2, selections.cat3); 
            }
            else { return; }
            try {
                statusP.innerText = `変更中...`; statusP.style.color = 'blue';
                const response = await fetch(apiPath, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ newName: newItemName.trim() }) });
                if (response.status === 401) { throw new Error('401'); }
                if (!response.ok) { const errData = await response.json().catch(() => ({ message: `HTTP ${response.status}` })); throw new Error(errData.message || `HTTP ${response.status}`); }
                const data = await response.json(); statusP.innerText = data.message; statusP.style.color = 'green'; refreshFunction(); resetUI(level + 1);
            } catch (error) { 
                console.error('名前変更エラー:', error); statusP.innerText = `変更失敗: ${error.message}`; statusP.style.color = 'red'; 
                if (error.message.includes("401")) { alert("セッションが切れました。再度ログインしてください。"); window.location.href = '/login'; }
            }
        }
        // --- ▲▲▲ 名前変更関数 (APIパス修正) ▲▲▲ ---

        // 解析関数 (変更なし)
        async function analyzeFolder(folderName) { /* (変更なし) */ }

        // --- ▼▼▼ フォルダ並び替え保存関数を新規追加 ▼▼▼ ---
        async function saveFolderOrder(c1, c2, c3, listContainerElement) {
            // 1. DOMから現在のフォルダ名の順序を読み取る
            const items = listContainerElement.querySelectorAll('.gallery-item span');
            const orderedFolderNames = Array.from(items).map(span => span.innerText);
            
            statusP.innerText = '並び順を保存中...';
            statusP.style.color = 'blue';

            try {
                const response = await fetch('/api/folders/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category1: c1,
                        category2: c2,
                        category3: c3,
                        orderedFolderNames: orderedFolderNames
                    })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
                
                statusP.innerText = data.message;
                statusP.style.color = 'green';

            } catch (error) {
                console.error('並び順 保存エラー:', error);
                statusP.innerText = `保存失敗: ${error.message}`;
                statusP.style.color = 'red';
                if (error.message.includes("401")) {
                    alert("セッションが切れました。再度ログインしてください。");
                    window.location.href = '/login';
                }
                // エラーが起きたらリストを再読み込みして元の順序に戻す
                loadFolders(c1, c2, c3);
            }
        }
        // --- ▲▲▲ フォルダ並び替え保存関数を新規追加 ▲▲▲ ---

        // --- 認証機能 (ログアウト処理) (変更なし) ---
        function setupLogoutButton() { /* (変更なし) */ }
    </script>
</body>
</html>