<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>画像アップローダー (D&D対応)</title>
    <style>
        /* (基本スタイルはほぼ変更なし) */
        body { font-family: sans-serif; line-height: 1.6; padding: 1em 2em; }
        hr { margin: 2em 0; }
        input[type="text"], input[type="search"], select { padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 95%; margin-bottom: 5px; }
        button { padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        #upload-section { background: #f9f9f9; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px 20px; }
        #upload-section label { font-weight: bold; display: block; margin-bottom: 3px; }
        #uploadStatus { font-weight: bold; grid-column: span 3; }
        #csvDownloader { display: inline-block; padding: 8px 12px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; }
        #gallery-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .gallery-column { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; min-height: 200px; }
        .gallery-item { padding: 8px; border: 1px solid #ccc; border-radius: 5px; background-color: #f4f4f4; font-weight: bold; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .gallery-item.active { background-color: #007bff; color: white; border-color: #007bff; }
        .gallery-item span { flex-grow: 1; margin-right: 5px; }
        .action-buttons { display: flex; gap: 3px; flex-shrink: 0; }
        .edit-btn, .delete-btn { border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-weight: bold; line-height: 20px; text-align: center; color: white; }
        .edit-btn { background: #ffc107; } .edit-btn:hover { background: #e0a800; }
        .delete-btn { background: #dc3545; } .delete-btn:hover { background: #c82333; }
        #search-section { margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px; }
        #searchInput { width: 300px; padding: 8px; }
        #image-gallery-container { grid-column: span 4; display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 2px solid #eee; }
        .gallery-image { width: 100%; height: 130px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px; }
        .new-input { display: none; margin-top: 5px; }

        /* ▼▼▼ ドラッグ＆ドロップ用のスタイル ▼▼▼ */
        #dropZone {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-top: 10px;
            transition: background-color 0.2s ease;
        }
        #dropZone.drag-over {
            background-color: #e9ecef;
            border-color: #007bff;
        }
        #fileInfo { margin-top: 10px; font-style: italic; }
        /* ▲▲▲ ドラッグ＆ドロップ用スタイルここまで ▲▲▲ */
    </style>
</head>
<body>

    {/* ▼▼▼ 改造点1: アップロード欄にドロップゾーンを追加 ▼▼▼ */}
    <div id="upload-section">
        <div><label for="cat1Select">1. 大カテゴリ:</label><select id="cat1Select"></select><input type="text" id="cat1NewInput" class="new-input" placeholder="新しい大カテゴリ名"></div>
        <div><label for="cat2Select">2. 中カテゴリ:</label><select id="cat2Select"></select><input type="text" id="cat2NewInput" class="new-input" placeholder="新しい中カテゴリ名"></div>
        <div><label for="cat3Select">3. 小カテゴリ:</label><select id="cat3Select"></select><input type="text" id="cat3NewInput" class="new-input" placeholder="新しい小カテゴリ名"></div>
        <div><label for="folderInput">4. フォルダ名:</label><input type="text" id="folderInput" value="default_folder"></div>
        <div style="grid-column: span 2;">
            <p style="margin-top:20px;">5. ファイルを選択 または ドラッグ＆ドロップ</p>
            {/* --- ドロップゾーン --- */}
            <div id="dropZone">
                ここにファイルをドラッグ＆ドロップ<br>または
                <input type="file" id="imageInput" accept="image/*" multiple style="display: none;"> {/* input自体は隠す */}
                <button type="button" onclick="document.getElementById('imageInput').click();">ファイルを選択</button> {/* このボタンでinputを起動 */}
                <div id="fileInfo">選択されていません</div>
            </div>
            <button id="uploadButton" style="margin-top: 15px;">アップロード</button>
        </div>
        <p id="uploadStatus" style="grid-column: span 3;"></p>
    </div>
    {/* ▲▲▲ 改造点1ここまで ▲▲▲ */}

    {/* (以降のHTML構造は変更なし) */}
    <hr>
    <h3>履歴のダウンロード</h3><p>現在選択中の**フォルダ**のCSVをダウンロードします。</p><a href="#" id="csvDownloader" style="visibility: hidden;">CSVダウンロード</a><p id="csv-status-text">(フォルダを選択するとボタンが有効になります)</p><hr>
    <h3>階層別 ギャラリー</h3><p>大 → 中 → 小 → フォルダ の順に選択。(Eで編集、Xで削除)</p>
    <div id="gallery-section">
        <div id="cat1-container" class="gallery-column"><h4>大カテゴリ</h4><p class="loading-status">読込中...</p></div>
        <div id="cat2-container" class="gallery-column"><h4>中カテゴリ</h4><p class="loading-status"></p></div>
        <div id="cat3-container" class="gallery-column"><h4>小カテゴリ</h4><p class="loading-status"></p></div>
        <div id="folder-container" class="gallery-column"><h4>フォルダ</h4><p class="loading-status"></p></div>
    </div>
    <div id="search-section" style="display: none;"><label for="searchInput">画像検索:</label><input type="search" id="searchInput" placeholder="..."></div>
    <div id="image-gallery-container"></div>

    {/* ▼▼▼ 改造点2: スクリプト(JavaScript)にD&D処理を追加 ▼▼▼ */}
    <script>
        // --- HTML要素を取得 (dropZone, fileInfo を追加) ---
        const fileInput = document.getElementById('imageInput');
        const cat1Select = document.getElementById('cat1Select'); const cat1NewInput = document.getElementById('cat1NewInput');
        const cat2Select = document.getElementById('cat2Select'); const cat2NewInput = document.getElementById('cat2NewInput');
        const cat3Select = document.getElementById('cat3Select'); const cat3NewInput = document.getElementById('cat3NewInput');
        const folderInput = document.getElementById('folderInput');
        const uploadButton = document.getElementById('uploadButton');
        const statusP = document.getElementById('uploadStatus');
        const cat1Container = document.getElementById('cat1-container'); const cat2Container = document.getElementById('cat2-container'); const cat3Container = document.getElementById('cat3-container'); const folderContainer = document.getElementById('folder-container');
        const galleryContainer = document.getElementById('image-gallery-container');
        const csvButton = document.getElementById('csvDownloader'); const csvStatus = document.getElementById('csv-status-text');
        const searchSection = document.getElementById('search-section'); const searchInput = document.getElementById('searchInput');
        const dropZone = document.getElementById('dropZone'); // ★ 追加
        const fileInfo = document.getElementById('fileInfo'); // ★ 追加

        let selections = { cat1: null, cat2: null, cat3: null, folder: null };

        // --- ドラッグ＆ドロップ イベントリスナー ---
        dropZone.addEventListener('dragover', (event) => {
            event.preventDefault(); // ブラウザのデフォルト動作（ファイルを開く）を防ぐ
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        dropZone.addEventListener('drop', (event) => {
            event.preventDefault(); // ブラウザのデフォルト動作を防ぐ
            dropZone.classList.remove('drag-over');
            const files = event.dataTransfer.files; // ドロップされたファイルを取得
            if (files.length > 0) {
                fileInput.files = files; // input要素にファイルを設定
                updateFileInfo(); // ファイル情報を更新
            }
        });
        // input要素でファイルが選択された時もファイル情報を更新
        fileInput.addEventListener('change', updateFileInfo);

        // ファイル情報表示を更新する関数
        function updateFileInfo() {
            if (fileInput.files.length > 0) {
                fileInfo.textContent = `${fileInput.files.length} ファイル選択中`;
            } else {
                fileInfo.textContent = '選択されていません';
            }
        }

        // --- アップロード機能 (★ファイル取得方法を input から直接取得するように変更) ---
        uploadButton.addEventListener('click', async () => {
            const files = fileInput.files; // ★ input要素から直接ファイルを取得
            const cat1 = cat1Select.value === '_new_' ? cat1NewInput.value.trim() : cat1Select.value;
            const cat2 = cat2Select.value === '_new_' ? cat2NewInput.value.trim() : cat2Select.value;
            const cat3 = cat3Select.value === '_new_' ? cat3NewInput.value.trim() : cat3Select.value;
            const folderName = folderInput.value.trim();

            if (files.length === 0 || !cat1 || !cat2 || !cat3 || !folderName) {
                alert('すべてのカテゴリ・フォルダ名を入力/選択し、ファイルを選択/ドロップしてください。'); return;
            }
            const formData = new FormData();
            formData.append('category1', cat1); formData.append('category2', cat2);
            formData.append('category3', cat3); formData.append('folderName', folderName);
            for (let i = 0; i < files.length; i++) { formData.append('imageFiles', files[i]); }

            statusP.style.color = 'blue'; statusP.innerText = `アップロード中...`;
            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const data = await response.json();
                if (response.ok) {
                    statusP.style.color = 'green'; statusP.innerText = data.message;
                    fileInput.value = ''; // inputをクリア
                    updateFileInfo(); // ファイル情報表示もクリア
                    loadCat1();
                } else { throw new Error(data.message); }
            } catch (error) { statusP.style.color = 'red'; statusP.innerText = `失敗: ${error.message}`; }
        });

        // --- ギャラリー機能 (以下、変更なし) ---
        document.addEventListener('DOMContentLoaded', () => { loadCat1(); setupSelectListeners(); });
        function populateSelect(selectElement, items, currentSelection) { /* ... */ }
        function setupSelectListeners() { /* ... */ }
        function handleSelectChange(selectElement, newInputElement, level) { /* ... */ }
        function resetUploadUI(startLevel, createOnly = false){ /* ... */ }
        function resetAndAddCreateOption(selectElement) { /* ... */ }
        async function loadCat1() { /* ... */ }
        async function loadCat1Options(){ /* ... */ }
        async function loadCat2(cat1) { /* ... */ }
        async function loadCat2Options(cat1){ /* ... */ }
        async function loadCat3(cat1, cat2) { /* ... */ }
        async function loadCat3Options(cat1, cat2){ /* ... */ }
        async function loadFolders(cat1, cat2, cat3) { /* ... */ }
        async function loadList(apiUrl, container, title, onClickCallback, addActionButtons = false, level = 0) { /* ... */ }
        function resetUI(startLevel) { /* ... */ }
        async function loadImages(folderName) { /* ... */ }
        let searchTimeout; searchInput.addEventListener('input', () => { /* ... */ });
        async function displayImages(folderName, searchTerm) { /* ... */ }
        async function deleteItem(itemName, level) { /* ... */ }
        async function renameItem(oldItemName, level) { /* ... */ }

        // --- 省略した関数の中身 (前のコードと同じ) ---
        // populateSelect, setupSelectListeners, handleSelectChange, resetUploadUI, resetAndAddCreateOption
        // loadCat1, loadCat1Options, loadCat2, loadCat2Options, loadCat3, loadCat3Options, loadFolders
        // loadList, resetUI, loadImages, searchInput listener, displayImages, deleteItem, renameItem
    </script>
    </body>
</html>