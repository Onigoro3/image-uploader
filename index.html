<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; line-height: 1.6; padding: 10px; margin: 0; background-color: #f4f6f9; color: #333; }
        
        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        #auth-status { 
            position: fixed; top: 0; left: 0; width: 100%; background: #fff; padding: 10px 20px; 
            border-bottom: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 1000; 
            display: flex; justify-content: flex-end; align-items: center; box-sizing: border-box;
        }
        #username-display { margin-right: 15px; font-weight: bold; color: #555; font-size: 0.9rem; }
        #auth-status button { 
            background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; 
            cursor: pointer; margin-left: 8px; font-size: 0.85rem; transition: background 0.2s;
        }
        #auth-status button:hover { opacity: 0.9; }
        #personal-btn { background: #17a2b8 !important; }
        #fix-db-btn { background: #ffc107 !important; color: #333 !important; }
        
        #main-content { margin-top: 70px; max-width: 1200px; margin-left: auto; margin-right: auto; }
        hr { margin: 2em 0; border: 0; border-top: 1px solid #e0e0e0; }
        
        /* --- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  --- */
        input[type="text"], input[type="search"], select { 
            padding: 10px; border: 1px solid #ccc; border-radius: 5px; 
            width: 100%; box-sizing: border-box; margin-bottom: 10px; font-size: 16px;
        }
        button { padding: 10px 20px; cursor: pointer; border-radius: 5px; font-size: 14px; font-weight: bold; border: none; }

        /* ãƒ‘ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .panel { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        #upload-section { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        #upload-section label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em; color: #555; }
        #uploadStatus { font-weight: bold; grid-column: span 3; margin-top: 10px; word-break: break-all; }
        
        #dropZone { 
            border: 2px dashed #cbd5e0; padding: 30px; text-align: center; background: #f8fafc; 
            border-radius: 6px; cursor: pointer; transition: all 0.2s; color: #666;
        }
        #dropZone:hover, #dropZone.drag-over { background-color: #eef2ff; border-color: #6366f1; color: #4f46e5; }

        /* ã‚®ãƒ£ãƒ©ãƒªãƒ¼é¸æŠ */
        #gallery-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .gallery-column { border: 1px solid #e2e8f0; padding: 0; border-radius: 6px; background: #fff; height: 250px; overflow-y: auto; }
        .gallery-column h4 { margin: 0; padding: 8px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; font-size: 0.9em; text-align: center; color: #475569; position: sticky; top: 0; }
        
        .gallery-item { 
            padding: 8px 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; font-size: 14px; 
            display: flex; justify-content: space-between; align-items: center; transition: background 0.1s;
        }
        .gallery-item:hover { background-color: #f8fafc; }
        .gallery-item.active { background-color: #3b82f6; color: white; }
        
        /* --- å•†å“ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #search-section { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        #image-gallery-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        
        .image-item { 
            border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; overflow: hidden; 
            position: relative; transition: transform 0.2s, box-shadow 0.2s; 
            display: flex; flex-direction: column;
        }
        .image-item:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .img-wrapper { width: 100%; aspect-ratio: 1/1; background: #f1f5f9; position: relative; }
        .gallery-image { width: 100%; height: 100%; object-fit: contain; display: block; }
        .pdf-icon { 
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; background: #fff1f2; color: #e11d48; 
            font-weight: bold; text-decoration: none; 
        }

        /* å•†å“æƒ…å ±è©³ç´° */
        .product-info { padding: 10px; font-size: 0.85rem; border-top: 1px solid #e2e8f0; flex-grow: 1; display: flex; flex-direction: column; gap: 4px; }
        .p-name { font-weight: bold; color: #1e293b; line-height: 1.4; margin-bottom: 4px; }
        .p-model { color: #64748b; font-size: 0.8rem; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; align-self: flex-start; }
        .p-stats { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 8px; border-top: 1px dashed #e2e8f0; }
        .p-stock { font-weight: bold; }
        .stock-ok { color: #059669; } 
        .stock-ng { color: #dc2626; background: #fee2e2; padding: 0 4px; border-radius: 2px; }
        .p-prices { text-align: right; font-size: 0.8rem; color: #475569; }
        .price-val { font-weight: bold; font-size: 1rem; color: #0f172a; }

        /* CSVç®¡ç† */
        #csv-manage-section { background: #f0fdf4; border: 1px solid #bbf7d0; }
        #csv-file-list { margin-top: 10px; max-height: 150px; overflow-y: auto; background: #fff; border: 1px solid #ddd; padding: 5px; border-radius: 4px; }
        .csv-item { display: flex; justify-content: space-between; align-items: center; padding: 6px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        
        #db-stats { display: flex; gap: 15px; background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #ddd; margin-top: 10px; align-items: center; }
        #db-stats span { font-size: 0.9em; color: #666; }
        #db-stats b { font-size: 1.2em; color: #333; }
        #check-mismatch-btn { font-size: 0.8em; padding: 4px 8px; background: #64748b; color: white; border: none; border-radius: 4px; }

        /* --- â˜…é‡è¦ä¿®æ­£: Lightboxã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã®å¼·åˆ¶è¡¨ç¤ºè¨­å®š --- */
        .sl-wrapper .sl-caption {
            display: block !important;
            opacity: 1 !important;
            background: rgba(0, 0, 0, 0.85) !important;
            color: #ffffff !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            padding: 15px !important;
            bottom: 0 !important;
            position: fixed !important;
            width: 100% !important;
            text-align: center !important;
            z-index: 999999 !important; /* æœ€å‰é¢ã«å¼·åˆ¶ */
            pointer-events: none; /* ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãŒæ“ä½œã‚’é‚ªé­”ã—ãªã„ã‚ˆã†ã« */
        }

        @media (max-width: 768px) {
            #upload-section, #gallery-section { grid-template-columns: 1fr; }
            #gallery-section { grid-template-columns: 1fr 1fr; }
            #image-gallery-container { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
        }
    </style>
</head>
<body>
    <div id="auth-status">
        <span id="username-display">...</span>
        <button id="fix-db-btn" title="ãƒ†ãƒ¼ãƒ–ãƒ«ä¿®å¾©">âš ï¸DBä¿®å¾©</button>
        <button id="personal-btn" onclick="location.href='/personal'">å€‹äººã‚¢ãƒ«ãƒãƒ </button>
        <button id="logoutButton">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div id="main-content">
        <div class="panel">
            <h3>ğŸ“¤ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
            <div id="upload-section">
                <div><label>1. å¤§ã‚«ãƒ†ã‚´ãƒª</label><select id="cat1Select"></select><input type="text" id="cat1NewInput" class="new-input" style="display:none" placeholder="æ–°è¦"></div>
                <div><label>2. ä¸­ã‚«ãƒ†ã‚´ãƒª</label><select id="cat2Select"></select><input type="text" id="cat2NewInput" class="new-input" style="display:none" placeholder="æ–°è¦"></div>
                <div><label>3. å°ã‚«ãƒ†ã‚´ãƒª</label><select id="cat3Select"></select><input type="text" id="cat3NewInput" class="new-input" style="display:none" placeholder="æ–°è¦"></div>
                <div><label>4. ãƒ•ã‚©ãƒ«ãƒ€å</label><input type="text" id="folderInput" value="default_folder"></div>
                <div style="grid-column: span 2;">
                    <label>5. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</label>
                    <div id="dropZone" onclick="document.getElementById('imageInput').click()">
                        ğŸ“‚ ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<br>
                        <span style="font-size:0.85em;">(ç”»åƒ / PDF)</span>
                        <input type="file" id="imageInput" accept="image/*,.pdf" multiple style="display: none;">
                        <div id="fileInfo" style="margin-top:5px; font-weight:bold; color:#3b82f6;">æœªé¸æŠ</div>
                    </div>
                    <button id="uploadButton" style="margin-top: 10px; width:100%; background:#10b981; color:white;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹</button>
                </div>
                <p id="uploadStatus"></p>
            </div>
        </div>

        <div class="panel" id="csv-manage-section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold; color:#166534;">ğŸ“„ å•†å“æƒ…å ±CSVç®¡ç†</span>
                <button onclick="location.href='/api/products/template'" style="background:#475569; color:white; padding:5px 10px; font-size:0.8em;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆDL</button>
            </div>
            <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
                <input type="file" id="productCsvInput" accept=".csv" style="width:auto;">
                <button id="importCsvBtn" style="background:#15803d; color:white; padding:8px 15px;">CSVç™»éŒ²</button>
                <span id="csvImportStatus" style="font-size:0.9em; font-weight:bold;"></span>
            </div>
            
            <div id="db-stats">
                <span>ç”»åƒæ•°: <b id="stat-img">-</b></span>
                <span>å•†å“ãƒ‡ãƒ¼ã‚¿æ•°: <b id="stat-prod">-</b></span>
                <span>é€£æºæ¸ˆã¿: <b id="stat-link" style="color:#15803d;">-</b></span>
                <button id="check-mismatch-btn">ä¸ä¸€è‡´ã‚’è¨ºæ–­</button>
            </div>

            <h4 style="margin:15px 0 5px 0; font-size:0.9em; color:#166534;">ç™»éŒ²å±¥æ­´</h4>
            <div id="csv-file-list"></div>
        </div>

        <div class="panel">
            <h3>ğŸ–¼ï¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ»æ¤œç´¢ <a href="#" id="csvDownloader" style="font-size:0.8em; margin-left:10px; display:none;">[ç¾åœ¨ã®ä¸€è¦§ã‚’CSVä¿å­˜]</a></h3>
            
            <div id="search-section">
                <input type="search" id="searchInput" placeholder="å•†å“åã€å‹ç•ªã€ãƒ•ã‚¡ã‚¤ãƒ«åã§æ¤œç´¢..." style="flex-grow:1; margin-bottom:0;">
                <select id="sortBy" style="width:auto; margin-bottom:0;"><option value="created_at">ç™»éŒ²æ—¥é †</option><option value="title">åå‰é †</option></select>
                <select id="sortOrder" style="width:auto; margin-bottom:0;"><option value="DESC">æ–°ã—ã„é †</option><option value="ASC">å¤ã„é †</option></select>
            </div>

            <div id="gallery-section">
                <div id="cat1-container" class="gallery-column"><h4>å¤§ã‚«ãƒ†ã‚´ãƒª</h4><div class="loading-msg"></div></div>
                <div id="cat2-container" class="gallery-column"><h4>ä¸­ã‚«ãƒ†ã‚´ãƒª</h4><div class="loading-msg"></div></div>
                <div id="cat3-container" class="gallery-column"><h4>å°ã‚«ãƒ†ã‚´ãƒª</h4><div class="loading-msg"></div></div>
                <div id="folder-container" class="gallery-column"><h4>ãƒ•ã‚©ãƒ«ãƒ€</h4><div class="loading-msg"></div></div>
            </div>

            <hr>
            <div id="image-gallery-container"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/auth/check');
                const data = await res.json();
                if (data.loggedIn) {
                    document.getElementById('username-display').textContent = `User: ${data.username}`;
                    initApp();
                } else { window.location.href = '/login'; }
            } catch (e) { window.location.href = '/login'; }
        });

        document.getElementById('logoutButton').addEventListener('click', async () => {
            await fetch('/api/auth/logout', { method: 'POST' }); window.location.href = '/login';
        });

        document.getElementById('fix-db-btn').addEventListener('click', async () => {
            if(!confirm('DBä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
            try { await fetch('/api/admin/init-db', { method: 'POST' }); alert('å®Œäº†'); location.reload(); } catch(e){alert('Error');}
        });

        const els = {
            file: document.getElementById('imageInput'),
            c1: document.getElementById('cat1Select'), c1n: document.getElementById('cat1NewInput'),
            c2: document.getElementById('cat2Select'), c2n: document.getElementById('cat2NewInput'),
            c3: document.getElementById('cat3Select'), c3n: document.getElementById('cat3NewInput'),
            folder: document.getElementById('folderInput'),
            upBtn: document.getElementById('uploadButton'), stat: document.getElementById('uploadStatus'),
            drop: document.getElementById('dropZone'), info: document.getElementById('fileInfo'),
            gal: document.getElementById('image-gallery-container'),
            csv: document.getElementById('csvDownloader'),
            search: document.getElementById('searchInput'), sort: document.getElementById('sortBy'), order: document.getElementById('sortOrder'),
            csvIn: document.getElementById('productCsvInput'), impBtn: document.getElementById('importCsvBtn'), impStat: document.getElementById('csvImportStatus'),
            csvList: document.getElementById('csv-file-list'),
            stImg: document.getElementById('stat-img'), stProd: document.getElementById('stat-prod'), stLink: document.getElementById('stat-link'), checkBtn: document.getElementById('check-mismatch-btn')
        };
        let sels = { c1: null, c2: null, c3: null, f: null };
        let lightbox;

        function initApp() {
            loadCat1(); setupDropZone(); setupSelects(); loadCsvList(); loadStats();
            els.upBtn.onclick = uploadFiles;
            els.search.oninput = debounce(() => loadImages(sels.f, els.search.value), 500);
            els.sort.onchange = els.order.onchange = () => loadImages(sels.f, els.search.value);
            els.impBtn.onclick = importCsv;
            els.checkBtn.onclick = checkMismatch;
        }

        async function loadStats() {
            try {
                const d = await (await fetch('/api/products/stats')).json();
                els.stImg.innerText = d.images; els.stProd.innerText = d.products; els.stLink.innerText = d.linked;
            } catch(e) {}
        }
        async function checkMismatch() {
            try {
                const d = await (await fetch('/api/debug/mismatch')).json();
                let msg = 'ã€ä¸ä¸€è‡´è¨ºæ–­ã€‘\n';
                if(d.unlinkedProducts.length) { msg+='\nâ—CSVã«ã‚ã‚‹ãŒç”»åƒãŒãªã„(ä¾‹):\n'+d.unlinkedProducts.map(p=>`ãƒ»${p.product_name} (ç”»åƒ: ${p.image_filename})`).join('\n'); }
                else { msg+='\nâ—CSVãƒ‡ãƒ¼ã‚¿ã¯ç´ä»˜ã„ã¦ã„ã¾ã™'; }
                msg+='\n\n';
                if(d.recentImages.length) { msg+='\nâ—ç”»åƒã¯ã‚ã‚‹ãŒCSVãŒãªã„(ä¾‹):\n'+d.recentImages.map(i=>`ãƒ»${i.title.split('/').pop()}`).join('\n'); }
                alert(msg);
            } catch(e){ alert('Error'); }
        }

        async function loadCsvList() {
            try {
                const list = await (await fetch('/api/products/files')).json();
                els.csvList.innerHTML = list.length ? '' : '<div style="padding:10px; color:#999;">å±¥æ­´ãªã—</div>';
                list.forEach(f => {
                    const div = document.createElement('div'); div.className='csv-item';
                    div.innerHTML = `<span class="csv-name">${f.filename}</span><div class="csv-actions"><button onclick="downloadCsvFile(${f.id})" style="background:#17a2b8; color:white; border:none;">DL</button><button onclick="delCsv(${f.id})" style="background:#dc3545; color:white; border:none;">å‰Šé™¤</button></div>`;
                    els.csvList.appendChild(div);
                });
            } catch(e) {}
        }
        async function delCsv(id) { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { await fetch(`/api/products/files/${id}`,{method:'DELETE'}); loadCsvList(); loadStats(); if(sels.f)loadImages(sels.f,els.search.value); } }
        async function importCsv() {
            if(!els.csvIn.files.length) return alert('CSVã‚’é¸æŠ');
            const fd = new FormData(); fd.append('csvFile', els.csvIn.files[0]);
            els.impStat.innerText="ç™»éŒ²ä¸­...";
            try {
                const r = await fetch('/api/products/import', {method:'POST', body:fd});
                if(!r.ok) throw new Error();
                els.impStat.innerText="å®Œäº†"; els.impStat.style.color="green"; loadCsvList(); loadStats();
                if(sels.f) loadImages(sels.f, els.search.value);
            } catch(e) { els.impStat.innerText="å¤±æ•—"; els.impStat.style.color="red"; }
        }
        function downloadCsvFile(id) { window.location.href = `/api/products/files/${id}/download`; }

        async function loadImages(f, q='') {
            if(!f && !q) return;
            els.gal.innerHTML = '<p style="grid-column:span 4; text-align:center; color:#666;">èª­ã¿è¾¼ã¿ä¸­...</p>';
            const p = new URLSearchParams({ cat1: sels.c1||'', cat2: sels.c2||'', cat3: sels.c3||'', folder: f||'', q: q, sort: els.sort.value, order: els.order.value });
            try {
                const r = await fetch(`/api/search?${p}`);
                const d = await r.json();
                els.gal.innerHTML = d.length ? '' : '<p style="grid-column:span 4; text-align:center; color:#888;">è©²å½“ãªã—</p>';
                
                d.forEach(img => {
                    const div = document.createElement('div'); div.className = 'image-item';
                    const name = img.title.split('/').pop();
                    
                    let infoHtml = '', captionHtml = '';
                    if(img.product_name) {
                        const stockText = (img.stock && img.stock > 0) ? `åœ¨åº«: ${img.stock}` : `åœ¨åº«åˆ‡ã‚Œ`;
                        const stockClass = (img.stock && img.stock > 0) ? 'stock-ok' : 'stock-ng';
                        
                        infoHtml = `<div class="product-info"><div class="p-name" title="${img.product_name}">${img.product_name}</div><div class="p-model">${img.model_num1 || '-'} ${img.model_num2 || ''}</div><div class="p-stats"><span class="p-stock ${stockClass}">${stockText}</span><div class="p-prices"><div>EC: <span class="price-val">Â¥${img.ec_price ? img.ec_price.toLocaleString() : '-'}</span></div><div>ãƒ¡ãƒ«ã‚«ãƒª: Â¥${img.mercari_price ? img.mercari_price.toLocaleString() : '-'}</div></div></div></div>`;
                        
                        // â˜…ä¿®æ­£: ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆé»’å¸¯ï¼‰ã®å†…å®¹ã‚’å®‰å…¨ã«ä½œæˆ
                        captionHtml = `
                            <div style='font-size:16px; font-weight:bold; margin-bottom:5px;'>${img.product_name}</div>
                            <div style='font-size:13px; color:#ccc;'>${img.model_num1||''} ${img.model_num2||''}</div>
                            <div style='margin:8px 0; font-weight:bold; color:${img.stock>0?'#4ade80':'#ff9999'};'>${stockText}</div>
                            <div style='font-size:13px; border-top:1px solid #555; padding-top:5px; margin-top:5px;'>
                                ECä¾¡æ ¼: Â¥${img.ec_price} / ãƒ¡ãƒ«ã‚«ãƒª: Â¥${img.mercari_price}
                            </div>
                        `;
                    } else {
                        infoHtml = `<div class="product-info" style="color:#999;"><div class="p-name" style="font-weight:normal;">${name}</div><div style="margin-top:10px; font-size:0.8em;">å•†å“æƒ…å ±ãªã—</div></div>`;
                        captionHtml = `${name}<br><span style='font-size:0.8em; color:#ccc;'>(å•†å“æƒ…å ±æœªç™»éŒ²)</span>`;
                    }

                    let mediaHtml = '';
                    if (img.url.toLowerCase().endsWith('.pdf')) {
                        mediaHtml = `<div class="img-wrapper"><a href="${img.url}" target="_blank" class="pdf-icon">ğŸ“„ PDF<br><span style="font-size:0.7em; font-weight:normal;">${name}</span></a></div>`;
                    } else {
                        // â˜…ä¿®æ­£: createElementã‚’ä½¿ã£ã¦å±æ€§ã‚’ã‚»ãƒƒãƒˆï¼ˆã“ã‚ŒãŒä¸€ç•ªå®‰å…¨ï¼‰
                        // ã“ã“ã§ã¯æ–‡å­—åˆ—çµåˆã§ã¯ãªãã€å¾Œã§DOMã«ã‚»ãƒƒãƒˆã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«è¿‘ã„å½¢ã‚’ã¨ã‚‹ãŸã‚
                        // data-title å±æ€§ã«ã‚»ãƒƒãƒˆã™ã‚‹
                        mediaHtml = `<div class="img-wrapper"><a href="${img.url}" class="lightbox-link" data-title="${captionHtml.replace(/"/g, '&quot;')}"><img src="${img.url}" class="gallery-image" alt="${name}"></a></div>`;
                    }

                    div.innerHTML = mediaHtml + infoHtml;
                    els.gal.appendChild(div);
                });
                
                if(lightbox) lightbox.destroy();
                // â˜…ä¿®æ­£: data-title å±æ€§ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®š
                lightbox = new SimpleLightbox('#image-gallery-container .lightbox-link', { 
                    captionsData: 'data-title', 
                    captionDelay: 0,
                    captionPosition: 'bottom'
                });
                
                els.csv.style.display = f ? 'inline' : 'none';
                if(f) els.csv.href = `/download-csv?folder=${f}&cat1=${sels.c1}&cat2=${sels.c2}&cat3=${sels.c3}`;
            } catch(e) { els.gal.innerHTML = `<p style="color:red;">${e.message}</p>`; }
        }

        // (ä»¥ä¸‹å¤‰æ›´ãªã—)
        async function loadList(u,i,t,cb){const d=document.getElementById(i);d.innerHTML=`<h4>${t}</h4><div style="padding:10px; color:#999;">Loading...</div>`;try{const r=await fetch(u);const j=await r.json();d.innerHTML=`<h4>${t}</h4>`;j.forEach(v=>{const e=document.createElement('div');e.className='gallery-item';e.innerText=v;e.onclick=()=>{d.querySelectorAll('.gallery-item').forEach(x=>x.classList.remove('active'));e.classList.add('active');cb(v);};d.appendChild(e);});}catch(e){}}
        async function loadOpts(u,s){try{const r=await fetch(u);const j=await r.json();s.innerHTML='<option value="">--</option>';j.forEach(v=>s.innerHTML+=`<option value="${v}">${v}</option>`);s.innerHTML+='<option value="_new_">+æ–°</option>';}catch(e){}}
        const loadCat1=()=>{resetUI(1);loadList('/api/cat1','cat1-container','å¤§',v=>{sels.c1=v;els.c1.value=v;checkNew(els.c1,els.c1n);loadCat2(v);});loadOpts('/api/cat1',els.c1);};
        const loadCat2=(c)=>{resetUI(2);loadList(`/api/cat2/${c}`,'cat2-container','ä¸­',v=>{sels.c2=v;els.c2.value=v;checkNew(els.c2,els.c2n);loadCat3(c,v);});loadOpts(`/api/cat2/${c}`,els.c2);};
        const loadCat3=(c1,c2)=>{resetUI(3);loadList(`/api/cat3/${c1}/${c2}`,'cat3-container','å°',v=>{sels.c3=v;els.c3.value=v;checkNew(els.c3,els.c3n);loadFolder(c1,c2,v);});loadOpts(`/api/cat3/${c1}/${c2}`,els.c3);};
        const loadFolder=(c1,c2,c3)=>{resetUI(4);loadList(`/api/folders/${c1}/${c2}/${c3}`,'folder-container','ãƒ•ã‚©ãƒ«ãƒ€',v=>{sels.f=v;els.folder.value=v;loadImages(v);});};
        function resetUI(l){if(l<=1)document.getElementById('cat2-container').innerHTML='<h4>ä¸­</h4>';if(l<=2)document.getElementById('cat3-container').innerHTML='<h4>å°</h4>';if(l<=3)document.getElementById('folder-container').innerHTML='<h4>ãƒ•ã‚©ãƒ«ãƒ€</h4>';if(l<=4)els.gal.innerHTML='';}
        function setupDropZone(){els.drop.ondragover=e=>{e.preventDefault();els.drop.classList.add('drag-over');};els.drop.ondragleave=()=>els.drop.classList.remove('drag-over');els.drop.ondrop=e=>{e.preventDefault();els.drop.classList.remove('drag-over');els.file.files=e.dataTransfer.files;els.info.innerText=els.file.files.length+' Files';};els.file.onchange=()=>els.info.innerText=els.file.files.length+' Files';}
        function setupSelects(){const h=(s,i,l)=>{checkNew(s,i);if(s.value!=='_new_'){if(l===1)loadCat2(s.value);if(l===2)loadCat3(sels.c1,s.value);}};els.c1.onchange=()=>h(els.c1,els.c1n,1);els.c2.onchange=()=>h(els.c2,els.c2n,2);els.c3.onchange=()=>checkNew(els.c3,els.c3n);}
        function checkNew(s,i){i.style.display=s.value==='_new_'?'block':'none';}
        async function uploadFiles(){const fd=new FormData();fd.append('category1',els.c1.value==='_new_'?els.c1n.value:els.c1.value);fd.append('category2',els.c2.value==='_new_'?els.c2n.value:els.c2.value);fd.append('category3',els.c3.value==='_new_'?els.c3n.value:els.c3.value);fd.append('folderName',els.folder.value);for(let f of els.file.files)fd.append('imageFiles',f);els.stat.innerText='UP...';try{const r=await fetch('/upload',{method:'POST',body:fd});if(!r.ok)throw 1;els.stat.innerText='OK';els.file.value='';loadCat1();loadStats();}catch(e){els.stat.innerText='Err';}}
        function debounce(f,w){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>f.apply(this,a),w);};}
    </script>
</body>
</html>