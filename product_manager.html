<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•†å“ç®¡ç† - ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
    <style>
        body { font-family: sans-serif; padding: 10px; margin: 0; background: #f0fdf4; }
        #nav-bar { padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; background: #fff; margin-bottom:20px;}
        a { color: #007bff; text-decoration: none; }
        
        .panel { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; max-width: 800px; margin-left: auto; margin-right: auto; }
        h3 { color: #166534; border-bottom: 2px solid #bbf7d0; padding-bottom: 10px; margin-top: 0; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        #db-stats { display: flex; justify-content: space-around; background: #e8f5e9; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        #db-stats div { text-align: center; }
        #db-stats b { display: block; font-size: 1.5em; color: #333; }
        #db-stats span { font-size: 0.9em; color: #666; }
        #check-mismatch-btn { background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }

        /* ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒªã‚¢ */
        .import-area { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px; }
        input[type="file"] { flex-grow: 1; }
        button { padding: 10px 20px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        #importCsvBtn { background: #15803d; color: white; }
        #dlTemplateBtn { background: #475569; color: white; font-size: 0.9em; }

        /* ãƒªã‚¹ãƒˆ */
        #csv-file-list { margin-top: 10px; }
        .csv-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background: #fff; }
        .csv-item:last-child { border-bottom: none; }
        .csv-info { display: flex; flex-direction: column; }
        .csv-name { font-weight: bold; }
        .csv-date { font-size: 0.8em; color: #888; }
        .csv-actions button { margin-left: 5px; padding: 5px 10px; font-size: 12px; }
    </style>
</head>
<body>
    <div id="nav-bar">
        <span>ğŸ“„ å•†å“æƒ…å ±ç®¡ç†</span>
        <a href="/">ç”»åƒä¸€è¦§ã¸æˆ»ã‚‹</a>
    </div>

    <div class="panel">
        <h3>ç¾åœ¨ã®ç™»éŒ²çŠ¶æ³</h3>
        <div id="db-stats">
            <div><span id="stat-img">-</span><br><span>ç”»åƒ</span></div>
            <div><span id="stat-prod">-</span><br><span>å•†å“ãƒ‡ãƒ¼ã‚¿</span></div>
            <div><span id="stat-link" style="color:#15803d;">-</span><br><span>ç´ä»˜ã‘æ¸ˆã¿</span></div>
        </div>
        <div style="text-align: center;">
            <button id="check-mismatch-btn">ç´ä»˜ã‘ã‚¨ãƒ©ãƒ¼ã‚’è¨ºæ–­ã™ã‚‹</button>
        </div>
    </div>

    <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>CSVç™»éŒ²</h3>
            <button id="dlTemplateBtn">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆDL</button>
        </div>
        
        <div class="import-area">
            <input type="file" id="productCsvInput" accept=".csv">
            <button id="importCsvBtn">ç™»éŒ²å®Ÿè¡Œ</button>
        </div>
        <p id="csvImportStatus" style="font-weight: bold; color: green;"></p>

        <h4>ç™»éŒ²å±¥æ­´ãƒ»å‰Šé™¤</h4>
        <div id="csv-file-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <script>
        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        fetch('/api/auth/check').then(r=>r.json()).then(d=>{if(!d.loggedIn)location.href='/login'});

        const els = {
            stImg: document.getElementById('stat-img'), stProd: document.getElementById('stat-prod'), stLink: document.getElementById('stat-link'),
            checkBtn: document.getElementById('check-mismatch-btn'),
            csvIn: document.getElementById('productCsvInput'), impBtn: document.getElementById('importCsvBtn'),
            impStat: document.getElementById('csvImportStatus'), csvList: document.getElementById('csv-file-list'),
            dlTmp: document.getElementById('dlTemplateBtn')
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadCsvList();
        });

        els.dlTmp.onclick = () => location.href = '/api/products/template';
        els.impBtn.onclick = importCsv;
        els.checkBtn.onclick = checkMismatch;

        async function loadStats() {
            try {
                const d = await (await fetch('/api/products/stats')).json();
                els.stImg.innerText = d.images; els.stProd.innerText = d.products; els.stLink.innerText = d.linked;
            } catch(e) {}
        }

        async function checkMismatch() {
            try {
                const d = await (await fetch('/api/debug/mismatch')).json();
                let msg = 'ã€è¨ºæ–­çµæœã€‘\n\n';
                if(d.unlinkedProducts.length) msg += 'âš  å•†å“ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚‹ãŒç”»åƒãŒãªã„ (ä¾‹):\n' + d.unlinkedProducts.map(p=>`ãƒ»${p.product_name}`).join('\n') + '\n\n';
                else msg += 'âœ… å•†å“ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ç´ä»˜ã„ã¦ã„ã¾ã™ã€‚\n\n';
                
                if(d.unlinkedImages.length) msg += 'âš  ç”»åƒã¯ã‚ã‚‹ãŒå•†å“ãƒ‡ãƒ¼ã‚¿ãŒãªã„ (ä¾‹):\n' + d.unlinkedImages.map(i=>`ãƒ»${i.title.split('/').pop()}`).join('\n');
                alert(msg);
            } catch(e) { alert('ã‚¨ãƒ©ãƒ¼'); }
        }

        async function importCsv() {
            if(!els.csvIn.files.length) return alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
            const fd = new FormData(); fd.append('csvFile', els.csvIn.files[0]);
            els.impStat.innerText = "ç™»éŒ²ä¸­...";
            try {
                const r = await fetch('/api/products/import', {method:'POST', body:fd});
                const d = await r.json();
                if(!r.ok) throw new Error(d.message);
                els.impStat.innerText = d.message;
                els.csvIn.value = '';
                loadCsvList(); loadStats();
            } catch(e) { els.impStat.innerText = "ã‚¨ãƒ©ãƒ¼: " + e.message; els.impStat.style.color="red"; }
        }

        async function loadCsvList() {
            try {
                const list = await (await fetch('/api/products/files')).json();
                els.csvList.innerHTML = '';
                if(list.length===0) return els.csvList.innerHTML = '<p style="color:#999; text-align:center;">å±¥æ­´ãªã—</p>';
                
                list.forEach(f => {
                    const date = new Date(f.uploaded_at).toLocaleString('ja-JP');
                    const div = document.createElement('div'); div.className = 'csv-item';
                    div.innerHTML = `
                        <div class="csv-info"><span class="csv-name">${f.filename}</span><span class="csv-date">${date}</span></div>
                        <div class="csv-actions">
                            <button onclick="window.location.href='/api/products/files/${f.id}/download'" style="background:#17a2b8; color:white;">DL</button>
                            <button onclick="delCsv(${f.id})" style="background:#dc3545; color:white;">å‰Šé™¤</button>
                        </div>
                    `;
                    els.csvList.appendChild(div);
                });
            } catch(e) { els.csvList.innerText = 'ã‚¨ãƒ©ãƒ¼'; }
        }

        async function delCsv(id) {
            if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n(ã“ã®CSVã‹ã‚‰ç™»éŒ²ã•ã‚ŒãŸå•†å“æƒ…å ±ã‚‚æ¶ˆãˆã¾ã™)')) return;
            await fetch(`/api/products/files/${id}`, {method:'DELETE'});
            loadCsvList(); loadStats();
        }
    </script>
</body>
</html>