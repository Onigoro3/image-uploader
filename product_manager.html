<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•†å“ç®¡ç† - ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <style>
        /* --- å…¨ä½“è¨­å®š --- */
        body { font-family: "Helvetica Neue", Arial, sans-serif; line-height: 1.6; padding: 10px; margin: 0; background-color: #f0fdf4; color: #333; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        #nav-bar { 
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #bbf7d0; background: #fff; margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #nav-bar span { font-weight: bold; color: #166534; font-size: 1.1em; }
        
        .nav-btn { color: #15803d; text-decoration: none; font-weight: bold; border: 1px solid #15803d; padding: 5px 10px; border-radius: 4px; margin-left: 5px; font-size: 0.9em; cursor: pointer; background: white; }
        .nav-btn:hover { background: #f0fdf4; }
        #fix-db-btn { background: #ffc107; color: #333; border-color: #eab308; }

        .panel { 
            background: #fff; padding: 20px; border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; 
            max-width: 1200px; margin-left: auto; margin-right: auto;
            border: 1px solid #e2e8f0;
        }
        h3 { 
            color: #166534; border-bottom: 2px solid #bbf7d0; 
            padding-bottom: 10px; margin-top: 0; margin-bottom: 15px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* --- ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚«ãƒ©ãƒ  --- */
        #gallery-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .gallery-column { border: 1px solid #e2e8f0; padding: 0; border-radius: 6px; background: #f8fafc; height: 250px; overflow-y: auto; }
        .gallery-column h4 { 
            margin: 0; padding: 8px; background: #e2e8f0; border-bottom: 1px solid #cbd5e1; 
            font-size: 0.85em; text-align: center; color: #475569; position: sticky; top: 0; 
        }
        .gallery-item { 
            padding: 8px 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; font-size: 14px; 
            transition: background 0.1s; background: #fff;
        }
        .gallery-item:hover { background-color: #f0fdf4; }
        .gallery-item.active { background-color: #15803d; color: white; }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .new-input { margin-top: 5px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 90%; display: none; }

        /* --- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ --- */
        #db-stats { display: flex; justify-content: space-around; background: #e8f5e9; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        #db-stats div { text-align: center; }
        #db-stats b { display: block; font-size: 1.5em; color: #333; }
        #db-stats span { font-size: 0.9em; color: #666; }
        #check-mismatch-btn { background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }

        /* --- CSVç™»éŒ²ã‚¨ãƒªã‚¢ --- */
        .import-area { 
            padding: 20px; background: #f0fdf4; border-radius: 6px; border: 2px dashed #bbf7d0; 
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        input[type="file"] { padding: 10px; background: #fff; border-radius: 4px; border: 1px solid #ddd; }
        button { padding: 10px 20px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        #importCsvBtn { background: #15803d; color: white; width: 100%; max-width: 300px; font-size: 1.1em; }
        #dlTemplateBtn { background: #475569; color: white; font-size: 0.85em; padding: 5px 10px; }

        /* --- CSVãƒªã‚¹ãƒˆ --- */
        #csv-file-list { margin-top: 10px; }
        .csv-item { padding: 12px; border: 1px solid #eee; background: #fff; margin-bottom: 5px; border-radius: 4px; border-left: 4px solid #15803d; }
        .csv-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .csv-meta { font-size: 0.85em; color: #666; margin-top: 5px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .csv-tag { background: #e2e8f0; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; color: #333; }
        .csv-actions button { margin-left: 5px; padding: 4px 10px; font-size: 12px; color: white; border-radius: 3px; }

        @media (max-width: 768px) {
            #gallery-section { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div id="nav-bar">
        <span>ğŸ“„ å•†å“æƒ…å ±ç®¡ç†</span>
        <div>
            <button id="fix-db-btn" class="nav-btn">âš ï¸DBä¿®å¾©</button>
            <a href="/" class="nav-btn">ç”»åƒä¸€è¦§ã¸</a>
        </div>
    </div>

    <div class="panel">
        <h3>
            <span>ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªé¸æŠ (ç™»éŒ²å…ˆãƒ»çµã‚Šè¾¼ã¿)</span>
        </h3>
        <p style="font-size:0.9em; color:#666; margin-bottom:10px;">
            é¸æŠã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã«å¯¾ã—ã¦CSVã‚’ç™»éŒ²ã—ã¾ã™ã€‚ã¾ãŸã€ä¸‹ã®ãƒªã‚¹ãƒˆãŒãã®ãƒ•ã‚©ãƒ«ãƒ€ã®CSVã«çµã‚Šè¾¼ã¾ã‚Œã¾ã™ã€‚
        </p>
        <div id="gallery-section">
            <div id="cat1-container" class="gallery-column"><h4>å¤§ã‚«ãƒ†ã‚´ãƒª</h4></div>
            <div id="cat2-container" class="gallery-column"><h4>ä¸­ã‚«ãƒ†ã‚´ãƒª</h4></div>
            <div id="cat3-container" class="gallery-column"><h4>å°ã‚«ãƒ†ã‚´ãƒª</h4></div>
            <div id="folder-container" class="gallery-column"><h4>ãƒ•ã‚©ãƒ«ãƒ€</h4></div>
        </div>
        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px;">
            <input type="text" id="cat1NewInput" class="new-input" placeholder="æ–°è¦ å¤§ã‚«ãƒ†ã‚´ãƒª">
            <input type="text" id="cat2NewInput" class="new-input" placeholder="æ–°è¦ ä¸­ã‚«ãƒ†ã‚´ãƒª">
            <input type="text" id="cat3NewInput" class="new-input" placeholder="æ–°è¦ å°ã‚«ãƒ†ã‚´ãƒª">
            <input type="text" id="folderNewInput" class="new-input" placeholder="æ–°è¦ ãƒ•ã‚©ãƒ«ãƒ€">
        </div>
    </div>

    <div class="panel">
        <h3>
            <span>ğŸ“¥ CSVç™»éŒ²</span>
            <button id="dlTemplateBtn">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆDL</button>
        </h3>
        
        <div class="import-area">
            <div id="selected-path-display" style="font-weight:bold; color:#166534; margin-bottom:5px;">
                ç™»éŒ²å…ˆ: <span style="color:#999;">(ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„)</span>
            </div>
            <input type="file" id="productCsvInput" accept=".csv">
            <button id="importCsvBtn">ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã«CSVã‚’ç™»éŒ²</button>
        </div>
        <p id="csvImportStatus" style="font-weight: bold; color: green; text-align:center;"></p>
    </div>

    <div class="panel">
        <h3>
            <span>ğŸ“‹ ç™»éŒ²æ¸ˆã¿CSVä¸€è¦§</span>
            <div style="font-size:0.8em; font-weight:normal;">
                <button id="check-mismatch-btn" style="background:#f59e0b; border:none; color:white;">ä¸ä¸€è‡´ã‚’è¨ºæ–­</button>
            </div>
        </h3>

        <div id="db-stats">
            <div><span id="stat-img">-</span><br><span>ç”»åƒæ•°</span></div>
            <div><span id="stat-prod">-</span><br><span>å•†å“ãƒ‡ãƒ¼ã‚¿</span></div>
            <div><span id="stat-link" style="color:#15803d;">-</span><br><span>é€£æºæ¸ˆã¿</span></div>
        </div>
        
        <div id="csv-file-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <script>
        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        fetch('/api/auth/check').then(r=>r.json()).then(d=>{if(!d.loggedIn)location.href='/login'});

        // DBä¿®å¾©ãƒœã‚¿ãƒ³
        document.getElementById('fix-db-btn').addEventListener('click', async () => {
            if(!confirm('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹æˆã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\n(ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ã‚‹å ´åˆã«æœ‰åŠ¹ã§ã™)')) return;
            try { 
                const r = await fetch('/api/admin/init-db', { method: 'POST' }); 
                const d = await r.json(); 
                alert(d.message); 
                location.reload(); 
            } catch(e) { alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
        });

        const els = {
            stImg: document.getElementById('stat-img'), stProd: document.getElementById('stat-prod'), stLink: document.getElementById('stat-link'),
            checkBtn: document.getElementById('check-mismatch-btn'),
            csvIn: document.getElementById('productCsvInput'), impBtn: document.getElementById('importCsvBtn'),
            impStat: document.getElementById('csvImportStatus'), csvList: document.getElementById('csv-file-list'),
            dlTmp: document.getElementById('dlTemplateBtn'),
            pathDisp: document.getElementById('selected-path-display'),
            // ã‚«ãƒ†ã‚´ãƒªå…¥åŠ›
            c1n: document.getElementById('cat1NewInput'), c2n: document.getElementById('cat2NewInput'),
            c3n: document.getElementById('cat3NewInput'), fn: document.getElementById('folderNewInput')
        };

        // é¸æŠçŠ¶æ…‹
        let sels = { c1: null, c2: null, c3: null, f: null };
        let csvData = []; // å…¨CSVãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥

        document.addEventListener('DOMContentLoaded', () => {
            loadCat1(); // ã‚«ãƒ†ã‚´ãƒªãƒ„ãƒªãƒ¼èª­ã¿è¾¼ã¿
            loadStats();
            loadCsvList(); // CSVä¸€è¦§èª­ã¿è¾¼ã¿
        });

        els.dlTmp.onclick = () => location.href = '/api/products/template';
        els.impBtn.onclick = importCsv;
        els.checkBtn.onclick = checkMismatch;

        // --- ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿ ---
        async function loadList(url, containerId, title, onClick) {
            const div = document.getElementById(containerId);
            div.innerHTML = `<h4>${title}</h4>`;
            try {
                const r = await fetch(url);
                const data = await r.json();
                if (data.length === 0) div.innerHTML += '<p style="padding:10px; color:#ccc;">ãªã—</p>';
                
                data.forEach(val => {
                    const el = document.createElement('div'); el.className = 'gallery-item';
                    el.innerHTML = `<span>${val}</span>`;
                    el.onclick = () => {
                        div.querySelectorAll('.gallery-item').forEach(x => x.classList.remove('active'));
                        el.classList.add('active');
                        onClick(val);
                    };
                    div.appendChild(el);
                });
                const newBtn = document.createElement('div'); newBtn.className = 'gallery-item';
                newBtn.style.color = '#007bff'; newBtn.innerText = '+ æ–°è¦ä½œæˆ';
                newBtn.onclick = () => {
                    div.querySelectorAll('.gallery-item').forEach(x => x.classList.remove('active'));
                    newBtn.classList.add('active');
                    onClick('_new_');
                };
                div.appendChild(newBtn);
            } catch(e) { div.innerHTML += '<p style="color:red;">ã‚¨ãƒ©ãƒ¼</p>'; }
        }

        const loadCat1 = () => { resetUI(1); loadList('/api/cat1', 'cat1-container', 'å¤§ã‚«ãƒ†ã‚´ãƒª', (v) => { sels.c1 = v; handleSelect(1, v); if(v !== '_new_') loadCat2(v); }); };
        const loadCat2 = (c1) => { resetUI(2); loadList(`/api/cat2/${c1}`, 'cat2-container', 'ä¸­ã‚«ãƒ†ã‚´ãƒª', (v) => { sels.c2 = v; handleSelect(2, v); if(v !== '_new_') loadCat3(c1, v); }); };
        const loadCat3 = (c1, c2) => { resetUI(3); loadList(`/api/cat3/${c1}/${c2}`, 'cat3-container', 'å°ã‚«ãƒ†ã‚´ãƒª', (v) => { sels.c3 = v; handleSelect(3, v); if(v !== '_new_') loadFolder(c1, c2, v); }); };
        const loadFolder = (c1, c2, c3) => { resetUI(4); loadList(`/api/folders/${c1}/${c2}/${c3}`, 'folder-container', 'ãƒ•ã‚©ãƒ«ãƒ€', (v) => { sels.f = v; handleSelect(4, v); }); };

        function resetUI(level) {
            if(level<=1) { document.getElementById('cat2-container').innerHTML='<h4>ä¸­ã‚«ãƒ†ã‚´ãƒª</h4>'; sels.c1=null; }
            if(level<=2) { document.getElementById('cat3-container').innerHTML='<h4>å°ã‚«ãƒ†ã‚´ãƒª</h4>'; sels.c2=null; }
            if(level<=3) { document.getElementById('folder-container').innerHTML='<h4>ãƒ•ã‚©ãƒ«ãƒ€</h4>'; sels.c3=null; }
            if(level<=4) { sels.f=null; }
            updatePathDisplay();
            renderCsvList(); // é¸æŠè§£é™¤æ™‚ã¯å…¨ä»¶è¡¨ç¤º
            const inputs = [els.c1n, els.c2n, els.c3n, els.fn];
            for(let i = level-1; i < 4; i++) inputs[i].style.display = 'none';
        }

        function handleSelect(level, value) {
            const inputs = [els.c1n, els.c2n, els.c3n, els.fn];
            if (value === '_new_') { inputs[level-1].style.display = 'block'; inputs[level-1].focus(); } 
            else { inputs[level-1].style.display = 'none'; }
            updatePathDisplay();
            renderCsvList();
        }

        function updatePathDisplay() {
            const c1 = (sels.c1 === '_new_') ? (els.c1n.value || '(æ–°è¦)') : (sels.c1 || '-');
            const c2 = (sels.c2 === '_new_') ? (els.c2n.value || '(æ–°è¦)') : (sels.c2 || '-');
            const c3 = (sels.c3 === '_new_') ? (els.c3n.value || '(æ–°è¦)') : (sels.c3 || '-');
            els.pathDisp.innerHTML = `ç™»éŒ²å…ˆ: <b>${c1} > ${c2} > ${c3}</b>`;
        }
        
        [els.c1n, els.c2n, els.c3n].forEach(el => el.oninput = updatePathDisplay);

        // --- CSVç®¡ç† ---
        async function loadStats() { try { const d = await (await fetch('/api/products/stats')).json(); els.stImg.innerText = d.images; els.stProd.innerText = d.products; els.stLink.innerText = d.linked; } catch(e) {} }
        async function loadCsvList() { try { const list = await (await fetch('/api/products/files')).json(); csvData = list; renderCsvList(); } catch(e) { els.csvList.innerText = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'; } }

        function renderCsvList() {
            const targetC1 = (sels.c1 && sels.c1 !== '_new_') ? sels.c1 : null;
            const targetC2 = (sels.c2 && sels.c2 !== '_new_') ? sels.c2 : null;
            const targetC3 = (sels.c3 && sels.c3 !== '_new_') ? sels.c3 : null;

            const filtered = csvData.filter(f => {
                // é¸æŠä¸­ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ä¸€è‡´ã™ã‚‹ã‚‚ã® + ã€Œæœªåˆ†é¡ã€ã¯å¸¸ã«è¡¨ç¤ºã™ã‚‹
                if (f.category_1 === 'æœªåˆ†é¡') return true;
                if (targetC1 && f.category_1 !== targetC1) return false;
                if (targetC2 && f.category_2 !== targetC2) return false;
                if (targetC3 && f.category_3 !== targetC3) return false;
                return true;
            });

            els.csvList.innerHTML = '';
            if(filtered.length===0) { els.csvList.innerHTML = '<div style="padding:10px; color:#999; text-align:center;">è©²å½“ã™ã‚‹CSVã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; }

            filtered.forEach(f => {
                const date = new Date(f.uploaded_at).toLocaleString('ja-JP');
                const catLabel = [f.category_1, f.category_2, f.category_3].filter(c=>c && c!=='æœªåˆ†é¡' && c!=='-').join(' > ') || 'æœªåˆ†é¡';
                const div = document.createElement('div'); div.className = 'csv-item';
                div.innerHTML = `
                    <div class="csv-header"><span>${f.filename}</span><div class="csv-actions"><button onclick="editCsv(${f.id}, '${f.filename}', '${f.category_1}', '${f.category_2}', '${f.category_3}')" style="background:#ffc107; color:#000; border:none;">ç·¨é›†</button><button onclick="window.location.href='/api/products/files/${f.id}/download'" style="background:#17a2b8; color:white; border:none;">DL</button><button onclick="delCsv(${f.id})" style="background:#dc3545; color:white; border:none;">å‰Šé™¤</button></div></div>
                    <div class="csv-meta"><span class="csv-tag">ğŸ“‚ ${catLabel}</span><span>ğŸ“… ${date}</span></div>`;
                els.csvList.appendChild(div);
            });
        }

        async function importCsv() {
            if(!els.csvIn.files.length) return alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
            const c1 = sels.c1 === '_new_' ? els.c1n.value : (sels.c1 || 'æœªåˆ†é¡');
            const c2 = sels.c2 === '_new_' ? els.c2n.value : (sels.c2 || '-');
            const c3 = sels.c3 === '_new_' ? els.c3n.value : (sels.c3 || '-');

            const fd = new FormData(); 
            fd.append('csvFile', els.csvIn.files[0]); fd.append('category1', c1); fd.append('category2', c2); fd.append('category3', c3);
            els.impStat.innerText = "ç™»éŒ²ä¸­...";
            try {
                const r = await fetch('/api/products/import', {method:'POST', body:fd});
                const d = await r.json();
                if(!r.ok) throw new Error(d.message);
                els.impStat.innerText = d.message; els.csvIn.value = '';
                loadCsvList(); loadStats();
                if (sels.c1 === '_new_') setTimeout(loadCat1, 1000);
            } catch(e) { els.impStat.innerText = "ã‚¨ãƒ©ãƒ¼: " + e.message; els.impStat.style.color="red"; }
        }

        async function delCsv(id) { if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; await fetch(`/api/products/files/${id}`, {method:'DELETE'}); loadCsvList(); loadStats(); }
        
        async function checkMismatch() {
            try {
                const d = await (await fetch('/api/debug/mismatch')).json();
                let msg = 'ã€è¨ºæ–­çµæœã€‘\n\n';
                if(d.unlinkedProducts.length) msg += 'âš  å•†å“ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚‹ãŒç”»åƒãŒãªã„ (ä¾‹):\n' + d.unlinkedProducts.map(p=>`ãƒ»${p.product_name}`).join('\n') + '\n\n';
                else msg += 'âœ… å•†å“ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ç´ä»˜ã„ã¦ã„ã¾ã™ã€‚\n\n';
                if(d.unlinkedImages.length) msg += 'âš  ç”»åƒã¯ã‚ã‚‹ãŒå•†å“ãƒ‡ãƒ¼ã‚¿ãŒãªã„ (ä¾‹):\n' + d.unlinkedImages.map(i=>`ãƒ»${i.title.split('/').pop()}`).join('\n');
                alert(msg);
            } catch(e) { alert('ã‚¨ãƒ©ãƒ¼'); }
        }

        async function editCsv(id, oldName, oldC1, oldC2, oldC3) {
            const newName = prompt("ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´:", oldName);
            if(newName) {
                try {
                    await fetch(`/api/products/files/${id}`, {
                        method: 'PUT', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: newName, category1: oldC1, category2: oldC2, category3: oldC3 })
                    });
                    loadCsvList();
                } catch(e) { alert('å¤‰æ›´å¤±æ•—'); }
            }
        }
    </script>
</body>
</html>