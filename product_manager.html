<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•†å“ç®¡ç† - ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
    <style>
        body { font-family: sans-serif; padding: 10px; margin: 0; background: #f0fdf4; }
        #nav-bar { padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; background: #fff; margin-bottom:20px;}
        a { color: #007bff; text-decoration: none; }
        
        .panel { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; max-width: 800px; margin-left: auto; margin-right: auto; }
        h3 { color: #166534; border-bottom: 2px solid #bbf7d0; padding-bottom: 10px; margin-top: 0; }
        
        /* å…¥åŠ›ç³» */
        select, input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        .cat-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        #db-stats { display: flex; justify-content: space-around; background: #e8f5e9; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        #db-stats div { text-align: center; }
        #db-stats b { display: block; font-size: 1.5em; color: #333; }
        #db-stats span { font-size: 0.9em; color: #666; }
        #check-mismatch-btn { background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }

        /* ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒªã‚¢ */
        .import-area { padding: 15px; background: #f9f9f9; border-radius: 6px; border: 1px solid #eee; }
        input[type="file"] { margin-bottom: 10px; }
        button { padding: 10px 20px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        #importCsvBtn { background: #15803d; color: white; width: 100%; }
        #dlTemplateBtn { background: #475569; color: white; font-size: 0.9em; }

        /* ãƒªã‚¹ãƒˆ */
        #csv-file-list { margin-top: 10px; }
        .csv-item { padding: 12px; border: 1px solid #eee; background: #fff; margin-bottom: 5px; border-radius: 4px; }
        .csv-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .csv-meta { font-size: 0.85em; color: #666; margin-top: 5px; display: flex; gap: 10px; align-items: center; }
        .csv-tag { background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; }
        .csv-actions button { margin-left: 5px; padding: 4px 8px; font-size: 12px; }

        @media (max-width: 600px) { .cat-group { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="nav-bar">
        <span>ğŸ“„ å•†å“æƒ…å ±ç®¡ç†</span>
        <a href="/">ç”»åƒä¸€è¦§ã¸æˆ»ã‚‹</a>
    </div>

    <div class="panel">
        <h3>ç¾åœ¨ã®ç™»éŒ²çŠ¶æ³</h3>
        <div id="db-stats">
            <div><span id="stat-img">-</span><br><span>ç”»åƒ</span></div>
            <div><span id="stat-prod">-</span><br><span>å•†å“ãƒ‡ãƒ¼ã‚¿</span></div>
            <div><span id="stat-link" style="color:#15803d;">-</span><br><span>ç´ä»˜ã‘æ¸ˆã¿</span></div>
        </div>
        <div style="text-align: center;">
            <button id="check-mismatch-btn">ç´ä»˜ã‘ã‚¨ãƒ©ãƒ¼ã‚’è¨ºæ–­ã™ã‚‹</button>
        </div>
    </div>

    <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>CSVç™»éŒ²</h3>
            <button id="dlTemplateBtn">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆDL</button>
        </div>
        
        <div class="import-area">
            <label style="font-weight:bold; display:block; margin-bottom:5px;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ (ä»»æ„)</label>
            <div class="cat-group">
                <input type="text" id="reg-c1" placeholder="å¤§ã‚«ãƒ†ã‚´ãƒª (ä¾‹: ãƒã‚±ã‚«)">
                <input type="text" id="reg-c2" placeholder="ä¸­ã‚«ãƒ†ã‚´ãƒª (ä¾‹: SV1)">
                <input type="text" id="reg-c3" placeholder="å°ã‚«ãƒ†ã‚´ãƒª">
            </div>

            <input type="file" id="productCsvInput" accept=".csv">
            <button id="importCsvBtn">CSVã‚’ç™»éŒ²ã™ã‚‹</button>
        </div>
        <p id="csvImportStatus" style="font-weight: bold; color: green;"></p>
    </div>

    <div class="panel">
        <h3>ç™»éŒ²æ¸ˆã¿CSVä¸€è¦§</h3>
        <input type="text" id="filter-input" placeholder="ã‚«ãƒ†ã‚´ãƒªã‚„ãƒ•ã‚¡ã‚¤ãƒ«åã§çµã‚Šè¾¼ã¿..." style="margin-bottom:10px;">
        
        <div id="csv-file-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <script>
        fetch('/api/auth/check').then(r=>r.json()).then(d=>{if(!d.loggedIn)location.href='/login'});

        const els = {
            stImg: document.getElementById('stat-img'), stProd: document.getElementById('stat-prod'), stLink: document.getElementById('stat-link'),
            checkBtn: document.getElementById('check-mismatch-btn'),
            csvIn: document.getElementById('productCsvInput'), impBtn: document.getElementById('importCsvBtn'),
            impStat: document.getElementById('csvImportStatus'), csvList: document.getElementById('csv-file-list'),
            dlTmp: document.getElementById('dlTemplateBtn'),
            regC1: document.getElementById('reg-c1'), regC2: document.getElementById('reg-c2'), regC3: document.getElementById('reg-c3'),
            filter: document.getElementById('filter-input')
        };

        let csvData = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadCsvList();
        });

        els.dlTmp.onclick = () => location.href = '/api/products/template';
        els.impBtn.onclick = importCsv;
        els.checkBtn.onclick = checkMismatch;
        els.filter.oninput = renderCsvList;

        async function loadStats() {
            try {
                const d = await (await fetch('/api/products/stats')).json();
                els.stImg.innerText = d.images; els.stProd.innerText = d.products; els.stLink.innerText = d.linked;
            } catch(e) {}
        }

        async function checkMismatch() {
            try {
                const d = await (await fetch('/api/debug/mismatch')).json();
                let msg = 'ã€è¨ºæ–­çµæœã€‘\n\n';
                if(d.unlinkedProducts.length) msg += 'âš  å•†å“ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚‹ãŒç”»åƒãŒãªã„ (ä¾‹):\n' + d.unlinkedProducts.map(p=>`ãƒ»${p.product_name}`).join('\n') + '\n\n';
                else msg += 'âœ… å•†å“ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ç´ä»˜ã„ã¦ã„ã¾ã™ã€‚\n\n';
                if(d.unlinkedImages.length) msg += 'âš  ç”»åƒã¯ã‚ã‚‹ãŒå•†å“ãƒ‡ãƒ¼ã‚¿ãŒãªã„ (ä¾‹):\n' + d.unlinkedImages.map(i=>`ãƒ»${i.title.split('/').pop()}`).join('\n');
                alert(msg);
            } catch(e) { alert('ã‚¨ãƒ©ãƒ¼'); }
        }

        async function importCsv() {
            if(!els.csvIn.files.length) return alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
            const fd = new FormData(); 
            fd.append('csvFile', els.csvIn.files[0]);
            fd.append('category1', els.regC1.value);
            fd.append('category2', els.regC2.value);
            fd.append('category3', els.regC3.value);

            els.impStat.innerText = "ç™»éŒ²ä¸­...";
            try {
                const r = await fetch('/api/products/import', {method:'POST', body:fd});
                const d = await r.json();
                if(!r.ok) throw new Error(d.message);
                els.impStat.innerText = d.message;
                els.csvIn.value = '';
                loadCsvList(); loadStats();
            } catch(e) { els.impStat.innerText = "ã‚¨ãƒ©ãƒ¼: " + e.message; els.impStat.style.color="red"; }
        }

        async function loadCsvList() {
            try {
                const list = await (await fetch('/api/products/files')).json();
                csvData = list;
                renderCsvList();
            } catch(e) { els.csvList.innerText = 'ã‚¨ãƒ©ãƒ¼'; }
        }

        function renderCsvList() {
            const term = els.filter.value.toLowerCase();
            const filtered = csvData.filter(f => 
                (f.filename && f.filename.toLowerCase().includes(term)) || 
                (f.category_1 && f.category_1.toLowerCase().includes(term)) ||
                (f.category_2 && f.category_2.toLowerCase().includes(term))
            );

            els.csvList.innerHTML = '';
            if(filtered.length===0) return els.csvList.innerHTML = '<p style="color:#999; text-align:center;">è©²å½“ãªã—</p>';

            filtered.forEach(f => {
                const date = new Date(f.uploaded_at).toLocaleString('ja-JP');
                const catLabel = [f.category_1, f.category_2, f.category_3].filter(c=>c && c!=='æœªåˆ†é¡' && c!=='-').join(' > ') || 'æœªåˆ†é¡';
                
                const div = document.createElement('div'); div.className = 'csv-item';
                div.innerHTML = `
                    <div class="csv-header">
                        <span>${f.filename}</span>
                        <div class="csv-actions">
                            <button onclick="editCsv(${f.id}, '${f.filename}', '${f.category_1}', '${f.category_2}', '${f.category_3}')" style="background:#ffc107; color:#000;">ç·¨é›†</button>
                            <button onclick="window.location.href='/api/products/files/${f.id}/download'" style="background:#17a2b8; color:white;">DL</button>
                            <button onclick="delCsv(${f.id})" style="background:#dc3545; color:white;">å‰Šé™¤</button>
                        </div>
                    </div>
                    <div class="csv-meta">
                        <span class="csv-tag">ğŸ“‚ ${catLabel}</span>
                        <span>ğŸ“… ${date}</span>
                    </div>
                `;
                els.csvList.appendChild(div);
            });
        }

        async function editCsv(id, oldName, oldC1, oldC2, oldC3) {
            const newName = prompt("ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´:", oldName);
            if(newName === null) return;
            const newC1 = prompt("å¤§ã‚«ãƒ†ã‚´ãƒª:", oldC1 === 'null' ? '' : oldC1);
            const newC2 = prompt("ä¸­ã‚«ãƒ†ã‚´ãƒª:", oldC2 === 'null' ? '' : oldC2);
            const newC3 = prompt("å°ã‚«ãƒ†ã‚´ãƒª:", oldC3 === 'null' ? '' : oldC3);

            if(newName) {
                try {
                    await fetch(`/api/products/files/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            filename: newName, 
                            category1: newC1 || '-', 
                            category2: newC2 || '-', 
                            category3: newC3 || '-' 
                        })
                    });
                    loadCsvList();
                } catch(e) { alert('å¤‰æ›´å¤±æ•—'); }
            }
        }

        async function delCsv(id) {
            if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n(ã“ã®CSVã‹ã‚‰ç™»éŒ²ã•ã‚ŒãŸå•†å“æƒ…å ±ã‚‚æ¶ˆãˆã¾ã™)')) return;
            await fetch(`/api/products/files/${id}`, {method:'DELETE'});
            loadCsvList(); loadStats();
        }
    </script>
</body>
</html>