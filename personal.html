<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‹äººç”¨ã‚¢ãƒ«ãƒãƒ </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <style>
        body { font-family: sans-serif; padding: 10px; margin: 0; background: #fffaf0; color: #333; }
        #nav-bar { padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; background: #fff; }
        a { color: #007bff; text-decoration: none; }
        
        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ«å¼·åŒ– */
        .upload-area { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 20px auto; max-width: 600px; }
        
        .mode-switch { display: flex; gap: 15px; margin-bottom: 15px; }
        .mode-switch label { cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: bold; }
        
        input[type="text"], select { padding: 10px; width: 100%; box-sizing: border-box; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        
        button { padding: 12px; width: 100%; background: #28a745; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
        button:hover { background: #218838; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        #dropZone { border: 2px dashed #ffc107; padding: 30px; text-align: center; background: #fffbea; cursor: pointer; margin-bottom: 15px; border-radius: 8px; transition: background 0.2s; }
        #dropZone:hover { background: #fff3cd; }
        
        /* ã‚¢ãƒ«ãƒãƒ ãƒªã‚¹ãƒˆ */
        #album-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 20px; }
        .album-folder { 
            position: relative; background: #fff; border: 1px solid #ddd; padding: 10px; 
            text-align: center; cursor: pointer; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .album-folder:hover { background: #f0f0f0; border-color: #aaa; }
        .btn-icon { position: absolute; top: 5px; width: 24px; height: 24px; border-radius: 50%; font-size: 12px; line-height: 24px; text-align: center; cursor: pointer; padding: 0; border: none; color: white; z-index: 2; }
        .delete-btn { right: 5px; background: #dc3545; }
        .download-btn { right: 35px; background: #007bff; }

        /* å†™çœŸãƒªã‚¹ãƒˆ */
        #photo-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 5px; margin-top: 20px; }
        .photo-item { overflow: hidden; border-radius: 4px; background: #fff; border: 1px solid #ddd; position: relative; }
        .photo-item img { width: 100%; aspect-ratio: 1/1; object-fit: cover; display: block; }
        
        .pdf-icon { 
            width: 100%; aspect-ratio: 1/1; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; background: #ffecec; color: #d32f2f; 
            font-weight: bold; font-size: 0.8em; text-decoration: none;
        }
    </style>
</head>
<body>
    <div id="nav-bar">
        <span>ğŸ”’ å€‹äººç”¨ã‚¢ãƒ«ãƒãƒ </span>
        <a href="/">ã‚·ãƒ§ãƒƒãƒ—ç®¡ç†ã¸æˆ»ã‚‹</a>
    </div>

    <div class="upload-area">
        <h3 style="margin-top:0;">ã‚¢ãƒ«ãƒãƒ ä½œæˆãƒ»è¿½åŠ </h3>
        
        <div class="mode-switch">
            <label><input type="radio" name="albumMode" value="new" checked onclick="toggleMode()"> âœ¨ æ–°è¦ä½œæˆ</label>
            <label><input type="radio" name="albumMode" value="existing" onclick="toggleMode()"> ğŸ“‚ æ—¢å­˜ã«è¿½åŠ </label>
        </div>

        <div id="newAlbumInput">
            <input type="text" id="albumName" placeholder="æ–°ã—ã„ã‚¢ãƒ«ãƒãƒ å (ä¾‹: äº¬éƒ½æ—…è¡Œ2025)">
        </div>

        <div id="existingAlbumInput" style="display:none;">
            <select id="existingAlbumSelect">
                <option value="">ã‚¢ãƒ«ãƒãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
        </div>
        
        <div id="dropZone" onclick="document.getElementById('fileInput').click()">
            <div>ğŸ“¸ å†™çœŸ/PDFã‚’é¸æŠ</div>
            <div style="font-size:0.8em; color:#666; margin-top:5px;">ã‚¹ãƒãƒ›å†™çœŸã¯è‡ªå‹•åœ§ç¸®ã•ã‚Œ<br>é«˜é€Ÿã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ ğŸš€</div>
            <input type="file" id="fileInput" multiple accept="image/*,.pdf" style="display:none">
            <div id="fileInfo" style="margin-top:8px; font-weight:bold; color:#d35400;">æœªé¸æŠ</div>
        </div>

        <button id="uploadBtn">ä¿å­˜ã™ã‚‹</button>
        <p id="status" style="text-align:center; font-weight:bold; height:1.2em;"></p>
    </div>

    <hr>
    <div style="padding: 10px;">
        <h3 style="margin-bottom:10px;">ã‚¢ãƒ«ãƒãƒ ä¸€è¦§</h3>
        <div id="album-list"></div>
        
        <h3 id="current-album-title" style="margin-top:30px; display:none; border-bottom:2px solid #ffc107; padding-bottom:5px;"></h3>
        <div id="photo-list"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js"></script>
    <script>
        const CAT1 = "Private";
        const CAT2 = "Album";
        const CAT3 = "Photo";
        let currentAlbum = null;
        let lightbox;
        let allAlbums = []; // ã‚¢ãƒ«ãƒãƒ åãƒªã‚¹ãƒˆä¿æŒç”¨

        document.addEventListener('DOMContentLoaded', loadAlbums);

        function toggleMode() {
            const mode = document.querySelector('input[name="albumMode"]:checked').value;
            if(mode === 'new') {
                document.getElementById('newAlbumInput').style.display = 'block';
                document.getElementById('existingAlbumInput').style.display = 'none';
            } else {
                document.getElementById('newAlbumInput').style.display = 'none';
                document.getElementById('existingAlbumInput').style.display = 'block';
                updateSelectOptions(); // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æ›´æ–°
            }
        }

        function updateSelectOptions() {
            const sel = document.getElementById('existingAlbumSelect');
            sel.innerHTML = '<option value="">ã‚¢ãƒ«ãƒãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            allAlbums.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.innerText = name;
                sel.appendChild(opt);
            });
        }

        async function loadAlbums() {
            const div = document.getElementById('album-list');
            div.innerHTML = 'Loading...';
            try {
                const r = await fetch(`/api/folders/${CAT1}/${CAT2}/${CAT3}`);
                if(r.status === 401) return window.location.href = '/login';
                const data = await r.json();
                
                div.innerHTML = '';
                allAlbums = []; // ãƒªã‚»ãƒƒãƒˆ

                if(data.length === 0) div.innerHTML = '<p>ã‚¢ãƒ«ãƒãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                
                data.forEach(folder => {
                    allAlbums.push(folder.name); // åå‰ã‚’ä¿å­˜
                    
                    const el = document.createElement('div');
                    el.className = 'album-folder';
                    const label = document.createElement('div');
                    label.innerHTML = `ğŸ“<br><b>${folder.name}</b><br><small>(${folder.count}æš)</small>`;
                    label.onclick = () => loadPhotos(folder.name);
                    
                    const dlBtn = document.createElement('button');
                    dlBtn.className = 'btn-icon download-btn'; dlBtn.innerText = 'â¬‡ï¸';
                    dlBtn.title = 'ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
                    dlBtn.onclick = (e) => { e.stopPropagation(); window.location.href = `/api/personal/download/${encodeURIComponent(folder.name)}`; };

                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn-icon delete-btn'; delBtn.innerText = 'Ã—';
                    delBtn.title = 'ã‚¢ãƒ«ãƒãƒ å‰Šé™¤';
                    delBtn.onclick = (e) => { e.stopPropagation(); deleteAlbum(folder.name); };

                    el.appendChild(dlBtn); el.appendChild(delBtn); el.appendChild(label);
                    div.appendChild(el);
                });
                
                // ã‚‚ã—ã€Œæ—¢å­˜ã«è¿½åŠ ã€ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                if(document.querySelector('input[name="albumMode"]:checked').value === 'existing') {
                    updateSelectOptions();
                }

            } catch(e) { div.innerHTML = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'; }
        }

        async function deleteAlbum(folderName) {
            if (!confirm(`ã‚¢ãƒ«ãƒãƒ ã€Œ${folderName}ã€å†…ã®å†™çœŸã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            try {
                const r = await fetch(`/api/personal/album/${encodeURIComponent(folderName)}`, { method: 'DELETE' });
                if (r.ok) { alert('å‰Šé™¤ã—ã¾ã—ãŸ'); loadAlbums(); if(currentAlbum===folderName){ document.getElementById('photo-list').innerHTML=''; document.getElementById('current-album-title').style.display='none'; } } 
                else { alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
            } catch (e) { alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
        }

        async function loadPhotos(folder) {
            currentAlbum = folder;
            const titleEl = document.getElementById('current-album-title');
            const listEl = document.getElementById('photo-list');
            titleEl.style.display = 'block'; titleEl.innerText = `ğŸ“‚ ${folder}`; listEl.innerHTML = 'Loading...';
            
            const params = new URLSearchParams({ cat1: CAT1, cat2: CAT2, cat3: CAT3, folder: folder });
            const r = await fetch(`/api/search?${params}`);
            const data = await r.json();
            listEl.innerHTML = '';
            
            if(data.length === 0) listEl.innerHTML = '<p>å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</p>';

            data.forEach(img => {
                const name = img.title.split('/').pop();
                const div = document.createElement('div'); div.className = 'photo-item';
                if (img.url.toLowerCase().endsWith('.pdf')) {
                    div.innerHTML = `<a href="${img.url}" target="_blank" class="pdf-icon">ğŸ“„ PDF<br><span style="font-size:0.7em">${name}</span></a>`;
                } else {
                    div.innerHTML = `<a href="${img.url}" class="lightbox-link"><img src="${img.url}"></a>`;
                }
                listEl.appendChild(div);
            });
            
            if(lightbox) lightbox.destroy();
            lightbox = new SimpleLightbox('#photo-list .lightbox-link');
            titleEl.scrollIntoView({behavior: "smooth"});
        }

        const fileInput = document.getElementById('fileInput');
        fileInput.onchange = () => document.getElementById('fileInfo').innerText = `${fileInput.files.length}æš é¸æŠä¸­`;

        // ç”»åƒåœ§ç¸®é–¢æ•° (Promiseãƒ©ãƒƒãƒ‘ãƒ¼)
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                // PDFãªã©ã¯åœ§ç¸®ã›ãšãã®ã¾ã¾è¿”ã™
                if (!file.type.startsWith('image/')) {
                    return resolve(file);
                }
                new Compressor(file, {
                    quality: 0.6, // ç”»è³ª60% (ååˆ†ç¶ºéº—)
                    maxWidth: 1920, // å¹…æœ€å¤§1920px
                    maxHeight: 1920, 
                    success(result) { resolve(result); },
                    error(err) { console.error(err); resolve(file); } // å¤±æ•—æ™‚ã¯å…ƒãƒ•ã‚¡ã‚¤ãƒ«
                });
            });
        };

        document.getElementById('uploadBtn').onclick = async () => {
            const mode = document.querySelector('input[name="albumMode"]:checked').value;
            let album = '';
            
            if(mode === 'new') {
                album = document.getElementById('albumName').value.trim();
                if(!album) return alert('ã‚¢ãƒ«ãƒãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            } else {
                album = document.getElementById('existingAlbumSelect').value;
                if(!album) return alert('è¿½åŠ å…ˆã®ã‚¢ãƒ«ãƒãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„');
            }

            if(fileInput.files.length === 0) return alert('å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„');

            const btn = document.getElementById('uploadBtn');
            const stat = document.getElementById('status');
            btn.disabled = true;
            stat.innerText = 'åœ§ç¸®ï¼†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­... ğŸš€';
            stat.style.color = '#e67e22';

            try {
                const fd = new FormData();
                fd.append('category1', CAT1); fd.append('category2', CAT2); fd.append('category3', CAT3);
                fd.append('folderName', album);

                // å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¦åˆ—ã§åœ§ç¸®å‡¦ç†
                const compressPromises = Array.from(fileInput.files).map(file => compressImage(file));
                const processedFiles = await Promise.all(compressPromises);

                for(let f of processedFiles) {
                    // Blobã®å ´åˆã€å…ƒã®åå‰ãŒå¤±ã‚ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ç¬¬3å¼•æ•°ã§æŒ‡å®š
                    fd.append('imageFiles', f, f.name); 
                }

                const r = await fetch('/upload', { method: 'POST', body: fd });
                if(!r.ok) throw new Error('å¤±æ•—');
                
                stat.innerText = 'ä¿å­˜ã—ã¾ã—ãŸï¼âœ¨';
                stat.style.color = 'green';
                
                fileInput.value = ''; 
                document.getElementById('fileInfo').innerText = 'æœªé¸æŠ';
                document.getElementById('albumName').value = ''; // å…¥åŠ›ã‚¯ãƒªã‚¢
                
                loadAlbums(); // ãƒªã‚¹ãƒˆæ›´æ–°
                
                // ã‚‚ã—ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚¢ãƒ«ãƒãƒ ã«è¿½åŠ ã—ãŸå ´åˆã¯ã€å†™çœŸãƒªã‚¹ãƒˆã‚‚æ›´æ–°
                if(currentAlbum === album) {
                    loadPhotos(album);
                }

            } catch(e) { 
                stat.innerText = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'; 
                stat.style.color = 'red';
            } finally {
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>