<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‹äººç”¨ã‚¢ãƒ«ãƒãƒ </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <style>
        body { font-family: sans-serif; padding: 10px; margin: 0; background: #fffaf0; }
        #nav-bar { padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; background: #fff; }
        a { color: #007bff; text-decoration: none; }
        input { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        button { padding: 10px; width: 100%; background: #28a745; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        #dropZone { border: 2px dashed #ccc; padding: 30px; text-align: center; background: #fff; cursor: pointer; margin-bottom: 10px; }
        
        #album-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 20px; }
        .album-folder { 
            position: relative; background: #fff; border: 1px solid #ddd; padding: 10px; 
            text-align: center; cursor: pointer; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .album-folder:hover { background: #f0f0f0; }
        .btn-icon { position: absolute; top: 5px; width: 24px; height: 24px; border-radius: 50%; font-size: 12px; line-height: 24px; text-align: center; cursor: pointer; padding: 0; border: none; color: white; }
        .delete-btn { right: 5px; background: #dc3545; }
        .download-btn { right: 35px; background: #007bff; }

        #photo-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 5px; margin-top: 20px; }
        .photo-item { overflow: hidden; border-radius: 4px; background: #fff; border: 1px solid #ddd; }
        .photo-item img { width: 100%; aspect-ratio: 1/1; object-fit: cover; display: block; }
        
        /* PDFã‚¢ã‚¤ã‚³ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .pdf-icon { 
            width: 100%; aspect-ratio: 1/1; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; background: #ffecec; color: #d32f2f; 
            font-weight: bold; font-size: 0.8em; text-decoration: none;
        }
    </style>
</head>
<body>
    <div id="nav-bar">
        <span>ğŸ”’ å€‹äººç”¨ã‚¢ãƒ«ãƒãƒ </span>
        <a href="/">ã‚·ãƒ§ãƒƒãƒ—ç®¡ç†ã¸æˆ»ã‚‹</a>
    </div>

    <div style="padding: 20px; max-width: 600px; margin: 0 auto;">
        <h3>ã‚¢ãƒ«ãƒãƒ ä½œæˆãƒ»è¿½åŠ </h3>
        <label>ã‚¢ãƒ«ãƒãƒ å (ãƒ•ã‚©ãƒ«ãƒ€å):</label>
        <input type="text" id="albumName" placeholder="ä¾‹: äº¬éƒ½æ—…è¡Œ2025">
        
        <div id="dropZone" onclick="document.getElementById('fileInput').click()">
            å†™çœŸ/PDFã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ<br>
            <span id="fileInfo" style="font-size:0.8em; color:#888;">æœªé¸æŠ</span>
            <input type="file" id="fileInput" multiple accept="image/*,.pdf" style="display:none">
        </div>
        <button id="uploadBtn">ä¿å­˜ã™ã‚‹</button>
        <p id="status"></p>
    </div>

    <hr>
    <h3 style="padding-left: 10px;">ã‚¢ãƒ«ãƒãƒ ä¸€è¦§</h3>
    <div id="album-list" style="padding: 10px;"></div>
    <h3 id="current-album-title" style="padding-left: 10px; display:none;"></h3>
    <div id="photo-list" style="padding: 10px;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js"></script>
    <script>
        const CAT1 = "Private";
        const CAT2 = "Album";
        const CAT3 = "Photo";
        let currentAlbum = null;
        let lightbox;

        document.addEventListener('DOMContentLoaded', loadAlbums);

        async function loadAlbums() {
            const div = document.getElementById('album-list');
            div.innerHTML = 'Loading...';
            try {
                const r = await fetch(`/api/folders/${CAT1}/${CAT2}/${CAT3}`);
                if(r.status === 401) return window.location.href = '/login';
                const data = await r.json();
                div.innerHTML = '';
                if(data.length === 0) div.innerHTML = '<p>ã‚¢ãƒ«ãƒãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                
                data.forEach(folder => {
                    const el = document.createElement('div');
                    el.className = 'album-folder';
                    const label = document.createElement('div');
                    label.innerHTML = `ğŸ“<br><b>${folder}</b>`;
                    label.onclick = () => loadPhotos(folder);
                    
                    const dlBtn = document.createElement('button');
                    dlBtn.className = 'btn-icon download-btn'; dlBtn.innerText = 'â¬‡ï¸';
                    dlBtn.onclick = (e) => { e.stopPropagation(); window.location.href = `/api/personal/download/${encodeURIComponent(folder)}`; };

                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn-icon delete-btn'; delBtn.innerText = 'Ã—';
                    delBtn.onclick = (e) => { e.stopPropagation(); deleteAlbum(folder); };

                    el.appendChild(dlBtn); el.appendChild(delBtn); el.appendChild(label);
                    div.appendChild(el);
                });
            } catch(e) { div.innerHTML = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'; }
        }

        async function deleteAlbum(folderName) {
            if (!confirm(`ã‚¢ãƒ«ãƒãƒ ã€Œ${folderName}ã€å†…ã®å†™çœŸã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            try {
                const r = await fetch(`/api/personal/album/${encodeURIComponent(folderName)}`, { method: 'DELETE' });
                if (r.ok) { alert('å‰Šé™¤ã—ã¾ã—ãŸ'); loadAlbums(); if(currentAlbum===folderName){ document.getElementById('photo-list').innerHTML=''; document.getElementById('current-album-title').style.display='none'; } } 
                else { alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
            } catch (e) { alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
        }

        async function loadPhotos(folder) {
            currentAlbum = folder;
            const titleEl = document.getElementById('current-album-title');
            const listEl = document.getElementById('photo-list');
            titleEl.style.display = 'block'; titleEl.innerText = `ğŸ“‚ ${folder}`; listEl.innerHTML = 'Loading...';
            
            const params = new URLSearchParams({ cat1: CAT1, cat2: CAT2, cat3: CAT3, folder: folder });
            const r = await fetch(`/api/search?${params}`);
            const data = await r.json();
            listEl.innerHTML = '';
            
            data.forEach(img => {
                const name = img.title.split('/').pop();
                const div = document.createElement('div'); div.className = 'photo-item';
                
                // â˜…ä¿®æ­£: PDFåˆ¤å®š
                if (img.url.toLowerCase().endsWith('.pdf')) {
                    div.innerHTML = `<a href="${img.url}" target="_blank" class="pdf-icon">ğŸ“„ PDF<br>${name}</a>`;
                } else {
                    div.innerHTML = `<a href="${img.url}" class="lightbox-link"><img src="${img.url}"></a>`;
                }
                listEl.appendChild(div);
            });
            
            if(lightbox) lightbox.destroy();
            // â˜…ä¿®æ­£: Lightboxã¯ç”»åƒã®ã¿
            lightbox = new SimpleLightbox('#photo-list .lightbox-link');
            titleEl.scrollIntoView({behavior: "smooth"});
        }

        const fileInput = document.getElementById('fileInput');
        fileInput.onchange = () => document.getElementById('fileInfo').innerText = `${fileInput.files.length}æš é¸æŠä¸­`;

        document.getElementById('uploadBtn').onclick = async () => {
            const album = document.getElementById('albumName').value.trim();
            if(!album) return alert('ã‚¢ãƒ«ãƒãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            if(fileInput.files.length === 0) return alert('å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„');

            const fd = new FormData();
            fd.append('category1', CAT1); fd.append('category2', CAT2); fd.append('category3', CAT3);
            fd.append('folderName', album);
            for(let f of fileInput.files) fd.append('imageFiles', f);

            const stat = document.getElementById('status'); stat.innerText = 'ä¿å­˜ä¸­...';
            try {
                const r = await fetch('/upload', { method: 'POST', body: fd });
                if(!r.ok) throw new Error('å¤±æ•—');
                stat.innerText = 'ä¿å­˜ã—ã¾ã—ãŸï¼';
                fileInput.value = ''; document.getElementById('fileInfo').innerText = 'æœªé¸æŠ';
                loadAlbums();
            } catch(e) { stat.innerText = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'; }
        };
    </script>
</body>
</html>