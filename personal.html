<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‹äººç”¨ã‚¢ãƒ«ãƒãƒ </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <style>
        body { font-family: sans-serif; padding: 10px; margin: 0; background: #fffaf0; color: #333; }
        #nav-bar { padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; background: #fff; }
        a { color: #007bff; text-decoration: none; }
        
        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .upload-area { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 20px auto; max-width: 600px; }
        
        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã‚¿ãƒ– */
        .mode-tabs { display: flex; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .mode-tabs label { font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; color: #555; }
        .mode-tabs input:checked + span { color: #28a745; text-decoration: underline; }

        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .col { flex: 1; }
        
        label { display: block; font-size: 0.85em; font-weight: bold; color: #166534; margin-bottom: 3px; }
        input[type="text"], select { padding: 10px; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; margin-bottom: 10px;}
        
        button { padding: 12px; width: 100%; background: #28a745; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
        button:hover { background: #218838; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        #dropZone { border: 2px dashed #ffc107; padding: 30px; text-align: center; background: #fffbea; cursor: pointer; margin-bottom: 15px; border-radius: 8px; transition: background 0.2s; }
        #dropZone:hover { background: #fff3cd; }
        
        /* ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ */
        #breadcrumbs { padding: 10px; font-size: 1.1em; color: #555; }
        .crumb { cursor: pointer; color: #007bff; text-decoration: underline; }
        .crumb.active { color: #333; text-decoration: none; cursor: default; font-weight: bold; }

        /* ãƒªã‚¹ãƒˆè¡¨ç¤º */
        #content-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 10px; }
        
        .folder-item { 
            position: relative; background: #fff; border: 1px solid #ddd; padding: 10px; 
            text-align: center; cursor: pointer; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: background 0.1s;
        }
        .folder-item:hover { background: #f0f0f0; border-color: #aaa; }
        .folder-icon { font-size: 2em; display: block; margin-bottom: 5px; }
        
        /* ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ */
        .item-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; }
        .action-btn { 
            width: 24px; height: 24px; border-radius: 50%; font-size: 12px; line-height: 24px; 
            text-align: center; cursor: pointer; padding: 0; border: none; color: white; z-index: 2; 
        }
        .edit-btn { background: #f0ad4e; }
        .del-btn { background: #d9534f; }

        /* å†™çœŸãƒ»å‹•ç”»ã‚¢ã‚¤ãƒ†ãƒ  */
        .media-item { overflow: hidden; border-radius: 4px; background: #fff; border: 1px solid #ddd; position: relative; aspect-ratio: 1/1; }
        .media-item img, .media-item video { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        .video-badge {
            position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: #fff;
            padding: 2px 6px; border-radius: 4px; font-size: 0.7em; pointer-events: none;
        }
        
        /* PDFã‚¢ã‚¤ã‚³ãƒ³ */
        .pdf-icon { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #ffecec; color: #d32f2f; font-weight: bold; font-size: 0.8em; text-decoration: none; }
    </style>
</head>
<body>
    <div id="nav-bar">
        <span>ğŸ”’ å€‹äººç”¨ã‚¢ãƒ«ãƒãƒ </span>
        <a href="/">ã‚·ãƒ§ãƒƒãƒ—ç®¡ç†ã¸æˆ»ã‚‹</a>
    </div>

    <div class="upload-area">
        <h3 style="margin-top:0;">ã‚¢ãƒ«ãƒãƒ ä½œæˆãƒ»è¿½åŠ </h3>
        
        <div class="mode-tabs">
            <label><input type="radio" name="upMode" value="new" checked onchange="toggleUploadMode()"> <span>âœ¨ æ–°è¦ / è‡ªå‹•åˆ†æ</span></label>
            <label><input type="radio" name="upMode" value="existing" onchange="toggleUploadMode()"> <span>ğŸ“‚ æ—¢å­˜ã«è¿½åŠ </span></label>
        </div>

        <div id="mode-new-container">
            <div class="row">
                <div class="col" style="flex: 0 0 80px;">
                    <label>å¹´ (è‡ªå‹•)</label>
                    <select id="uploadYear"></select>
                </div>
                <div class="col" style="flex: 0 0 60px;">
                    <label>æœˆ (è‡ªå‹•)</label>
                    <select id="uploadMonth"></select>
                </div>
                <div class="col">
                    <label>ã‚¢ãƒ«ãƒãƒ å (ä¾‹: 2025-05 æ—…è¡Œ)</label>
                    <input type="text" id="albumName" placeholder="æ—¥ä»˜ã‚’å…¥ã‚Œã‚‹ã¨è‡ªå‹•ã§å¹´æœˆã«æŒ¯ã‚Šåˆ†ã‘ã¾ã™">
                </div>
            </div>
        </div>

        <div id="mode-existing-container" style="display:none;">
            <div class="row">
                <div class="col">
                    <label>1. å¹´ã‚’é¸æŠ</label>
                    <select id="selExistYear"><option value="">-- å¹´ --</option></select>
                </div>
                <div class="col">
                    <label>2. æœˆã‚’é¸æŠ</label>
                    <select id="selExistMonth" disabled><option value="">-- æœˆ --</option></select>
                </div>
            </div>
            <div style="margin-bottom:10px;">
                <label>3. ã‚¢ãƒ«ãƒãƒ ã‚’é¸æŠ</label>
                <select id="selExistAlbum" disabled><option value="">-- ã‚¢ãƒ«ãƒãƒ  --</option></select>
            </div>
        </div>
        
        <div id="dropZone" onclick="document.getElementById('fileInput').click()">
            <div>ğŸ“¸ å†™çœŸ / ğŸ¥ å‹•ç”» / ğŸ“„ PDF</div>
            <input type="file" id="fileInput" multiple accept="image/*,video/*,.pdf" style="display:none">
            <div id="fileInfo" style="margin-top:8px; font-weight:bold; color:#d35400;">æœªé¸æŠ</div>
        </div>

        <button id="uploadBtn">ä¿å­˜ã™ã‚‹</button>
        <p id="status" style="text-align:center; font-weight:bold; height:1.2em;"></p>
    </div>

    <hr>
    
    <div id="breadcrumbs"></div>
    <div id="content-list" style="padding: 10px;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js"></script>
    
    <script>
        const CAT1 = "Private";
        
        // çŠ¶æ…‹ç®¡ç†
        const state = {
            view: 'root', // root(å¹´) -> year(æœˆ) -> month(ã‚¢ãƒ«ãƒãƒ ) -> album(ãƒ•ã‚¡ã‚¤ãƒ«)
            year: null,
            month: null,
            album: null
        };

        let lightbox;

        document.addEventListener('DOMContentLoaded', () => {
            initDateSelects(); // æ–°è¦ç”¨ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
            renderView();      // ã‚®ãƒ£ãƒ©ãƒªãƒ¼è¡¨ç¤º
            loadExistingYears(); // æ—¢å­˜è¿½åŠ ç”¨ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
        });

        // --- UIåˆ‡ã‚Šæ›¿ãˆ ---
        function toggleUploadMode() {
            const isNew = document.querySelector('input[name="upMode"]:checked').value === 'new';
            document.getElementById('mode-new-container').style.display = isNew ? 'block' : 'none';
            document.getElementById('mode-existing-container').style.display = isNew ? 'none' : 'block';
        }

        // --- 1. æ–°è¦ç”¨: æ—¥ä»˜é¸æŠãƒ»è‡ªå‹•åˆ†æãƒ­ã‚¸ãƒƒã‚¯ ---
        function initDateSelects() {
            const yearSel = document.getElementById('uploadYear');
            const monthSel = document.getElementById('uploadMonth');
            const currentYear = new Date().getFullYear();
            
            for(let y = currentYear - 2; y <= currentYear + 3; y++) {
                const opt = document.createElement('option'); opt.value = y; opt.innerText = y + "å¹´";
                if(y === currentYear) opt.selected = true;
                yearSel.appendChild(opt);
            }
            for(let m = 1; m <= 12; m++) {
                const val = m.toString().padStart(2, '0');
                const opt = document.createElement('option'); opt.value = val; opt.innerText = val + "æœˆ";
                if(m === new Date().getMonth() + 1) opt.selected = true;
                monthSel.appendChild(opt);
            }

            document.getElementById('albumName').addEventListener('input', (e) => {
                const val = e.target.value;
                const matchYear = val.match(/20\d{2}/);
                if (matchYear) yearSel.value = matchYear[0];
                const matchDate = val.match(/(\d{4})[-/](\d{1,2})/);
                if (matchDate) {
                    yearSel.value = matchDate[1];
                    monthSel.value = matchDate[2].padStart(2, '0');
                }
            });
        }

        // --- 2. æ—¢å­˜è¿½åŠ ç”¨: é€£å‹•ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ ---
        async function loadExistingYears() {
            const sel = document.getElementById('selExistYear');
            sel.innerHTML = '<option value="">-- å¹´ --</option>';
            try {
                const r = await fetch(`/api/cat2/${CAT1}?type=all`);
                const data = await r.json();
                data.forEach(d => {
                    if(d.name !== 'default_cat2' && d.name !== '-') {
                        const opt = document.createElement('option'); opt.value = d.name; opt.innerText = d.name + "å¹´";
                        sel.appendChild(opt);
                    }
                });
            } catch(e) {}
        }

        document.getElementById('selExistYear').onchange = async (e) => {
            const y = e.target.value;
            const mSel = document.getElementById('selExistMonth');
            const aSel = document.getElementById('selExistAlbum');
            mSel.innerHTML = '<option>Loading...</option>'; mSel.disabled = true;
            aSel.innerHTML = '<option>-- ã‚¢ãƒ«ãƒãƒ  --</option>'; aSel.disabled = true;
            
            if(!y) return;
            try {
                const r = await fetch(`/api/cat3/${CAT1}/${y}?type=all`);
                const data = await r.json();
                mSel.innerHTML = '<option value="">-- æœˆ --</option>';
                data.forEach(d => {
                    if(d.name !== 'default_cat3' && d.name !== '-') {
                        const opt = document.createElement('option'); opt.value = d.name; opt.innerText = d.name + "æœˆ";
                        mSel.appendChild(opt);
                    }
                });
                mSel.disabled = false;
            } catch(e){ mSel.innerHTML='<option>Error</option>'; }
        };

        document.getElementById('selExistMonth').onchange = async (e) => {
            const m = e.target.value;
            const y = document.getElementById('selExistYear').value;
            const aSel = document.getElementById('selExistAlbum');
            aSel.innerHTML = '<option>Loading...</option>'; aSel.disabled = true;
            
            if(!m) return;
            try {
                const r = await fetch(`/api/folders/${CAT1}/${y}/${m}`);
                const data = await r.json();
                aSel.innerHTML = '<option value="">-- ã‚¢ãƒ«ãƒãƒ  --</option>';
                data.forEach(d => {
                    const opt = document.createElement('option'); opt.value = d.name; opt.innerText = `${d.name} (${d.count})`;
                    aSel.appendChild(opt);
                });
                aSel.disabled = false;
            } catch(e){ aSel.innerHTML='<option>Error</option>'; }
        };

        // --- 3. éšå±¤ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ & ç·¨é›†å‰Šé™¤æ©Ÿèƒ½ ---
        async function renderView() {
            const list = document.getElementById('content-list');
            const crumbs = document.getElementById('breadcrumbs');
            list.innerHTML = 'Loading...';
            
            let html = `<span class="crumb" onclick="navigate('root')">ğŸ  Home</span>`;
            if (state.year) html += ` > <span class="crumb" onclick="navigate('year', '${state.year}')">${state.year}å¹´</span>`;
            if (state.month) html += ` > <span class="crumb" onclick="navigate('month', '${state.year}', '${state.month}')">${state.month}æœˆ</span>`;
            if (state.album) html += ` > <span class="crumb active">${state.album}</span>`;
            crumbs.innerHTML = html;

            try {
                if (state.view === 'root') {
                    const r = await fetch(`/api/cat2/${CAT1}?type=all`);
                    const data = await r.json();
                    list.innerHTML = '';
                    if (data.length === 0) list.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    // Homeç”»é¢ (å¹´ä¸€è¦§) ã«ã‚‚ç·¨é›†ãƒ»å‰Šé™¤ã‚’è¿½åŠ 
                    data.forEach(d => {
                        if(d.name==='default_cat2' || d.name==='-') return;
                        createFolderItem(d.name + "å¹´", () => navigate('year', d.name), d.count, 2, d.name);
                    });

                } else if (state.view === 'year') {
                    const r = await fetch(`/api/cat3/${CAT1}/${state.year}?type=all`);
                    const data = await r.json();
                    list.innerHTML = '';
                    data.forEach(d => {
                        if(d.name==='default_cat3' || d.name==='-') return;
                        createFolderItem(d.name + "æœˆ", () => navigate('month', state.year, d.name), d.count, 3, d.name);
                    });

                } else if (state.view === 'month') {
                    const r = await fetch(`/api/folders/${CAT1}/${state.year}/${state.month}`);
                    const data = await r.json();
                    list.innerHTML = '';
                    data.forEach(d => {
                        createFolderItem(d.name, () => navigate('album', state.year, state.month, d.name), d.count, 4, d.name);
                    });

                } else if (state.view === 'album') {
                    // å†™çœŸãƒ»å‹•ç”»ä¸€è¦§
                    const params = new URLSearchParams({ cat1: CAT1, cat2: state.year, cat3: state.month, folder: state.album });
                    const r = await fetch(`/api/search?${params}`);
                    const data = await r.json();
                    list.innerHTML = '';
                    
                    data.forEach(file => {
                        const div = document.createElement('div'); div.className = 'media-item';
                        const ext = file.url.split('.').pop().toLowerCase();
                        const isVideo = ['mp4', 'mov', 'avi', 'webm'].includes(ext);
                        const isPdf = ['pdf'].includes(ext);

                        if (isVideo) {
                            div.innerHTML = `<a href="${file.url}" target="_blank"><video src="${file.url}#t=0.1" preload="metadata"></video><span class="video-badge">â–¶ Video</span></a>`;
                        } else if (isPdf) {
                            div.innerHTML = `<a href="${file.url}" target="_blank" class="pdf-icon">ğŸ“„ PDF<br><span style="font-size:0.7em">${file.title.split('/').pop()}</span></a>`;
                        } else {
                            div.innerHTML = `<a href="${file.url}" class="lightbox-link"><img src="${file.url}"></a>`;
                        }
                        list.appendChild(div);
                    });
                    
                    if(lightbox) lightbox.destroy();
                    lightbox = new SimpleLightbox('#content-list .lightbox-link');
                }
            } catch (e) { list.innerHTML = '<p style="color:red">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>'; }
        }

        function navigate(view, y=null, m=null, a=null) {
            state.view = view; state.year = y; state.month = m; state.album = a;
            renderView();
        }

        // ãƒ•ã‚©ãƒ«ãƒ€æç”» (ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ä»˜ã)
        function createFolderItem(label, onClick, count, level, rawName) {
            const div = document.createElement('div');
            div.className = 'folder-item';
            div.onclick = onClick;
            
            let btns = '';
            // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å‰Šé™¤ãƒ»ãƒªãƒãƒ¼ãƒ å‡¦ç†ã‚’å¤‰ãˆã‚‹
            btns = `
                <div class="item-actions">
                    <button class="action-btn edit-btn" onclick="event.stopPropagation(); renameItem(${level}, '${rawName}')">âœ</button>
                    <button class="action-btn del-btn" onclick="event.stopPropagation(); deleteItem(${level}, '${rawName}')">Ã—</button>
                </div>`;

            div.innerHTML = `${btns}<span class="folder-icon">ğŸ“‚</span><b>${label}</b><br><small>(${count} items)</small>`;
            document.getElementById('content-list').appendChild(div);
        }

        async function renameItem(level, oldName) {
            const newName = prompt(`ã€Œ${oldName}ã€ã®åå‰ã‚’å¤‰æ›´ã—ã¾ã™:`, oldName);
            if(!newName || newName === oldName) return;
            
            let url = '';
            // level: 2=å¹´(cat2), 3=æœˆ(cat3), 4=ã‚¢ãƒ«ãƒãƒ (folder)
            if(level===2) url = `/api/cat2/${CAT1}/${encodeURIComponent(oldName)}`;
            if(level===3) url = `/api/cat3/${CAT1}/${state.year}/${encodeURIComponent(oldName)}`;
            if(level===4) url = `/api/folder/${encodeURIComponent(oldName)}`; // ãƒ•ã‚©ãƒ«ãƒ€åã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯å‰æã®APIã«ãªã£ã¦ã„ã‚‹

            try {
                const r = await fetch(url, { method: 'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({newName: newName}) });
                if(r.ok) { alert('å¤‰æ›´ã—ã¾ã—ãŸ'); renderView(); loadExistingYears(); } 
                else alert('å¤‰æ›´ã§ãã¾ã›ã‚“ã§ã—ãŸ');
            } catch(e){ alert('ã‚¨ãƒ©ãƒ¼'); }
        }

        async function deleteItem(level, name) {
            if(!confirm(`ã€Œ${name}ã€ã¨ã€ãã®ä¸­èº«ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) return;
            
            let url = '';
            if(level===2) url = `/api/cat2/${CAT1}/${encodeURIComponent(name)}`;
            if(level===3) url = `/api/cat3/${CAT1}/${state.year}/${encodeURIComponent(name)}`;
            if(level===4) url = `/api/personal/album/${encodeURIComponent(name)}`;

            try {
                const r = await fetch(url, { method: 'DELETE' });
                if(r.ok) { alert('å‰Šé™¤ã—ã¾ã—ãŸ'); renderView(); loadExistingYears(); }
                else alert('å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸ');
            } catch(e){ alert('ã‚¨ãƒ©ãƒ¼'); }
        }

        // --- 4. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç† ---
        const fileInput = document.getElementById('fileInput');
        fileInput.onchange = () => document.getElementById('fileInfo').innerText = `${fileInput.files.length}ãƒ•ã‚¡ã‚¤ãƒ« é¸æŠä¸­`;

        const compressImage = (file) => {
            return new Promise((resolve) => {
                if (!file.type.startsWith('image/')) return resolve(file);
                new Compressor(file, { quality: 0.6, maxWidth: 1920, maxHeight: 1920, success(r){ resolve(r); }, error(){ resolve(file); } });
            });
        };

        document.getElementById('uploadBtn').onclick = async () => {
            const isNew = document.querySelector('input[name="upMode"]:checked').value === 'new';
            let year, month, album;

            if (isNew) {
                year = document.getElementById('uploadYear').value;
                month = document.getElementById('uploadMonth').value;
                album = document.getElementById('albumName').value.trim() || 'æœªåˆ†é¡';
            } else {
                year = document.getElementById('selExistYear').value;
                month = document.getElementById('selExistMonth').value;
                album = document.getElementById('selExistAlbum').value;
                if(!year || !month || !album) return alert('è¿½åŠ å…ˆã®ã‚¢ãƒ«ãƒãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„');
            }
            
            if (fileInput.files.length === 0) return alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');

            const btn = document.getElementById('uploadBtn');
            const stat = document.getElementById('status');
            btn.disabled = true;
            stat.innerText = 'å‡¦ç†ä¸­... ğŸš€';

            try {
                const fd = new FormData();
                fd.append('category1', CAT1);
                fd.append('category2', year);
                fd.append('category3', month);
                fd.append('folderName', album);

                const processedFiles = await Promise.all(Array.from(fileInput.files).map(f => compressImage(f)));
                processedFiles.forEach(f => fd.append('imageFiles', f, f.name));

                const r = await fetch('/upload', { method: 'POST', body: fd });
                if(!r.ok) throw new Error('å¤±æ•—');
                
                stat.innerText = 'å®Œäº†ï¼âœ¨';
                stat.style.color = 'green';
                fileInput.value = ''; 
                document.getElementById('fileInfo').innerText = 'æœªé¸æŠ';
                if(isNew) document.getElementById('albumName').value = '';
                
                if (state.year == year && state.month == month) renderView();
                else navigate('root'); // ä¸€è¦§æ›´æ–°ã®ãŸã‚ãƒ›ãƒ¼ãƒ ã¸

            } catch(e) { 
                stat.innerText = 'ã‚¨ãƒ©ãƒ¼'; stat.style.color = 'red'; 
            } finally {
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>