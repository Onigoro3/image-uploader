<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‹äººç”¨ã‚¢ãƒ«ãƒãƒ </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <style>
        body { font-family: sans-serif; padding: 10px; margin: 0; background: #fffaf0; color: #333; }
        #nav-bar { padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; background: #fff; }
        a { color: #007bff; text-decoration: none; }
        
        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .upload-area { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 20px auto; max-width: 600px; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .col { flex: 1; }
        
        label { display: block; font-size: 0.85em; font-weight: bold; color: #166534; margin-bottom: 3px; }
        input[type="text"], select { padding: 10px; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        
        button { padding: 12px; width: 100%; background: #28a745; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
        button:hover { background: #218838; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        #dropZone { border: 2px dashed #ffc107; padding: 30px; text-align: center; background: #fffbea; cursor: pointer; margin-bottom: 15px; border-radius: 8px; transition: background 0.2s; }
        #dropZone:hover { background: #fff3cd; }
        
        /* ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ */
        #breadcrumbs { padding: 10px; font-size: 1.1em; color: #555; }
        .crumb { cursor: pointer; color: #007bff; text-decoration: underline; }
        .crumb.active { color: #333; text-decoration: none; cursor: default; font-weight: bold; }

        /* ãƒªã‚¹ãƒˆè¡¨ç¤º */
        #content-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 10px; }
        
        .folder-item { 
            position: relative; background: #fff; border: 1px solid #ddd; padding: 10px; 
            text-align: center; cursor: pointer; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: background 0.1s;
        }
        .folder-item:hover { background: #f0f0f0; border-color: #aaa; }
        .folder-icon { font-size: 2em; display: block; margin-bottom: 5px; }
        
        /* å†™çœŸãƒ»å‹•ç”»ã‚¢ã‚¤ãƒ†ãƒ  */
        .media-item { overflow: hidden; border-radius: 4px; background: #fff; border: 1px solid #ddd; position: relative; aspect-ratio: 1/1; }
        .media-item img, .media-item video { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        .video-badge {
            position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: #fff;
            padding: 2px 6px; border-radius: 4px; font-size: 0.7em; pointer-events: none;
        }
        
        /* PDFã‚¢ã‚¤ã‚³ãƒ³ */
        .pdf-icon { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #ffecec; color: #d32f2f; font-weight: bold; font-size: 0.8em; text-decoration: none; }
    </style>
</head>
<body>
    <div id="nav-bar">
        <span>ğŸ”’ å€‹äººç”¨ã‚¢ãƒ«ãƒãƒ  (å‹•ç”»å¯¾å¿œç‰ˆ)</span>
        <a href="/">ã‚·ãƒ§ãƒƒãƒ—ç®¡ç†ã¸æˆ»ã‚‹</a>
    </div>

    <div class="upload-area">
        <h3 style="margin-top:0;">ã‚¢ãƒ«ãƒãƒ ä½œæˆãƒ»è¿½åŠ </h3>
        
        <div class="row">
            <div class="col" style="flex: 0 0 80px;">
                <label>å¹´ (è‡ªå‹•)</label>
                <select id="uploadYear"></select>
            </div>
            <div class="col" style="flex: 0 0 60px;">
                <label>æœˆ (è‡ªå‹•)</label>
                <select id="uploadMonth"></select>
            </div>
            <div class="col">
                <label>ã‚¢ãƒ«ãƒãƒ å (ä¾‹: æ—…è¡Œ)</label>
                <input type="text" id="albumName" placeholder="ä¾‹: 2025-05 GWæ—…è¡Œ">
            </div>
        </div>
        
        <div id="dropZone" onclick="document.getElementById('fileInput').click()">
            <div>ğŸ“¸ å†™çœŸ / ğŸ¥ å‹•ç”» / ğŸ“„ PDF</div>
            <div style="font-size:0.8em; color:#666; margin-top:5px;">ã‚¢ãƒ«ãƒãƒ åã®æ—¥ä»˜ã‚’è‡ªå‹•åˆ†æã—ã¦<br>ãƒ•ã‚©ãƒ«ãƒ€åˆ†ã‘ã—ã¾ã™ ğŸ“‚</div>
            <input type="file" id="fileInput" multiple accept="image/*,video/*,.pdf" style="display:none">
            <div id="fileInfo" style="margin-top:8px; font-weight:bold; color:#d35400;">æœªé¸æŠ</div>
        </div>

        <button id="uploadBtn">ä¿å­˜ã™ã‚‹</button>
        <p id="status" style="text-align:center; font-weight:bold; height:1.2em;"></p>
    </div>

    <hr>
    
    <div id="breadcrumbs"></div>
    <div id="content-list" style="padding: 10px;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js"></script>
    
    <script>
        const CAT1 = "Private";
        
        // çŠ¶æ…‹ç®¡ç†
        const state = {
            view: 'root', // root(å¹´ä¸€è¦§) -> year(æœˆä¸€è¦§) -> month(ã‚¢ãƒ«ãƒãƒ ä¸€è¦§) -> album(å†™çœŸä¸€è¦§)
            year: null,
            month: null,
            album: null
        };

        let lightbox;

        document.addEventListener('DOMContentLoaded', () => {
            initDateSelects();
            renderView();
        });

        // --- 1. æ—¥ä»˜é¸æŠãƒ»è‡ªå‹•åˆ†æãƒ­ã‚¸ãƒƒã‚¯ ---
        function initDateSelects() {
            const yearSel = document.getElementById('uploadYear');
            const monthSel = document.getElementById('uploadMonth');
            const currentYear = new Date().getFullYear();
            
            // å¹´: å‰å¾Œ5å¹´
            for(let y = currentYear - 2; y <= currentYear + 3; y++) {
                const opt = document.createElement('option');
                opt.value = y; opt.innerText = y + "å¹´";
                if(y === currentYear) opt.selected = true;
                yearSel.appendChild(opt);
            }
            // æœˆ: 01-12
            for(let m = 1; m <= 12; m++) {
                const val = m.toString().padStart(2, '0');
                const opt = document.createElement('option');
                opt.value = val; opt.innerText = val + "æœˆ";
                if(m === new Date().getMonth() + 1) opt.selected = true;
                monthSel.appendChild(opt);
            }

            // ã‚¢ãƒ«ãƒãƒ åå…¥åŠ›æ™‚ã®è‡ªå‹•åˆ†æ
            document.getElementById('albumName').addEventListener('input', (e) => {
                const val = e.target.value;
                // æ­£è¦è¡¨ç¾ã§å¹´(4æ¡)ã¨æœˆ(1-2æ¡)ã‚’æ¢ã™
                const matchYear = val.match(/20\d{2}/);
                const matchMonth = val.match(/(^|[^0-9])(0?[1-9]|1[0-2])($|[^0-9])/); // ç°¡æ˜“çš„ãªæœˆåˆ¤å®š

                if (matchYear) yearSel.value = matchYear[0];
                // æœˆã®åˆ¤å®šã¯é›£ã—ã„ï¼ˆ"202501"ã‚„"1æœˆ"ãªã©ï¼‰ãŒã€"-"ã‚„"/"åŒºåˆ‡ã‚Šã‚’å„ªå…ˆ
                const matchDate = val.match(/(\d{4})[-/](\d{1,2})/);
                if (matchDate) {
                    yearSel.value = matchDate[1];
                    monthSel.value = matchDate[2].padStart(2, '0');
                }
            });
        }

        // --- 2. éšå±¤ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ---
        async function renderView() {
            const list = document.getElementById('content-list');
            const crumbs = document.getElementById('breadcrumbs');
            list.innerHTML = 'Loading...';
            
            // ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆç”Ÿæˆ
            let html = `<span class="crumb" onclick="navigate('root')">ğŸ  Home</span>`;
            if (state.year) html += ` > <span class="crumb" onclick="navigate('year', '${state.year}')">${state.year}å¹´</span>`;
            if (state.month) html += ` > <span class="crumb" onclick="navigate('month', '${state.year}', '${state.month}')">${state.month}æœˆ</span>`;
            if (state.album) html += ` > <span class="crumb active">${state.album}</span>`;
            crumbs.innerHTML = html;

            try {
                if (state.view === 'root') {
                    // å¹´ä¸€è¦§ (Cat2)
                    const r = await fetch(`/api/cat2/${CAT1}?type=all`);
                    const data = await r.json();
                    list.innerHTML = '';
                    if (data.length === 0) list.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    data.forEach(d => createFolderItem(d.name + "å¹´", () => navigate('year', d.name), d.count));

                } else if (state.view === 'year') {
                    // æœˆä¸€è¦§ (Cat3)
                    const r = await fetch(`/api/cat3/${CAT1}/${state.year}?type=all`);
                    const data = await r.json();
                    list.innerHTML = '';
                    if (data.length === 0) list.innerHTML = '<p>ãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    data.forEach(d => createFolderItem(d.name + "æœˆ", () => navigate('month', state.year, d.name), d.count));

                } else if (state.view === 'month') {
                    // ã‚¢ãƒ«ãƒãƒ ä¸€è¦§ (Folder)
                    const r = await fetch(`/api/folders/${CAT1}/${state.year}/${state.month}`);
                    const data = await r.json();
                    list.innerHTML = '';
                    if (data.length === 0) list.innerHTML = '<p>ã‚¢ãƒ«ãƒãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    data.forEach(d => createFolderItem(d.name, () => navigate('album', state.year, state.month, d.name), d.count));

                } else if (state.view === 'album') {
                    // å†™çœŸãƒ»å‹•ç”»ä¸€è¦§ (Files)
                    const params = new URLSearchParams({ cat1: CAT1, cat2: state.year, cat3: state.month, folder: state.album });
                    const r = await fetch(`/api/search?${params}`);
                    const data = await r.json();
                    list.innerHTML = '';
                    
                    data.forEach(file => {
                        const div = document.createElement('div'); div.className = 'media-item';
                        const ext = file.url.split('.').pop().toLowerCase();
                        const isVideo = ['mp4', 'mov', 'avi', 'webm'].includes(ext);
                        const isPdf = ['pdf'].includes(ext);

                        if (isVideo) {
                            // å‹•ç”»: ã‚¯ãƒªãƒƒã‚¯ã§åˆ¥ã‚¿ãƒ–å†ç”Ÿ (SimpleLightboxã¯å‹•ç”»å¯¾å¿œãŒè¤‡é›‘ãªãŸã‚ç°¡æ˜“åŒ–)
                            div.innerHTML = `
                                <a href="${file.url}" target="_blank">
                                    <video src="${file.url}#t=0.1" preload="metadata"></video>
                                    <span class="video-badge">â–¶ Video</span>
                                </a>`;
                        } else if (isPdf) {
                            div.innerHTML = `<a href="${file.url}" target="_blank" class="pdf-icon">ğŸ“„ PDF<br><span style="font-size:0.7em">${file.title.split('/').pop()}</span></a>`;
                        } else {
                            // ç”»åƒ
                            div.innerHTML = `<a href="${file.url}" class="lightbox-link"><img src="${file.url}"></a>`;
                        }
                        list.appendChild(div);
                    });
                    
                    if(lightbox) lightbox.destroy();
                    lightbox = new SimpleLightbox('#content-list .lightbox-link');
                }
            } catch (e) {
                console.error(e);
                list.innerHTML = '<p style="color:red">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
            }
        }

        function navigate(view, y=null, m=null, a=null) {
            state.view = view;
            state.year = y;
            state.month = m;
            state.album = a;
            renderView();
        }

        function createFolderItem(label, onClick, count) {
            const div = document.createElement('div');
            div.className = 'folder-item';
            div.onclick = onClick;
            div.innerHTML = `<span class="folder-icon">ğŸ“‚</span><b>${label}</b><br><small>(${count} items)</small>`;
            document.getElementById('content-list').appendChild(div);
        }

        // --- 3. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç† (å‹•ç”»å¯¾å¿œ + åœ§ç¸®) ---
        const fileInput = document.getElementById('fileInput');
        fileInput.onchange = () => document.getElementById('fileInfo').innerText = `${fileInput.files.length}ãƒ•ã‚¡ã‚¤ãƒ« é¸æŠä¸­`;

        const compressImage = (file) => {
            return new Promise((resolve) => {
                // å‹•ç”»ã‚„PDFã¯åœ§ç¸®ã—ãªã„
                if (!file.type.startsWith('image/')) return resolve(file);
                
                new Compressor(file, {
                    quality: 0.6, maxWidth: 1920, maxHeight: 1920,
                    success(result) { resolve(result); },
                    error(err) { console.error(err); resolve(file); }
                });
            });
        };

        document.getElementById('uploadBtn').onclick = async () => {
            const year = document.getElementById('uploadYear').value;
            const month = document.getElementById('uploadMonth').value;
            const album = document.getElementById('albumName').value.trim() || 'æœªåˆ†é¡';
            
            if (fileInput.files.length === 0) return alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');

            const btn = document.getElementById('uploadBtn');
            const stat = document.getElementById('status');
            btn.disabled = true;
            stat.innerText = 'å‡¦ç†ä¸­... ğŸš€';

            try {
                const fd = new FormData();
                fd.append('category1', CAT1);
                fd.append('category2', year);  // å¹´
                fd.append('category3', month); // æœˆ
                fd.append('folderName', album); // ã‚¢ãƒ«ãƒãƒ å

                // ä¸¦åˆ—åœ§ç¸® (å‹•ç”»ã¯ã‚¹ãƒ«ãƒ¼)
                const processedFiles = await Promise.all(Array.from(fileInput.files).map(f => compressImage(f)));
                processedFiles.forEach(f => fd.append('imageFiles', f, f.name));

                const r = await fetch('/upload', { method: 'POST', body: fd });
                if(!r.ok) throw new Error('å¤±æ•—');
                
                stat.innerText = 'å®Œäº†ï¼âœ¨';
                stat.style.color = 'green';
                fileInput.value = ''; 
                document.getElementById('fileInfo').innerText = 'æœªé¸æŠ';
                document.getElementById('albumName').value = '';
                
                // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆã¨åŒã˜ãªã‚‰ãƒªãƒ­ãƒ¼ãƒ‰
                if (state.year == year && state.month == month) {
                    renderView();
                } else {
                    // é•ã†å ´æ‰€ãªã‚‰ãƒ«ãƒ¼ãƒˆã«æˆ»ã‚‹ï¼ˆæ›´æ–°ã‚’è¦‹ã›ã‚‹ãŸã‚ï¼‰
                    navigate('root');
                }

            } catch(e) { 
                stat.innerText = 'ã‚¨ãƒ©ãƒ¼'; stat.style.color = 'red'; 
            } finally {
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>